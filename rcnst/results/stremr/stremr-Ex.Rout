
R Under development (unstable) (2017-08-14 r73093) -- "Unsuffered Consequences"
Copyright (C) 2017 The R Foundation for Statistical Computing
Platform: x86_64-pc-linux-gnu (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> pkgname <- "stremr"
> source(file.path(R.home("share"), "R", "examples-header.R"))
> options(warn = 1)
> library('stremr')
> 
> base::assign(".oldSearch", base::search(), pos = 'CheckExEnv')
> cleanEx()
> nameEx("defineIntervedTRT")
> ### * defineIntervedTRT
> 
> flush(stderr()); flush(stdout())
> 
> ### Name: defineIntervedTRT
> ### Title: Define counterfactual dynamic treatment
> ### Aliases: defineIntervedTRT
> 
> ### ** Examples
> 
> 
> ## Not run: 
> ##D theta <- seq(7,8.5,by=0.5)
> ##D FOLLOW.D.DT <- defineIntervedTRT(data = data, theta = theta,
> ##D                  ID = "StudyID", t = "X_intnum", I = "X_a1c",
> ##D                  TRT = "X_exposure", CENS = "X_censor", MONITOR = "N.t",
> ##D                  new.TRT.names = paste0("gstar",theta))
> ## End(Not run)
> #-------------------------------------------------------------------
> # EXAMPLE BASED ON SIMULATED DATA
> #-------------------------------------------------------------------
> require("data.table")
Loading required package: data.table
> require("magrittr")
Loading required package: magrittr
> data(OdataCatCENS)
> OdataDT <- as.data.table(OdataCatCENS, key=c(ID, t))
> 
> #-------------------------------------------------------------------
> # Define the counterfactual dynamic treatment assignment
> #-------------------------------------------------------------------
> # Define two dynamic rules: dlow & dhigh
> OdataDT <- defineIntervedTRT(OdataDT, theta = c(0,1), ID = "ID", t = "t", I = "highA1c",
+                           CENS = "C", TRT = "TI", MONITOR = "N", tsinceNis1 = "lastNat1",
+                           new.TRT.names = c("dlow", "dhigh"), return.allcolumns = TRUE)
> 
> 
> 
> cleanEx()

detaching ‘package:magrittr’, ‘package:data.table’

> nameEx("fitIterTMLE")
> ### * fitIterTMLE
> 
> flush(stderr()); flush(stdout())
> 
> ### Name: fitIterTMLE
> ### Title: Iterative TMLE wrapper for 'fitSeqGcomp'
> ### Aliases: fitIterTMLE
> 
> ### ** Examples
> 
> options(stremr.verbose = TRUE)
> require("data.table")
Loading required package: data.table
> set_all_stremr_options(fit.package = "speedglm", fit.algorithm = "glm")
> 
> # ----------------------------------------------------------------------
> # Simulated Data
> # ----------------------------------------------------------------------
> data(OdataNoCENS)
> OdataDT <- as.data.table(OdataNoCENS, key=c(ID, t))
> 
> # define lagged N, first value is always 1 (always monitored at the first time point):
> OdataDT[, ("N.tminus1") := shift(get("N"), n = 1L, type = "lag", fill = 1L), by = ID]
> OdataDT[, ("TI.tminus1") := shift(get("TI"), n = 1L, type = "lag", fill = 1L), by = ID]
> 
> # ----------------------------------------------------------------------
> # Define intervention (always treated):
> # ----------------------------------------------------------------------
> OdataDT[, ("TI.set1") := 1L]
> OdataDT[, ("TI.set0") := 0L]
> 
> # ----------------------------------------------------------------------
> # Import Data
> # ----------------------------------------------------------------------
> OData <- importData(OdataDT, ID = "ID", t = "t", covars = c("highA1c", "lastNat1", "N.tminus1"),
+                     CENS = "C", TRT = "TI", MONITOR = "N", OUTCOME = "Y.tplus1")
[1] "Using the following stremr options/settings: "

List of 8
 $ fit.package       : chr "speedglm"
 $ fit.algorithm     : chr "glm"
 $ bin.method        : chr "equal.mass"
 $ nbins             : num 10
 $ maxncats          : num 20
 $ maxNperBin        : num 500
 $ lower_bound_zero_Q: logi TRUE
 $ skip_update_zero_Q: logi TRUE 
[1] "...detecting the type of each input column..."
> 
> # ----------------------------------------------------------------------
> # Model the Propensity Scores
> # ----------------------------------------------------------------------
> gform_CENS <- "C ~ highA1c + lastNat1"
> gform_TRT = "TI ~ CVD + highA1c + N.tminus1"
> gform_MONITOR <- "N ~ 1"
> stratify_CENS <- list(C=c("t < 16", "t == 16"))
> 
> # ----------------------------------------------------------------------
> # Fit Propensity Scores
> # ----------------------------------------------------------------------
> OData <- fitPropensity(OData, gform_CENS = gform_CENS,
+                         gform_TRT = gform_TRT,
+                         gform_MONITOR = gform_MONITOR,
+                         stratify_CENS = stratify_CENS)
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "gC" "gA" "gN"
[1] "Outcomes: "
[1] ""
[1] "No. of regressions: 3"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "C"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: C"
[1] "Predictors: highA1c, lastNat1"
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "StratifiedModel outcome: C"
[1] "StratifiedModel expressions: (t < 16,t == 16)"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: C, C"
[1] "Predictors: highA1c, lastNat1"
[1] "No. of regressions: 2"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(C|highA1c, lastNat1);\\ Stratify: t < 16"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(C|highA1c, lastNat1);\\ Stratify: t == 16"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: CVD, highA1c, N.tminus1"
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "N"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: N"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(N|);\\ Stratify: "
[1] "performing fitting for outcome based on stratified model for outcome: C"
[1] "fitting the model: P(C|highA1c, lastNat1);\\ Stratify: t < 16"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
    Intercept       highA1c      lastNat1 
-2.656607e+01  8.128911e-12  5.225396e-12 
[1] "fitting the model: P(C|highA1c, lastNat1);\\ Stratify: t == 16"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
    Intercept       highA1c      lastNat1 
-2.656607e+01 -5.129323e-13 -3.008816e-13 
fit for C var succeeded...
[1] "fitting the model: P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
 Intercept        CVD    highA1c  N.tminus1 
 0.6250400  1.3852271 -0.1432429  0.1288901 
[1] "fitting the model: P(N|);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
  Intercept 
-0.01358231 
[1] "performing prediction for outcome based on stratified model: C"
> 
> # ----------------------------------------------------------------------
> # IPW Ajusted KM or Saturated MSM
> # ----------------------------------------------------------------------
> require("magrittr")
Loading required package: magrittr
> AKME.St.1 <- getIPWeights(OData, intervened_TRT = "TI.set1") %>%
+              survNPMSM(OData) %$%
+              IPW_estimates
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> AKME.St.1
    t  sum_Y_IPAW sum_all_IPAW          ht   St.IPTW       ht.KM     St.KM
1   0   1.6610718     38.13840 0.043553792 0.9564462 0.047337278 0.9526627
2   1   0.8070748     48.10323 0.016777974 0.9403990 0.018633540 0.9349112
3   2   1.0721508     65.59519 0.016344959 0.9250282 0.012658228 0.9230769
4   3   0.0000000     91.16229 0.000000000 0.9250282 0.000000000 0.9230769
5   4   3.4232039    132.03450 0.025926586 0.9010454 0.025641026 0.8994083
6   5   2.7647724    182.07477 0.015184819 0.8873632 0.026315789 0.8757396
7   6   0.6840395    257.65098 0.002654907 0.8850073 0.013513514 0.8639053
8   7   7.2912160    375.48517 0.019418120 0.8678221 0.013698630 0.8520710
9   8  11.8316412    540.78252 0.021878742 0.8488353 0.034722222 0.8224852
10  9   7.8472558    766.65939 0.010235648 0.8401469 0.007194245 0.8165680
11 10   0.0000000   1131.74617 0.000000000 0.8401469 0.000000000 0.8165680
12 11  19.6818394   1698.64910 0.011586760 0.8304123 0.014492754 0.8047337
13 12 112.5585923   2500.60892 0.045012473 0.7930334 0.044117647 0.7692308
14 13  76.8430786   3426.37023 0.022426963 0.7752481 0.015384615 0.7573964
15 14   0.0000000   4968.01401 0.000000000 0.7752481 0.000000000 0.7573964
16 15 398.1827812   7488.93955 0.053169448 0.7340285 0.046875000 0.7218935
17 16   0.0000000  10147.78922 0.000000000 0.7340285 0.000000000 0.7218935
   rule.name
1    TI.set1
2    TI.set1
3    TI.set1
4    TI.set1
5    TI.set1
6    TI.set1
7    TI.set1
8    TI.set1
9    TI.set1
10   TI.set1
11   TI.set1
12   TI.set1
13   TI.set1
14   TI.set1
15   TI.set1
16   TI.set1
17   TI.set1
> 
> # ----------------------------------------------------------------------
> # Bounded IPW
> # ----------------------------------------------------------------------
> IPW.St.1 <- getIPWeights(OData, intervened_TRT = "TI.set1") %>%
+              survDirectIPW(OData)
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> IPW.St.1[]
            est_name  t  sum_Y_IPAW   sum_IPAW       risk     S.t.n
 1: DirectBoundedIPW  0    9.828827   225.6710 0.04355379 0.9564462
 2: DirectBoundedIPW  1   14.841714   308.6067 0.04809266 0.9519073
 3: DirectBoundedIPW  2   21.627479   430.0012 0.05029632 0.9497037
 4: DirectBoundedIPW  3   21.627479   606.0012 0.03568884 0.9643112
 5: DirectBoundedIPW  4   43.571094   868.0025 0.05019697 0.9498030
 6: DirectBoundedIPW  5   61.760385  1241.4314 0.04974933 0.9502507
 7: DirectBoundedIPW  6   66.382274  1802.6454 0.03682492 0.9631751
 8: DirectBoundedIPW  7  116.322109  2638.1985 0.04409149 0.9559085
 9: DirectBoundedIPW  8  198.486284  3871.7562 0.05126518 0.9487348
10: DirectBoundedIPW  9  254.941362  5714.0214 0.04461680 0.9553832
11: DirectBoundedIPW 10  254.941362  8456.0006 0.03014917 0.9698508
12: DirectBoundedIPW 11  397.563386 12563.9928 0.03164308 0.9683569
13: DirectBoundedIPW 12 1225.200094 18784.3937 0.06522436 0.9347756
14: DirectBoundedIPW 13 1816.300699 27581.8941 0.06585120 0.9341488
15: DirectBoundedIPW 14 1816.300699 40628.9102 0.04470464 0.9552954
16: DirectBoundedIPW 15 4927.103677 60323.6409 0.08167782 0.9183222
> 
> # ----------------------------------------------------------------------
> # IPW-MSM for hazard
> # ----------------------------------------------------------------------
> wts.DT.1 <- getIPWeights(OData = OData, intervened_TRT = "TI.set1", rule_name = "TI1")
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> wts.DT.0 <- getIPWeights(OData = OData, intervened_TRT = "TI.set0", rule_name = "TI0")
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> survMSM_res <- survMSM(list(wts.DT.1, wts.DT.0), OData, t_breaks = c(1:8,12,16)-1,)
[1] "performing estimation for the following TRT/MONITOR rules found in column 'rule.name': TI0,TI1"
[1] "periods"
 [1]  0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15
[1] "defined t.dummy: Periods.0to0"
[1] "defined t.dummy: Periods.1to1"
[1] "defined t.dummy: Periods.2to2"
[1] "defined t.dummy: Periods.3to3"
[1] "defined t.dummy: Periods.4to4"
[1] "defined t.dummy: Periods.5to5"
[1] "defined t.dummy: Periods.6to6"
[1] "defined t.dummy: Periods.7to7"
[1] "defined t.dummy: Periods.8to11"
[1] "defined t.dummy: Periods.12to15"
[1] "Periods.0to0_TI0"
[1] "Periods.1to1_TI0"
[1] "Periods.2to2_TI0"
[1] "Periods.3to3_TI0"
[1] "Periods.4to4_TI0"
[1] "Periods.5to5_TI0"
[1] "Periods.6to6_TI0"
[1] "Periods.7to7_TI0"
[1] "Periods.8to11_TI0"
[1] "Periods.12to15_TI0"
[1] "Periods.0to0_TI1"
[1] "Periods.1to1_TI1"
[1] "Periods.2to2_TI1"
[1] "Periods.3to3_TI1"
[1] "Periods.4to4_TI1"
[1] "Periods.5to5_TI1"
[1] "Periods.6to6_TI1"
[1] "Periods.7to7_TI1"
[1] "Periods.8to11_TI1"
[1] "Periods.12to15_TI1"
...fitting hazard MSM with speedglm::speedglm.wfit...
[1] "MSM fits"
  Periods.0to0_TI0   Periods.1to1_TI0   Periods.2to2_TI0   Periods.3to3_TI0 
     -5.465039e+00      -4.324378e+00      -4.012934e+00      -1.166619e+15 
  Periods.4to4_TI0   Periods.5to5_TI0   Periods.6to6_TI0   Periods.7to7_TI0 
     -6.871355e+14      -4.884654e+14      -6.732368e+00      -6.414551e+00 
 Periods.8to11_TI0 Periods.12to15_TI0   Periods.0to0_TI1   Periods.1to1_TI1 
     -2.490327e+15      -3.057464e+15      -3.089228e+00      -4.070768e+00 
  Periods.2to2_TI1   Periods.3to3_TI1   Periods.4to4_TI1   Periods.5to5_TI1 
     -4.097356e+00      -1.444049e+01      -3.626218e+00      -4.172158e+00 
  Periods.6to6_TI1   Periods.7to7_TI1  Periods.8to11_TI1 Periods.12to15_TI1 
     -5.928687e+00      -3.921940e+00      -4.645602e+00      -3.410729e+00 
...evaluating MSM-based survival curves...
...evaluating SEs based on MSM hazard fit and the estimated IC...
[1] "Should all be very small: "
  Periods.0to0_TI0   Periods.1to1_TI0   Periods.2to2_TI0   Periods.3to3_TI0 
      8.745296e-16       4.214695e-15       8.819608e-15       7.293270e+00 
  Periods.4to4_TI0   Periods.5to5_TI0   Periods.6to6_TI0   Periods.7to7_TI0 
      6.561300e+01       4.445403e+02       5.648100e-14       5.676302e-14 
 Periods.8to11_TI0 Periods.12to15_TI0   Periods.0to0_TI1   Periods.1to1_TI1 
      2.030033e+02       7.899748e+02       3.196367e-18       3.295818e-18 
  Periods.2to2_TI1   Periods.3to3_TI1   Periods.4to4_TI1   Periods.5to5_TI1 
      5.938153e-18       4.879654e-08       5.552308e-18       8.758887e-18 
  Periods.6to6_TI1   Periods.7to7_TI1  Periods.8to11_TI1 Periods.12to15_TI1 
      9.627973e-20       1.899923e-17       1.180759e-18       4.982015e-15 
[1] "Should all be very small: "
  Periods.0to0_TI0   Periods.1to1_TI0   Periods.2to2_TI0   Periods.3to3_TI0 
      8.645048e-14       4.643372e-14       2.150078e-14       3.336980e+14 
  Periods.4to4_TI0   Periods.5to5_TI0   Periods.6to6_TI0   Periods.7to7_TI0 
      7.563694e+14       1.183848e+15       9.715875e-15       1.095287e-14 
 Periods.8to11_TI0 Periods.12to15_TI0   Periods.0to0_TI1   Periods.1to1_TI1 
      1.830248e+14       5.408850e+14       2.038744e-15       4.102638e-15 
  Periods.2to2_TI1   Periods.3to3_TI1   Periods.4to4_TI1   Periods.5to5_TI1 
      5.644245e-15       1.000001e+00       1.646367e-15       3.270332e-15 
  Periods.6to6_TI1   Periods.7to7_TI1  Periods.8to11_TI1 Periods.12to15_TI1 
      1.486411e-16       2.648109e-15       3.026786e-17       8.738800e-15 
[1] "Should all be very small: "
 [1] 3.628268e-16 2.387874e-16 1.344854e-16 1.344854e-16 1.344854e-16
 [6] 1.344854e-16 1.449570e-16 1.619186e-16 1.619186e-16 1.619186e-16
[11] 1.619186e-16 1.619186e-16 1.619186e-16 1.619186e-16 1.619186e-16
[16] 1.619186e-16
[1] "Should all be very small: "
 [1] 8.519431e-17 1.505626e-17 1.044968e-16 4.951408e-07 4.823035e-07
 [6] 4.749798e-07 4.737188e-07 4.645200e-07 4.601013e-07 4.557247e-07
[11] 4.513896e-07 4.470959e-07 4.328058e-07 4.189726e-07 4.055814e-07
[16] 3.926183e-07
> survMSM_res$St
$TI0
 [1] 0.9957857 0.9827720 0.9653188 0.9653188 0.9653188 0.9653188 0.9641698
 [8] 0.9625935 0.9625935 0.9625935 0.9625935 0.9625935 0.9625935 0.9625935
[15] 0.9625935 0.9625935

$TI1
 [1] 0.9564462 0.9403990 0.9250282 0.9250277 0.9010449 0.8873627 0.8850068
 [8] 0.8678217 0.8595666 0.8513901 0.8432913 0.8352696 0.8085728 0.7827293
[15] 0.7577119 0.7334940

> 
> # ----------------------------------------------------------------------
> # Sequential G-COMP
> # ----------------------------------------------------------------------
> t.surv <- c(0:15)
> Qforms <- rep.int("Q.kplus1 ~ CVD + highA1c + N + lastNat1 + TI + TI.tminus1", (max(t.surv)+1))
> params = list(fit.package = "speedglm", fit.algorithm = "glm")
> 
> ## Not run: 
> ##D gcomp_est <- fitSeqGcomp(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D                           Qforms = Qforms, params_Q = params, stratifyQ_by_rule = FALSE)
> ##D gcomp_est[]
> ## End(Not run)
> # ----------------------------------------------------------------------
> # TMLE
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D tmle_est <- fitTMLE(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D                     Qforms = Qforms, params_Q = params, stratifyQ_by_rule = TRUE)
> ##D tmle_est[]
> ## End(Not run)
> 
> # ----------------------------------------------------------------------
> # Running IPW-Adjusted KM with optional user-specified weights:
> # ----------------------------------------------------------------------
> addedWts_DT <- OdataDT[, c("ID", "t"), with = FALSE]
> addedWts_DT[, new.wts := sample.int(10, nrow(OdataDT), replace = TRUE)/10]
> survNP_res_addedWts <- survNPMSM(wts.DT.1, OData, weights = addedWts_DT)
> 
> # ----------------------------------------------------------------------
> # Multivariate Propensity Score Regressions
> # ----------------------------------------------------------------------
> gform_CENS <- "C + TI + N ~ highA1c + lastNat1"
> OData <- fitPropensity(OData, gform_CENS = gform_CENS, gform_TRT = gform_TRT,
+                         gform_MONITOR = gform_MONITOR)
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "gC" "gA" "gN"
[1] "Outcomes: "
[1] ""
[1] "No. of regressions: 3"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "C,TI,N"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: C, TI, N"
[1] "Predictors: highA1c, lastNat1"
[1] "No. of regressions: 3"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(C|highA1c, lastNat1);\\ Stratify: "
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|C, highA1c, lastNat1);\\ Stratify: C == 0"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(N|C, TI, highA1c, lastNat1);\\ Stratify: C == 0 & TI == 0"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: CVD, highA1c, N.tminus1"
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "N"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: N"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(N|);\\ Stratify: "
[1] "fitting the model: P(C|highA1c, lastNat1);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
    Intercept       highA1c      lastNat1 
-2.656607e+01  9.238692e-12  2.688942e-12 
[1] "fitting the model: P(TI|C, highA1c, lastNat1);\\ Stratify: C == 0"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
  Intercept           C     highA1c    lastNat1 
 0.87385792          NA -0.18986136 -0.06706656 
[1] "fitting the model: P(N|C, TI, highA1c, lastNat1);\\ Stratify: C == 0 & TI == 0"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
   Intercept            C           TI      highA1c     lastNat1 
-0.025688525           NA           NA  0.001591313 -0.012014026 
[1] "fitting the model: P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
 Intercept        CVD    highA1c  N.tminus1 
 0.6250400  1.3852271 -0.1432429  0.1288901 
[1] "fitting the model: P(N|);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
  Intercept 
-0.01358231 
> 
> # ----------------------------------------------------------------------
> # Fitting Propensity scores with Random Forests:
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "randomForest")
> ##D require("h2o")
> ##D h2o::h2o.init(nthreads = -1)
> ##D gform_CENS <- "C ~ highA1c + lastNat1"
> ##D OData <- fitPropensity(OData, gform_CENS = gform_CENS,
> ##D                         gform_TRT = gform_TRT,
> ##D                         gform_MONITOR = gform_MONITOR,
> ##D                         stratify_CENS = stratify_CENS)
> ##D 
> ##D # For Gradient Boosting machines:
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "gbm")
> ##D # Use `H2O-3` distributed implementation of GLM
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "glm")
> ##D # Use Deep Neural Nets:
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "deeplearning")
> ## End(Not run)
> 
> # ----------------------------------------------------------------------
> # Fitting different models with different algorithms
> # Fine tuning modeling with optional tuning parameters.
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D params_TRT = list(fit.package = "h2o", fit.algorithm = "gbm", ntrees = 50,
> ##D     learn_rate = 0.05, sample_rate = 0.8, col_sample_rate = 0.8,
> ##D     balance_classes = TRUE)
> ##D params_CENS = list(fit.package = "speedglm", fit.algorithm = "glm")
> ##D params_MONITOR = list(fit.package = "speedglm", fit.algorithm = "glm")
> ##D OData <- fitPropensity(OData,
> ##D             gform_CENS = gform_CENS, stratify_CENS = stratify_CENS, params_CENS = params_CENS,
> ##D             gform_TRT = gform_TRT, params_TRT = params_TRT,
> ##D             gform_MONITOR = gform_MONITOR, params_MONITOR = params_MONITOR)
> ## End(Not run)
> 
> # ----------------------------------------------------------------------
> # Running TMLE based on the previous fit of the propensity scores.
> # Also applying Random Forest to estimate the sequential outcome model
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D t.surv <- c(0:5)
> ##D Qforms <- rep.int("Q.kplus1 ~ CVD + highA1c + N + lastNat1 + TI + TI.tminus1", (max(t.surv)+1))
> ##D params_Q = list(fit.package = "h2o", fit.algorithm = "randomForest",
> ##D                 ntrees = 100, learn_rate = 0.05, sample_rate = 0.8,
> ##D                 col_sample_rate = 0.8, balance_classes = TRUE)
> ##D tmle_est <- fitTMLE(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D             Qforms = Qforms, params_Q = params_Q,
> ##D             stratifyQ_by_rule = TRUE)
> ## End(Not run)
> 
> ## Not run: 
> ##D t.surv <- c(0:5)
> ##D Qforms <- rep.int("Q.kplus1 ~ CVD + highA1c + N + lastNat1 + TI + TI.tminus1", (max(t.surv)+1))
> ##D params_Q = list(fit.package = "h2o", fit.algorithm = "randomForest",
> ##D                 ntrees = 100, learn_rate = 0.05, sample_rate = 0.8,
> ##D                 col_sample_rate = 0.8, balance_classes = TRUE)
> ##D tmle_est <- fitTMLE(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D             Qforms = Qforms, params_Q = params_Q,
> ##D             stratifyQ_by_rule = FALSE)
> ## End(Not run)
> 
> 
> 
> 
> cleanEx()

detaching ‘package:magrittr’, ‘package:data.table’

> nameEx("fitPropensity")
> ### * fitPropensity
> 
> flush(stderr()); flush(stdout())
> 
> ### Name: fitPropensity
> ### Title: Define and fit propensity score models.
> ### Aliases: fitPropensity
> 
> ### ** Examples
> 
> options(stremr.verbose = TRUE)
> require("data.table")
Loading required package: data.table
> set_all_stremr_options(fit.package = "speedglm", fit.algorithm = "glm")
> 
> # ----------------------------------------------------------------------
> # Simulated Data
> # ----------------------------------------------------------------------
> data(OdataNoCENS)
> OdataDT <- as.data.table(OdataNoCENS, key=c(ID, t))
> 
> # define lagged N, first value is always 1 (always monitored at the first time point):
> OdataDT[, ("N.tminus1") := shift(get("N"), n = 1L, type = "lag", fill = 1L), by = ID]
> OdataDT[, ("TI.tminus1") := shift(get("TI"), n = 1L, type = "lag", fill = 1L), by = ID]
> 
> # ----------------------------------------------------------------------
> # Define intervention (always treated):
> # ----------------------------------------------------------------------
> OdataDT[, ("TI.set1") := 1L]
> OdataDT[, ("TI.set0") := 0L]
> 
> # ----------------------------------------------------------------------
> # Import Data
> # ----------------------------------------------------------------------
> OData <- importData(OdataDT, ID = "ID", t = "t", covars = c("highA1c", "lastNat1", "N.tminus1"),
+                     CENS = "C", TRT = "TI", MONITOR = "N", OUTCOME = "Y.tplus1")
[1] "Using the following stremr options/settings: "

List of 8
 $ fit.package       : chr "speedglm"
 $ fit.algorithm     : chr "glm"
 $ bin.method        : chr "equal.mass"
 $ nbins             : num 10
 $ maxncats          : num 20
 $ maxNperBin        : num 500
 $ lower_bound_zero_Q: logi TRUE
 $ skip_update_zero_Q: logi TRUE 
[1] "...detecting the type of each input column..."
> 
> # ----------------------------------------------------------------------
> # Model the Propensity Scores
> # ----------------------------------------------------------------------
> gform_CENS <- "C ~ highA1c + lastNat1"
> gform_TRT = "TI ~ CVD + highA1c + N.tminus1"
> gform_MONITOR <- "N ~ 1"
> stratify_CENS <- list(C=c("t < 16", "t == 16"))
> 
> # ----------------------------------------------------------------------
> # Fit Propensity Scores
> # ----------------------------------------------------------------------
> OData <- fitPropensity(OData, gform_CENS = gform_CENS,
+                         gform_TRT = gform_TRT,
+                         gform_MONITOR = gform_MONITOR,
+                         stratify_CENS = stratify_CENS)
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "gC" "gA" "gN"
[1] "Outcomes: "
[1] ""
[1] "No. of regressions: 3"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "C"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: C"
[1] "Predictors: highA1c, lastNat1"
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "StratifiedModel outcome: C"
[1] "StratifiedModel expressions: (t < 16,t == 16)"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: C, C"
[1] "Predictors: highA1c, lastNat1"
[1] "No. of regressions: 2"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(C|highA1c, lastNat1);\\ Stratify: t < 16"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(C|highA1c, lastNat1);\\ Stratify: t == 16"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: CVD, highA1c, N.tminus1"
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "N"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: N"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(N|);\\ Stratify: "
[1] "performing fitting for outcome based on stratified model for outcome: C"
[1] "fitting the model: P(C|highA1c, lastNat1);\\ Stratify: t < 16"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
    Intercept       highA1c      lastNat1 
-2.656607e+01  8.128911e-12  5.225396e-12 
[1] "fitting the model: P(C|highA1c, lastNat1);\\ Stratify: t == 16"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
    Intercept       highA1c      lastNat1 
-2.656607e+01 -5.129323e-13 -3.008816e-13 
fit for C var succeeded...
[1] "fitting the model: P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
 Intercept        CVD    highA1c  N.tminus1 
 0.6250400  1.3852271 -0.1432429  0.1288901 
[1] "fitting the model: P(N|);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
  Intercept 
-0.01358231 
[1] "performing prediction for outcome based on stratified model: C"
> 
> # ----------------------------------------------------------------------
> # IPW Ajusted KM or Saturated MSM
> # ----------------------------------------------------------------------
> require("magrittr")
Loading required package: magrittr
> AKME.St.1 <- getIPWeights(OData, intervened_TRT = "TI.set1") %>%
+              survNPMSM(OData) %$%
+              IPW_estimates
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> AKME.St.1
    t  sum_Y_IPAW sum_all_IPAW          ht   St.IPTW       ht.KM     St.KM
1   0   1.6610718     38.13840 0.043553792 0.9564462 0.047337278 0.9526627
2   1   0.8070748     48.10323 0.016777974 0.9403990 0.018633540 0.9349112
3   2   1.0721508     65.59519 0.016344959 0.9250282 0.012658228 0.9230769
4   3   0.0000000     91.16229 0.000000000 0.9250282 0.000000000 0.9230769
5   4   3.4232039    132.03450 0.025926586 0.9010454 0.025641026 0.8994083
6   5   2.7647724    182.07477 0.015184819 0.8873632 0.026315789 0.8757396
7   6   0.6840395    257.65098 0.002654907 0.8850073 0.013513514 0.8639053
8   7   7.2912160    375.48517 0.019418120 0.8678221 0.013698630 0.8520710
9   8  11.8316412    540.78252 0.021878742 0.8488353 0.034722222 0.8224852
10  9   7.8472558    766.65939 0.010235648 0.8401469 0.007194245 0.8165680
11 10   0.0000000   1131.74617 0.000000000 0.8401469 0.000000000 0.8165680
12 11  19.6818394   1698.64910 0.011586760 0.8304123 0.014492754 0.8047337
13 12 112.5585923   2500.60892 0.045012473 0.7930334 0.044117647 0.7692308
14 13  76.8430786   3426.37023 0.022426963 0.7752481 0.015384615 0.7573964
15 14   0.0000000   4968.01401 0.000000000 0.7752481 0.000000000 0.7573964
16 15 398.1827812   7488.93955 0.053169448 0.7340285 0.046875000 0.7218935
17 16   0.0000000  10147.78922 0.000000000 0.7340285 0.000000000 0.7218935
   rule.name
1    TI.set1
2    TI.set1
3    TI.set1
4    TI.set1
5    TI.set1
6    TI.set1
7    TI.set1
8    TI.set1
9    TI.set1
10   TI.set1
11   TI.set1
12   TI.set1
13   TI.set1
14   TI.set1
15   TI.set1
16   TI.set1
17   TI.set1
> 
> # ----------------------------------------------------------------------
> # Bounded IPW
> # ----------------------------------------------------------------------
> IPW.St.1 <- getIPWeights(OData, intervened_TRT = "TI.set1") %>%
+              survDirectIPW(OData)
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> IPW.St.1[]
            est_name  t  sum_Y_IPAW   sum_IPAW       risk     S.t.n
 1: DirectBoundedIPW  0    9.828827   225.6710 0.04355379 0.9564462
 2: DirectBoundedIPW  1   14.841714   308.6067 0.04809266 0.9519073
 3: DirectBoundedIPW  2   21.627479   430.0012 0.05029632 0.9497037
 4: DirectBoundedIPW  3   21.627479   606.0012 0.03568884 0.9643112
 5: DirectBoundedIPW  4   43.571094   868.0025 0.05019697 0.9498030
 6: DirectBoundedIPW  5   61.760385  1241.4314 0.04974933 0.9502507
 7: DirectBoundedIPW  6   66.382274  1802.6454 0.03682492 0.9631751
 8: DirectBoundedIPW  7  116.322109  2638.1985 0.04409149 0.9559085
 9: DirectBoundedIPW  8  198.486284  3871.7562 0.05126518 0.9487348
10: DirectBoundedIPW  9  254.941362  5714.0214 0.04461680 0.9553832
11: DirectBoundedIPW 10  254.941362  8456.0006 0.03014917 0.9698508
12: DirectBoundedIPW 11  397.563386 12563.9928 0.03164308 0.9683569
13: DirectBoundedIPW 12 1225.200094 18784.3937 0.06522436 0.9347756
14: DirectBoundedIPW 13 1816.300699 27581.8941 0.06585120 0.9341488
15: DirectBoundedIPW 14 1816.300699 40628.9102 0.04470464 0.9552954
16: DirectBoundedIPW 15 4927.103677 60323.6409 0.08167782 0.9183222
> 
> # ----------------------------------------------------------------------
> # IPW-MSM for hazard
> # ----------------------------------------------------------------------
> wts.DT.1 <- getIPWeights(OData = OData, intervened_TRT = "TI.set1", rule_name = "TI1")
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> wts.DT.0 <- getIPWeights(OData = OData, intervened_TRT = "TI.set0", rule_name = "TI0")
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> survMSM_res <- survMSM(list(wts.DT.1, wts.DT.0), OData, t_breaks = c(1:8,12,16)-1,)
[1] "performing estimation for the following TRT/MONITOR rules found in column 'rule.name': TI0,TI1"
[1] "periods"
 [1]  0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15
[1] "defined t.dummy: Periods.0to0"
[1] "defined t.dummy: Periods.1to1"
[1] "defined t.dummy: Periods.2to2"
[1] "defined t.dummy: Periods.3to3"
[1] "defined t.dummy: Periods.4to4"
[1] "defined t.dummy: Periods.5to5"
[1] "defined t.dummy: Periods.6to6"
[1] "defined t.dummy: Periods.7to7"
[1] "defined t.dummy: Periods.8to11"
[1] "defined t.dummy: Periods.12to15"
[1] "Periods.0to0_TI0"
[1] "Periods.1to1_TI0"
[1] "Periods.2to2_TI0"
[1] "Periods.3to3_TI0"
[1] "Periods.4to4_TI0"
[1] "Periods.5to5_TI0"
[1] "Periods.6to6_TI0"
[1] "Periods.7to7_TI0"
[1] "Periods.8to11_TI0"
[1] "Periods.12to15_TI0"
[1] "Periods.0to0_TI1"
[1] "Periods.1to1_TI1"
[1] "Periods.2to2_TI1"
[1] "Periods.3to3_TI1"
[1] "Periods.4to4_TI1"
[1] "Periods.5to5_TI1"
[1] "Periods.6to6_TI1"
[1] "Periods.7to7_TI1"
[1] "Periods.8to11_TI1"
[1] "Periods.12to15_TI1"
...fitting hazard MSM with speedglm::speedglm.wfit...
[1] "MSM fits"
  Periods.0to0_TI0   Periods.1to1_TI0   Periods.2to2_TI0   Periods.3to3_TI0 
     -5.465039e+00      -4.324378e+00      -4.012934e+00      -1.166619e+15 
  Periods.4to4_TI0   Periods.5to5_TI0   Periods.6to6_TI0   Periods.7to7_TI0 
     -6.871355e+14      -4.884654e+14      -6.732368e+00      -6.414551e+00 
 Periods.8to11_TI0 Periods.12to15_TI0   Periods.0to0_TI1   Periods.1to1_TI1 
     -2.490327e+15      -3.057464e+15      -3.089228e+00      -4.070768e+00 
  Periods.2to2_TI1   Periods.3to3_TI1   Periods.4to4_TI1   Periods.5to5_TI1 
     -4.097356e+00      -1.444049e+01      -3.626218e+00      -4.172158e+00 
  Periods.6to6_TI1   Periods.7to7_TI1  Periods.8to11_TI1 Periods.12to15_TI1 
     -5.928687e+00      -3.921940e+00      -4.645602e+00      -3.410729e+00 
...evaluating MSM-based survival curves...
...evaluating SEs based on MSM hazard fit and the estimated IC...
[1] "Should all be very small: "
  Periods.0to0_TI0   Periods.1to1_TI0   Periods.2to2_TI0   Periods.3to3_TI0 
      8.745296e-16       4.214695e-15       8.819608e-15       7.293270e+00 
  Periods.4to4_TI0   Periods.5to5_TI0   Periods.6to6_TI0   Periods.7to7_TI0 
      6.561300e+01       4.445403e+02       5.648100e-14       5.676302e-14 
 Periods.8to11_TI0 Periods.12to15_TI0   Periods.0to0_TI1   Periods.1to1_TI1 
      2.030033e+02       7.899748e+02       3.196367e-18       3.295818e-18 
  Periods.2to2_TI1   Periods.3to3_TI1   Periods.4to4_TI1   Periods.5to5_TI1 
      5.938153e-18       4.879654e-08       5.552308e-18       8.758887e-18 
  Periods.6to6_TI1   Periods.7to7_TI1  Periods.8to11_TI1 Periods.12to15_TI1 
      9.627973e-20       1.899923e-17       1.180759e-18       4.982015e-15 
[1] "Should all be very small: "
  Periods.0to0_TI0   Periods.1to1_TI0   Periods.2to2_TI0   Periods.3to3_TI0 
      8.645048e-14       4.643372e-14       2.150078e-14       3.336980e+14 
  Periods.4to4_TI0   Periods.5to5_TI0   Periods.6to6_TI0   Periods.7to7_TI0 
      7.563694e+14       1.183848e+15       9.715875e-15       1.095287e-14 
 Periods.8to11_TI0 Periods.12to15_TI0   Periods.0to0_TI1   Periods.1to1_TI1 
      1.830248e+14       5.408850e+14       2.038744e-15       4.102638e-15 
  Periods.2to2_TI1   Periods.3to3_TI1   Periods.4to4_TI1   Periods.5to5_TI1 
      5.644245e-15       1.000001e+00       1.646367e-15       3.270332e-15 
  Periods.6to6_TI1   Periods.7to7_TI1  Periods.8to11_TI1 Periods.12to15_TI1 
      1.486411e-16       2.648109e-15       3.026786e-17       8.738800e-15 
[1] "Should all be very small: "
 [1] 3.628268e-16 2.387874e-16 1.344854e-16 1.344854e-16 1.344854e-16
 [6] 1.344854e-16 1.449570e-16 1.619186e-16 1.619186e-16 1.619186e-16
[11] 1.619186e-16 1.619186e-16 1.619186e-16 1.619186e-16 1.619186e-16
[16] 1.619186e-16
[1] "Should all be very small: "
 [1] 8.519431e-17 1.505626e-17 1.044968e-16 4.951408e-07 4.823035e-07
 [6] 4.749798e-07 4.737188e-07 4.645200e-07 4.601013e-07 4.557247e-07
[11] 4.513896e-07 4.470959e-07 4.328058e-07 4.189726e-07 4.055814e-07
[16] 3.926183e-07
> survMSM_res$St
$TI0
 [1] 0.9957857 0.9827720 0.9653188 0.9653188 0.9653188 0.9653188 0.9641698
 [8] 0.9625935 0.9625935 0.9625935 0.9625935 0.9625935 0.9625935 0.9625935
[15] 0.9625935 0.9625935

$TI1
 [1] 0.9564462 0.9403990 0.9250282 0.9250277 0.9010449 0.8873627 0.8850068
 [8] 0.8678217 0.8595666 0.8513901 0.8432913 0.8352696 0.8085728 0.7827293
[15] 0.7577119 0.7334940

> 
> # ----------------------------------------------------------------------
> # Sequential G-COMP
> # ----------------------------------------------------------------------
> t.surv <- c(0:15)
> Qforms <- rep.int("Q.kplus1 ~ CVD + highA1c + N + lastNat1 + TI + TI.tminus1", (max(t.surv)+1))
> params = list(fit.package = "speedglm", fit.algorithm = "glm")
> 
> ## Not run: 
> ##D gcomp_est <- fitSeqGcomp(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D                           Qforms = Qforms, params_Q = params, stratifyQ_by_rule = FALSE)
> ##D gcomp_est[]
> ## End(Not run)
> # ----------------------------------------------------------------------
> # TMLE
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D tmle_est <- fitTMLE(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D                     Qforms = Qforms, params_Q = params, stratifyQ_by_rule = TRUE)
> ##D tmle_est[]
> ## End(Not run)
> 
> # ----------------------------------------------------------------------
> # Running IPW-Adjusted KM with optional user-specified weights:
> # ----------------------------------------------------------------------
> addedWts_DT <- OdataDT[, c("ID", "t"), with = FALSE]
> addedWts_DT[, new.wts := sample.int(10, nrow(OdataDT), replace = TRUE)/10]
> survNP_res_addedWts <- survNPMSM(wts.DT.1, OData, weights = addedWts_DT)
> 
> # ----------------------------------------------------------------------
> # Multivariate Propensity Score Regressions
> # ----------------------------------------------------------------------
> gform_CENS <- "C + TI + N ~ highA1c + lastNat1"
> OData <- fitPropensity(OData, gform_CENS = gform_CENS, gform_TRT = gform_TRT,
+                         gform_MONITOR = gform_MONITOR)
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "gC" "gA" "gN"
[1] "Outcomes: "
[1] ""
[1] "No. of regressions: 3"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "C,TI,N"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: C, TI, N"
[1] "Predictors: highA1c, lastNat1"
[1] "No. of regressions: 3"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(C|highA1c, lastNat1);\\ Stratify: "
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|C, highA1c, lastNat1);\\ Stratify: C == 0"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(N|C, TI, highA1c, lastNat1);\\ Stratify: C == 0 & TI == 0"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: CVD, highA1c, N.tminus1"
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "N"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: N"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(N|);\\ Stratify: "
[1] "fitting the model: P(C|highA1c, lastNat1);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
    Intercept       highA1c      lastNat1 
-2.656607e+01  9.238692e-12  2.688942e-12 
[1] "fitting the model: P(TI|C, highA1c, lastNat1);\\ Stratify: C == 0"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
  Intercept           C     highA1c    lastNat1 
 0.87385792          NA -0.18986136 -0.06706656 
[1] "fitting the model: P(N|C, TI, highA1c, lastNat1);\\ Stratify: C == 0 & TI == 0"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
   Intercept            C           TI      highA1c     lastNat1 
-0.025688525           NA           NA  0.001591313 -0.012014026 
[1] "fitting the model: P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
 Intercept        CVD    highA1c  N.tminus1 
 0.6250400  1.3852271 -0.1432429  0.1288901 
[1] "fitting the model: P(N|);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
  Intercept 
-0.01358231 
> 
> # ----------------------------------------------------------------------
> # Fitting Propensity scores with Random Forests:
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "randomForest")
> ##D require("h2o")
> ##D h2o::h2o.init(nthreads = -1)
> ##D gform_CENS <- "C ~ highA1c + lastNat1"
> ##D OData <- fitPropensity(OData, gform_CENS = gform_CENS,
> ##D                         gform_TRT = gform_TRT,
> ##D                         gform_MONITOR = gform_MONITOR,
> ##D                         stratify_CENS = stratify_CENS)
> ##D 
> ##D # For Gradient Boosting machines:
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "gbm")
> ##D # Use `H2O-3` distributed implementation of GLM
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "glm")
> ##D # Use Deep Neural Nets:
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "deeplearning")
> ## End(Not run)
> 
> # ----------------------------------------------------------------------
> # Fitting different models with different algorithms
> # Fine tuning modeling with optional tuning parameters.
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D params_TRT = list(fit.package = "h2o", fit.algorithm = "gbm", ntrees = 50,
> ##D     learn_rate = 0.05, sample_rate = 0.8, col_sample_rate = 0.8,
> ##D     balance_classes = TRUE)
> ##D params_CENS = list(fit.package = "speedglm", fit.algorithm = "glm")
> ##D params_MONITOR = list(fit.package = "speedglm", fit.algorithm = "glm")
> ##D OData <- fitPropensity(OData,
> ##D             gform_CENS = gform_CENS, stratify_CENS = stratify_CENS, params_CENS = params_CENS,
> ##D             gform_TRT = gform_TRT, params_TRT = params_TRT,
> ##D             gform_MONITOR = gform_MONITOR, params_MONITOR = params_MONITOR)
> ## End(Not run)
> 
> # ----------------------------------------------------------------------
> # Running TMLE based on the previous fit of the propensity scores.
> # Also applying Random Forest to estimate the sequential outcome model
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D t.surv <- c(0:5)
> ##D Qforms <- rep.int("Q.kplus1 ~ CVD + highA1c + N + lastNat1 + TI + TI.tminus1", (max(t.surv)+1))
> ##D params_Q = list(fit.package = "h2o", fit.algorithm = "randomForest",
> ##D                 ntrees = 100, learn_rate = 0.05, sample_rate = 0.8,
> ##D                 col_sample_rate = 0.8, balance_classes = TRUE)
> ##D tmle_est <- fitTMLE(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D             Qforms = Qforms, params_Q = params_Q,
> ##D             stratifyQ_by_rule = TRUE)
> ## End(Not run)
> 
> ## Not run: 
> ##D t.surv <- c(0:5)
> ##D Qforms <- rep.int("Q.kplus1 ~ CVD + highA1c + N + lastNat1 + TI + TI.tminus1", (max(t.surv)+1))
> ##D params_Q = list(fit.package = "h2o", fit.algorithm = "randomForest",
> ##D                 ntrees = 100, learn_rate = 0.05, sample_rate = 0.8,
> ##D                 col_sample_rate = 0.8, balance_classes = TRUE)
> ##D tmle_est <- fitTMLE(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D             Qforms = Qforms, params_Q = params_Q,
> ##D             stratifyQ_by_rule = FALSE)
> ## End(Not run)
> 
> 
> 
> 
> cleanEx()

detaching ‘package:magrittr’, ‘package:data.table’

> nameEx("fitSeqGcomp")
> ### * fitSeqGcomp
> 
> flush(stderr()); flush(stdout())
> 
> ### Name: fitSeqGcomp
> ### Title: Fit sequential GCOMP and TMLE for survival
> ### Aliases: fitSeqGcomp
> 
> ### ** Examples
> 
> options(stremr.verbose = TRUE)
> require("data.table")
Loading required package: data.table
> set_all_stremr_options(fit.package = "speedglm", fit.algorithm = "glm")
> 
> # ----------------------------------------------------------------------
> # Simulated Data
> # ----------------------------------------------------------------------
> data(OdataNoCENS)
> OdataDT <- as.data.table(OdataNoCENS, key=c(ID, t))
> 
> # define lagged N, first value is always 1 (always monitored at the first time point):
> OdataDT[, ("N.tminus1") := shift(get("N"), n = 1L, type = "lag", fill = 1L), by = ID]
> OdataDT[, ("TI.tminus1") := shift(get("TI"), n = 1L, type = "lag", fill = 1L), by = ID]
> 
> # ----------------------------------------------------------------------
> # Define intervention (always treated):
> # ----------------------------------------------------------------------
> OdataDT[, ("TI.set1") := 1L]
> OdataDT[, ("TI.set0") := 0L]
> 
> # ----------------------------------------------------------------------
> # Import Data
> # ----------------------------------------------------------------------
> OData <- importData(OdataDT, ID = "ID", t = "t", covars = c("highA1c", "lastNat1", "N.tminus1"),
+                     CENS = "C", TRT = "TI", MONITOR = "N", OUTCOME = "Y.tplus1")
[1] "Using the following stremr options/settings: "

List of 8
 $ fit.package       : chr "speedglm"
 $ fit.algorithm     : chr "glm"
 $ bin.method        : chr "equal.mass"
 $ nbins             : num 10
 $ maxncats          : num 20
 $ maxNperBin        : num 500
 $ lower_bound_zero_Q: logi TRUE
 $ skip_update_zero_Q: logi TRUE 
[1] "...detecting the type of each input column..."
> 
> # ----------------------------------------------------------------------
> # Model the Propensity Scores
> # ----------------------------------------------------------------------
> gform_CENS <- "C ~ highA1c + lastNat1"
> gform_TRT = "TI ~ CVD + highA1c + N.tminus1"
> gform_MONITOR <- "N ~ 1"
> stratify_CENS <- list(C=c("t < 16", "t == 16"))
> 
> # ----------------------------------------------------------------------
> # Fit Propensity Scores
> # ----------------------------------------------------------------------
> OData <- fitPropensity(OData, gform_CENS = gform_CENS,
+                         gform_TRT = gform_TRT,
+                         gform_MONITOR = gform_MONITOR,
+                         stratify_CENS = stratify_CENS)
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "gC" "gA" "gN"
[1] "Outcomes: "
[1] ""
[1] "No. of regressions: 3"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "C"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: C"
[1] "Predictors: highA1c, lastNat1"
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "StratifiedModel outcome: C"
[1] "StratifiedModel expressions: (t < 16,t == 16)"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: C, C"
[1] "Predictors: highA1c, lastNat1"
[1] "No. of regressions: 2"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(C|highA1c, lastNat1);\\ Stratify: t < 16"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(C|highA1c, lastNat1);\\ Stratify: t == 16"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: CVD, highA1c, N.tminus1"
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "N"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: N"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(N|);\\ Stratify: "
[1] "performing fitting for outcome based on stratified model for outcome: C"
[1] "fitting the model: P(C|highA1c, lastNat1);\\ Stratify: t < 16"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
    Intercept       highA1c      lastNat1 
-2.656607e+01  8.128911e-12  5.225396e-12 
[1] "fitting the model: P(C|highA1c, lastNat1);\\ Stratify: t == 16"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
    Intercept       highA1c      lastNat1 
-2.656607e+01 -5.129323e-13 -3.008816e-13 
fit for C var succeeded...
[1] "fitting the model: P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
 Intercept        CVD    highA1c  N.tminus1 
 0.6250400  1.3852271 -0.1432429  0.1288901 
[1] "fitting the model: P(N|);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
  Intercept 
-0.01358231 
[1] "performing prediction for outcome based on stratified model: C"
> 
> # ----------------------------------------------------------------------
> # IPW Ajusted KM or Saturated MSM
> # ----------------------------------------------------------------------
> require("magrittr")
Loading required package: magrittr
> AKME.St.1 <- getIPWeights(OData, intervened_TRT = "TI.set1") %>%
+              survNPMSM(OData) %$%
+              IPW_estimates
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> AKME.St.1
    t  sum_Y_IPAW sum_all_IPAW          ht   St.IPTW       ht.KM     St.KM
1   0   1.6610718     38.13840 0.043553792 0.9564462 0.047337278 0.9526627
2   1   0.8070748     48.10323 0.016777974 0.9403990 0.018633540 0.9349112
3   2   1.0721508     65.59519 0.016344959 0.9250282 0.012658228 0.9230769
4   3   0.0000000     91.16229 0.000000000 0.9250282 0.000000000 0.9230769
5   4   3.4232039    132.03450 0.025926586 0.9010454 0.025641026 0.8994083
6   5   2.7647724    182.07477 0.015184819 0.8873632 0.026315789 0.8757396
7   6   0.6840395    257.65098 0.002654907 0.8850073 0.013513514 0.8639053
8   7   7.2912160    375.48517 0.019418120 0.8678221 0.013698630 0.8520710
9   8  11.8316412    540.78252 0.021878742 0.8488353 0.034722222 0.8224852
10  9   7.8472558    766.65939 0.010235648 0.8401469 0.007194245 0.8165680
11 10   0.0000000   1131.74617 0.000000000 0.8401469 0.000000000 0.8165680
12 11  19.6818394   1698.64910 0.011586760 0.8304123 0.014492754 0.8047337
13 12 112.5585923   2500.60892 0.045012473 0.7930334 0.044117647 0.7692308
14 13  76.8430786   3426.37023 0.022426963 0.7752481 0.015384615 0.7573964
15 14   0.0000000   4968.01401 0.000000000 0.7752481 0.000000000 0.7573964
16 15 398.1827812   7488.93955 0.053169448 0.7340285 0.046875000 0.7218935
17 16   0.0000000  10147.78922 0.000000000 0.7340285 0.000000000 0.7218935
   rule.name
1    TI.set1
2    TI.set1
3    TI.set1
4    TI.set1
5    TI.set1
6    TI.set1
7    TI.set1
8    TI.set1
9    TI.set1
10   TI.set1
11   TI.set1
12   TI.set1
13   TI.set1
14   TI.set1
15   TI.set1
16   TI.set1
17   TI.set1
> 
> # ----------------------------------------------------------------------
> # Bounded IPW
> # ----------------------------------------------------------------------
> IPW.St.1 <- getIPWeights(OData, intervened_TRT = "TI.set1") %>%
+              survDirectIPW(OData)
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> IPW.St.1[]
            est_name  t  sum_Y_IPAW   sum_IPAW       risk     S.t.n
 1: DirectBoundedIPW  0    9.828827   225.6710 0.04355379 0.9564462
 2: DirectBoundedIPW  1   14.841714   308.6067 0.04809266 0.9519073
 3: DirectBoundedIPW  2   21.627479   430.0012 0.05029632 0.9497037
 4: DirectBoundedIPW  3   21.627479   606.0012 0.03568884 0.9643112
 5: DirectBoundedIPW  4   43.571094   868.0025 0.05019697 0.9498030
 6: DirectBoundedIPW  5   61.760385  1241.4314 0.04974933 0.9502507
 7: DirectBoundedIPW  6   66.382274  1802.6454 0.03682492 0.9631751
 8: DirectBoundedIPW  7  116.322109  2638.1985 0.04409149 0.9559085
 9: DirectBoundedIPW  8  198.486284  3871.7562 0.05126518 0.9487348
10: DirectBoundedIPW  9  254.941362  5714.0214 0.04461680 0.9553832
11: DirectBoundedIPW 10  254.941362  8456.0006 0.03014917 0.9698508
12: DirectBoundedIPW 11  397.563386 12563.9928 0.03164308 0.9683569
13: DirectBoundedIPW 12 1225.200094 18784.3937 0.06522436 0.9347756
14: DirectBoundedIPW 13 1816.300699 27581.8941 0.06585120 0.9341488
15: DirectBoundedIPW 14 1816.300699 40628.9102 0.04470464 0.9552954
16: DirectBoundedIPW 15 4927.103677 60323.6409 0.08167782 0.9183222
> 
> # ----------------------------------------------------------------------
> # IPW-MSM for hazard
> # ----------------------------------------------------------------------
> wts.DT.1 <- getIPWeights(OData = OData, intervened_TRT = "TI.set1", rule_name = "TI1")
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> wts.DT.0 <- getIPWeights(OData = OData, intervened_TRT = "TI.set0", rule_name = "TI0")
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> survMSM_res <- survMSM(list(wts.DT.1, wts.DT.0), OData, t_breaks = c(1:8,12,16)-1,)
[1] "performing estimation for the following TRT/MONITOR rules found in column 'rule.name': TI0,TI1"
[1] "periods"
 [1]  0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15
[1] "defined t.dummy: Periods.0to0"
[1] "defined t.dummy: Periods.1to1"
[1] "defined t.dummy: Periods.2to2"
[1] "defined t.dummy: Periods.3to3"
[1] "defined t.dummy: Periods.4to4"
[1] "defined t.dummy: Periods.5to5"
[1] "defined t.dummy: Periods.6to6"
[1] "defined t.dummy: Periods.7to7"
[1] "defined t.dummy: Periods.8to11"
[1] "defined t.dummy: Periods.12to15"
[1] "Periods.0to0_TI0"
[1] "Periods.1to1_TI0"
[1] "Periods.2to2_TI0"
[1] "Periods.3to3_TI0"
[1] "Periods.4to4_TI0"
[1] "Periods.5to5_TI0"
[1] "Periods.6to6_TI0"
[1] "Periods.7to7_TI0"
[1] "Periods.8to11_TI0"
[1] "Periods.12to15_TI0"
[1] "Periods.0to0_TI1"
[1] "Periods.1to1_TI1"
[1] "Periods.2to2_TI1"
[1] "Periods.3to3_TI1"
[1] "Periods.4to4_TI1"
[1] "Periods.5to5_TI1"
[1] "Periods.6to6_TI1"
[1] "Periods.7to7_TI1"
[1] "Periods.8to11_TI1"
[1] "Periods.12to15_TI1"
...fitting hazard MSM with speedglm::speedglm.wfit...
[1] "MSM fits"
  Periods.0to0_TI0   Periods.1to1_TI0   Periods.2to2_TI0   Periods.3to3_TI0 
     -5.465039e+00      -4.324378e+00      -4.012934e+00      -1.166619e+15 
  Periods.4to4_TI0   Periods.5to5_TI0   Periods.6to6_TI0   Periods.7to7_TI0 
     -6.871355e+14      -4.884654e+14      -6.732368e+00      -6.414551e+00 
 Periods.8to11_TI0 Periods.12to15_TI0   Periods.0to0_TI1   Periods.1to1_TI1 
     -2.490327e+15      -3.057464e+15      -3.089228e+00      -4.070768e+00 
  Periods.2to2_TI1   Periods.3to3_TI1   Periods.4to4_TI1   Periods.5to5_TI1 
     -4.097356e+00      -1.444049e+01      -3.626218e+00      -4.172158e+00 
  Periods.6to6_TI1   Periods.7to7_TI1  Periods.8to11_TI1 Periods.12to15_TI1 
     -5.928687e+00      -3.921940e+00      -4.645602e+00      -3.410729e+00 
...evaluating MSM-based survival curves...
...evaluating SEs based on MSM hazard fit and the estimated IC...
[1] "Should all be very small: "
  Periods.0to0_TI0   Periods.1to1_TI0   Periods.2to2_TI0   Periods.3to3_TI0 
      8.745296e-16       4.214695e-15       8.819608e-15       7.293270e+00 
  Periods.4to4_TI0   Periods.5to5_TI0   Periods.6to6_TI0   Periods.7to7_TI0 
      6.561300e+01       4.445403e+02       5.648100e-14       5.676302e-14 
 Periods.8to11_TI0 Periods.12to15_TI0   Periods.0to0_TI1   Periods.1to1_TI1 
      2.030033e+02       7.899748e+02       3.196367e-18       3.295818e-18 
  Periods.2to2_TI1   Periods.3to3_TI1   Periods.4to4_TI1   Periods.5to5_TI1 
      5.938153e-18       4.879654e-08       5.552308e-18       8.758887e-18 
  Periods.6to6_TI1   Periods.7to7_TI1  Periods.8to11_TI1 Periods.12to15_TI1 
      9.627973e-20       1.899923e-17       1.180759e-18       4.982015e-15 
[1] "Should all be very small: "
  Periods.0to0_TI0   Periods.1to1_TI0   Periods.2to2_TI0   Periods.3to3_TI0 
      8.645048e-14       4.643372e-14       2.150078e-14       3.336980e+14 
  Periods.4to4_TI0   Periods.5to5_TI0   Periods.6to6_TI0   Periods.7to7_TI0 
      7.563694e+14       1.183848e+15       9.715875e-15       1.095287e-14 
 Periods.8to11_TI0 Periods.12to15_TI0   Periods.0to0_TI1   Periods.1to1_TI1 
      1.830248e+14       5.408850e+14       2.038744e-15       4.102638e-15 
  Periods.2to2_TI1   Periods.3to3_TI1   Periods.4to4_TI1   Periods.5to5_TI1 
      5.644245e-15       1.000001e+00       1.646367e-15       3.270332e-15 
  Periods.6to6_TI1   Periods.7to7_TI1  Periods.8to11_TI1 Periods.12to15_TI1 
      1.486411e-16       2.648109e-15       3.026786e-17       8.738800e-15 
[1] "Should all be very small: "
 [1] 3.628268e-16 2.387874e-16 1.344854e-16 1.344854e-16 1.344854e-16
 [6] 1.344854e-16 1.449570e-16 1.619186e-16 1.619186e-16 1.619186e-16
[11] 1.619186e-16 1.619186e-16 1.619186e-16 1.619186e-16 1.619186e-16
[16] 1.619186e-16
[1] "Should all be very small: "
 [1] 8.519431e-17 1.505626e-17 1.044968e-16 4.951408e-07 4.823035e-07
 [6] 4.749798e-07 4.737188e-07 4.645200e-07 4.601013e-07 4.557247e-07
[11] 4.513896e-07 4.470959e-07 4.328058e-07 4.189726e-07 4.055814e-07
[16] 3.926183e-07
> survMSM_res$St
$TI0
 [1] 0.9957857 0.9827720 0.9653188 0.9653188 0.9653188 0.9653188 0.9641698
 [8] 0.9625935 0.9625935 0.9625935 0.9625935 0.9625935 0.9625935 0.9625935
[15] 0.9625935 0.9625935

$TI1
 [1] 0.9564462 0.9403990 0.9250282 0.9250277 0.9010449 0.8873627 0.8850068
 [8] 0.8678217 0.8595666 0.8513901 0.8432913 0.8352696 0.8085728 0.7827293
[15] 0.7577119 0.7334940

> 
> # ----------------------------------------------------------------------
> # Sequential G-COMP
> # ----------------------------------------------------------------------
> t.surv <- c(0:15)
> Qforms <- rep.int("Q.kplus1 ~ CVD + highA1c + N + lastNat1 + TI + TI.tminus1", (max(t.surv)+1))
> params = list(fit.package = "speedglm", fit.algorithm = "glm")
> 
> ## Not run: 
> ##D gcomp_est <- fitSeqGcomp(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D                           Qforms = Qforms, params_Q = params, stratifyQ_by_rule = FALSE)
> ##D gcomp_est[]
> ## End(Not run)
> # ----------------------------------------------------------------------
> # TMLE
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D tmle_est <- fitTMLE(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D                     Qforms = Qforms, params_Q = params, stratifyQ_by_rule = TRUE)
> ##D tmle_est[]
> ## End(Not run)
> 
> # ----------------------------------------------------------------------
> # Running IPW-Adjusted KM with optional user-specified weights:
> # ----------------------------------------------------------------------
> addedWts_DT <- OdataDT[, c("ID", "t"), with = FALSE]
> addedWts_DT[, new.wts := sample.int(10, nrow(OdataDT), replace = TRUE)/10]
> survNP_res_addedWts <- survNPMSM(wts.DT.1, OData, weights = addedWts_DT)
> 
> # ----------------------------------------------------------------------
> # Multivariate Propensity Score Regressions
> # ----------------------------------------------------------------------
> gform_CENS <- "C + TI + N ~ highA1c + lastNat1"
> OData <- fitPropensity(OData, gform_CENS = gform_CENS, gform_TRT = gform_TRT,
+                         gform_MONITOR = gform_MONITOR)
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "gC" "gA" "gN"
[1] "Outcomes: "
[1] ""
[1] "No. of regressions: 3"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "C,TI,N"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: C, TI, N"
[1] "Predictors: highA1c, lastNat1"
[1] "No. of regressions: 3"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(C|highA1c, lastNat1);\\ Stratify: "
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|C, highA1c, lastNat1);\\ Stratify: C == 0"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(N|C, TI, highA1c, lastNat1);\\ Stratify: C == 0 & TI == 0"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: CVD, highA1c, N.tminus1"
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "N"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: N"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(N|);\\ Stratify: "
[1] "fitting the model: P(C|highA1c, lastNat1);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
    Intercept       highA1c      lastNat1 
-2.656607e+01  9.238692e-12  2.688942e-12 
[1] "fitting the model: P(TI|C, highA1c, lastNat1);\\ Stratify: C == 0"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
  Intercept           C     highA1c    lastNat1 
 0.87385792          NA -0.18986136 -0.06706656 
[1] "fitting the model: P(N|C, TI, highA1c, lastNat1);\\ Stratify: C == 0 & TI == 0"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
   Intercept            C           TI      highA1c     lastNat1 
-0.025688525           NA           NA  0.001591313 -0.012014026 
[1] "fitting the model: P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
 Intercept        CVD    highA1c  N.tminus1 
 0.6250400  1.3852271 -0.1432429  0.1288901 
[1] "fitting the model: P(N|);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
  Intercept 
-0.01358231 
> 
> # ----------------------------------------------------------------------
> # Fitting Propensity scores with Random Forests:
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "randomForest")
> ##D require("h2o")
> ##D h2o::h2o.init(nthreads = -1)
> ##D gform_CENS <- "C ~ highA1c + lastNat1"
> ##D OData <- fitPropensity(OData, gform_CENS = gform_CENS,
> ##D                         gform_TRT = gform_TRT,
> ##D                         gform_MONITOR = gform_MONITOR,
> ##D                         stratify_CENS = stratify_CENS)
> ##D 
> ##D # For Gradient Boosting machines:
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "gbm")
> ##D # Use `H2O-3` distributed implementation of GLM
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "glm")
> ##D # Use Deep Neural Nets:
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "deeplearning")
> ## End(Not run)
> 
> # ----------------------------------------------------------------------
> # Fitting different models with different algorithms
> # Fine tuning modeling with optional tuning parameters.
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D params_TRT = list(fit.package = "h2o", fit.algorithm = "gbm", ntrees = 50,
> ##D     learn_rate = 0.05, sample_rate = 0.8, col_sample_rate = 0.8,
> ##D     balance_classes = TRUE)
> ##D params_CENS = list(fit.package = "speedglm", fit.algorithm = "glm")
> ##D params_MONITOR = list(fit.package = "speedglm", fit.algorithm = "glm")
> ##D OData <- fitPropensity(OData,
> ##D             gform_CENS = gform_CENS, stratify_CENS = stratify_CENS, params_CENS = params_CENS,
> ##D             gform_TRT = gform_TRT, params_TRT = params_TRT,
> ##D             gform_MONITOR = gform_MONITOR, params_MONITOR = params_MONITOR)
> ## End(Not run)
> 
> # ----------------------------------------------------------------------
> # Running TMLE based on the previous fit of the propensity scores.
> # Also applying Random Forest to estimate the sequential outcome model
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D t.surv <- c(0:5)
> ##D Qforms <- rep.int("Q.kplus1 ~ CVD + highA1c + N + lastNat1 + TI + TI.tminus1", (max(t.surv)+1))
> ##D params_Q = list(fit.package = "h2o", fit.algorithm = "randomForest",
> ##D                 ntrees = 100, learn_rate = 0.05, sample_rate = 0.8,
> ##D                 col_sample_rate = 0.8, balance_classes = TRUE)
> ##D tmle_est <- fitTMLE(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D             Qforms = Qforms, params_Q = params_Q,
> ##D             stratifyQ_by_rule = TRUE)
> ## End(Not run)
> 
> ## Not run: 
> ##D t.surv <- c(0:5)
> ##D Qforms <- rep.int("Q.kplus1 ~ CVD + highA1c + N + lastNat1 + TI + TI.tminus1", (max(t.surv)+1))
> ##D params_Q = list(fit.package = "h2o", fit.algorithm = "randomForest",
> ##D                 ntrees = 100, learn_rate = 0.05, sample_rate = 0.8,
> ##D                 col_sample_rate = 0.8, balance_classes = TRUE)
> ##D tmle_est <- fitTMLE(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D             Qforms = Qforms, params_Q = params_Q,
> ##D             stratifyQ_by_rule = FALSE)
> ## End(Not run)
> 
> 
> 
> 
> cleanEx()

detaching ‘package:magrittr’, ‘package:data.table’

> nameEx("fitTMLE")
> ### * fitTMLE
> 
> flush(stderr()); flush(stdout())
> 
> ### Name: fitTMLE
> ### Title: TMLE wrapper for 'fitSeqGcomp'
> ### Aliases: fitTMLE
> 
> ### ** Examples
> 
> options(stremr.verbose = TRUE)
> require("data.table")
Loading required package: data.table
> set_all_stremr_options(fit.package = "speedglm", fit.algorithm = "glm")
> 
> # ----------------------------------------------------------------------
> # Simulated Data
> # ----------------------------------------------------------------------
> data(OdataNoCENS)
> OdataDT <- as.data.table(OdataNoCENS, key=c(ID, t))
> 
> # define lagged N, first value is always 1 (always monitored at the first time point):
> OdataDT[, ("N.tminus1") := shift(get("N"), n = 1L, type = "lag", fill = 1L), by = ID]
> OdataDT[, ("TI.tminus1") := shift(get("TI"), n = 1L, type = "lag", fill = 1L), by = ID]
> 
> # ----------------------------------------------------------------------
> # Define intervention (always treated):
> # ----------------------------------------------------------------------
> OdataDT[, ("TI.set1") := 1L]
> OdataDT[, ("TI.set0") := 0L]
> 
> # ----------------------------------------------------------------------
> # Import Data
> # ----------------------------------------------------------------------
> OData <- importData(OdataDT, ID = "ID", t = "t", covars = c("highA1c", "lastNat1", "N.tminus1"),
+                     CENS = "C", TRT = "TI", MONITOR = "N", OUTCOME = "Y.tplus1")
[1] "Using the following stremr options/settings: "

List of 8
 $ fit.package       : chr "speedglm"
 $ fit.algorithm     : chr "glm"
 $ bin.method        : chr "equal.mass"
 $ nbins             : num 10
 $ maxncats          : num 20
 $ maxNperBin        : num 500
 $ lower_bound_zero_Q: logi TRUE
 $ skip_update_zero_Q: logi TRUE 
[1] "...detecting the type of each input column..."
> 
> # ----------------------------------------------------------------------
> # Model the Propensity Scores
> # ----------------------------------------------------------------------
> gform_CENS <- "C ~ highA1c + lastNat1"
> gform_TRT = "TI ~ CVD + highA1c + N.tminus1"
> gform_MONITOR <- "N ~ 1"
> stratify_CENS <- list(C=c("t < 16", "t == 16"))
> 
> # ----------------------------------------------------------------------
> # Fit Propensity Scores
> # ----------------------------------------------------------------------
> OData <- fitPropensity(OData, gform_CENS = gform_CENS,
+                         gform_TRT = gform_TRT,
+                         gform_MONITOR = gform_MONITOR,
+                         stratify_CENS = stratify_CENS)
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "gC" "gA" "gN"
[1] "Outcomes: "
[1] ""
[1] "No. of regressions: 3"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "C"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: C"
[1] "Predictors: highA1c, lastNat1"
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "StratifiedModel outcome: C"
[1] "StratifiedModel expressions: (t < 16,t == 16)"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: C, C"
[1] "Predictors: highA1c, lastNat1"
[1] "No. of regressions: 2"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(C|highA1c, lastNat1);\\ Stratify: t < 16"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(C|highA1c, lastNat1);\\ Stratify: t == 16"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: CVD, highA1c, N.tminus1"
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "N"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: N"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(N|);\\ Stratify: "
[1] "performing fitting for outcome based on stratified model for outcome: C"
[1] "fitting the model: P(C|highA1c, lastNat1);\\ Stratify: t < 16"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
    Intercept       highA1c      lastNat1 
-2.656607e+01  8.128911e-12  5.225396e-12 
[1] "fitting the model: P(C|highA1c, lastNat1);\\ Stratify: t == 16"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
    Intercept       highA1c      lastNat1 
-2.656607e+01 -5.129323e-13 -3.008816e-13 
fit for C var succeeded...
[1] "fitting the model: P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
 Intercept        CVD    highA1c  N.tminus1 
 0.6250400  1.3852271 -0.1432429  0.1288901 
[1] "fitting the model: P(N|);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
  Intercept 
-0.01358231 
[1] "performing prediction for outcome based on stratified model: C"
> 
> # ----------------------------------------------------------------------
> # IPW Ajusted KM or Saturated MSM
> # ----------------------------------------------------------------------
> require("magrittr")
Loading required package: magrittr
> AKME.St.1 <- getIPWeights(OData, intervened_TRT = "TI.set1") %>%
+              survNPMSM(OData) %$%
+              IPW_estimates
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> AKME.St.1
    t  sum_Y_IPAW sum_all_IPAW          ht   St.IPTW       ht.KM     St.KM
1   0   1.6610718     38.13840 0.043553792 0.9564462 0.047337278 0.9526627
2   1   0.8070748     48.10323 0.016777974 0.9403990 0.018633540 0.9349112
3   2   1.0721508     65.59519 0.016344959 0.9250282 0.012658228 0.9230769
4   3   0.0000000     91.16229 0.000000000 0.9250282 0.000000000 0.9230769
5   4   3.4232039    132.03450 0.025926586 0.9010454 0.025641026 0.8994083
6   5   2.7647724    182.07477 0.015184819 0.8873632 0.026315789 0.8757396
7   6   0.6840395    257.65098 0.002654907 0.8850073 0.013513514 0.8639053
8   7   7.2912160    375.48517 0.019418120 0.8678221 0.013698630 0.8520710
9   8  11.8316412    540.78252 0.021878742 0.8488353 0.034722222 0.8224852
10  9   7.8472558    766.65939 0.010235648 0.8401469 0.007194245 0.8165680
11 10   0.0000000   1131.74617 0.000000000 0.8401469 0.000000000 0.8165680
12 11  19.6818394   1698.64910 0.011586760 0.8304123 0.014492754 0.8047337
13 12 112.5585923   2500.60892 0.045012473 0.7930334 0.044117647 0.7692308
14 13  76.8430786   3426.37023 0.022426963 0.7752481 0.015384615 0.7573964
15 14   0.0000000   4968.01401 0.000000000 0.7752481 0.000000000 0.7573964
16 15 398.1827812   7488.93955 0.053169448 0.7340285 0.046875000 0.7218935
17 16   0.0000000  10147.78922 0.000000000 0.7340285 0.000000000 0.7218935
   rule.name
1    TI.set1
2    TI.set1
3    TI.set1
4    TI.set1
5    TI.set1
6    TI.set1
7    TI.set1
8    TI.set1
9    TI.set1
10   TI.set1
11   TI.set1
12   TI.set1
13   TI.set1
14   TI.set1
15   TI.set1
16   TI.set1
17   TI.set1
> 
> # ----------------------------------------------------------------------
> # Bounded IPW
> # ----------------------------------------------------------------------
> IPW.St.1 <- getIPWeights(OData, intervened_TRT = "TI.set1") %>%
+              survDirectIPW(OData)
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> IPW.St.1[]
            est_name  t  sum_Y_IPAW   sum_IPAW       risk     S.t.n
 1: DirectBoundedIPW  0    9.828827   225.6710 0.04355379 0.9564462
 2: DirectBoundedIPW  1   14.841714   308.6067 0.04809266 0.9519073
 3: DirectBoundedIPW  2   21.627479   430.0012 0.05029632 0.9497037
 4: DirectBoundedIPW  3   21.627479   606.0012 0.03568884 0.9643112
 5: DirectBoundedIPW  4   43.571094   868.0025 0.05019697 0.9498030
 6: DirectBoundedIPW  5   61.760385  1241.4314 0.04974933 0.9502507
 7: DirectBoundedIPW  6   66.382274  1802.6454 0.03682492 0.9631751
 8: DirectBoundedIPW  7  116.322109  2638.1985 0.04409149 0.9559085
 9: DirectBoundedIPW  8  198.486284  3871.7562 0.05126518 0.9487348
10: DirectBoundedIPW  9  254.941362  5714.0214 0.04461680 0.9553832
11: DirectBoundedIPW 10  254.941362  8456.0006 0.03014917 0.9698508
12: DirectBoundedIPW 11  397.563386 12563.9928 0.03164308 0.9683569
13: DirectBoundedIPW 12 1225.200094 18784.3937 0.06522436 0.9347756
14: DirectBoundedIPW 13 1816.300699 27581.8941 0.06585120 0.9341488
15: DirectBoundedIPW 14 1816.300699 40628.9102 0.04470464 0.9552954
16: DirectBoundedIPW 15 4927.103677 60323.6409 0.08167782 0.9183222
> 
> # ----------------------------------------------------------------------
> # IPW-MSM for hazard
> # ----------------------------------------------------------------------
> wts.DT.1 <- getIPWeights(OData = OData, intervened_TRT = "TI.set1", rule_name = "TI1")
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> wts.DT.0 <- getIPWeights(OData = OData, intervened_TRT = "TI.set0", rule_name = "TI0")
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> survMSM_res <- survMSM(list(wts.DT.1, wts.DT.0), OData, t_breaks = c(1:8,12,16)-1,)
[1] "performing estimation for the following TRT/MONITOR rules found in column 'rule.name': TI0,TI1"
[1] "periods"
 [1]  0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15
[1] "defined t.dummy: Periods.0to0"
[1] "defined t.dummy: Periods.1to1"
[1] "defined t.dummy: Periods.2to2"
[1] "defined t.dummy: Periods.3to3"
[1] "defined t.dummy: Periods.4to4"
[1] "defined t.dummy: Periods.5to5"
[1] "defined t.dummy: Periods.6to6"
[1] "defined t.dummy: Periods.7to7"
[1] "defined t.dummy: Periods.8to11"
[1] "defined t.dummy: Periods.12to15"
[1] "Periods.0to0_TI0"
[1] "Periods.1to1_TI0"
[1] "Periods.2to2_TI0"
[1] "Periods.3to3_TI0"
[1] "Periods.4to4_TI0"
[1] "Periods.5to5_TI0"
[1] "Periods.6to6_TI0"
[1] "Periods.7to7_TI0"
[1] "Periods.8to11_TI0"
[1] "Periods.12to15_TI0"
[1] "Periods.0to0_TI1"
[1] "Periods.1to1_TI1"
[1] "Periods.2to2_TI1"
[1] "Periods.3to3_TI1"
[1] "Periods.4to4_TI1"
[1] "Periods.5to5_TI1"
[1] "Periods.6to6_TI1"
[1] "Periods.7to7_TI1"
[1] "Periods.8to11_TI1"
[1] "Periods.12to15_TI1"
...fitting hazard MSM with speedglm::speedglm.wfit...
[1] "MSM fits"
  Periods.0to0_TI0   Periods.1to1_TI0   Periods.2to2_TI0   Periods.3to3_TI0 
     -5.465039e+00      -4.324378e+00      -4.012934e+00      -1.166619e+15 
  Periods.4to4_TI0   Periods.5to5_TI0   Periods.6to6_TI0   Periods.7to7_TI0 
     -6.871355e+14      -4.884654e+14      -6.732368e+00      -6.414551e+00 
 Periods.8to11_TI0 Periods.12to15_TI0   Periods.0to0_TI1   Periods.1to1_TI1 
     -2.490327e+15      -3.057464e+15      -3.089228e+00      -4.070768e+00 
  Periods.2to2_TI1   Periods.3to3_TI1   Periods.4to4_TI1   Periods.5to5_TI1 
     -4.097356e+00      -1.444049e+01      -3.626218e+00      -4.172158e+00 
  Periods.6to6_TI1   Periods.7to7_TI1  Periods.8to11_TI1 Periods.12to15_TI1 
     -5.928687e+00      -3.921940e+00      -4.645602e+00      -3.410729e+00 
...evaluating MSM-based survival curves...
...evaluating SEs based on MSM hazard fit and the estimated IC...
[1] "Should all be very small: "
  Periods.0to0_TI0   Periods.1to1_TI0   Periods.2to2_TI0   Periods.3to3_TI0 
      8.745296e-16       4.214695e-15       8.819608e-15       7.293270e+00 
  Periods.4to4_TI0   Periods.5to5_TI0   Periods.6to6_TI0   Periods.7to7_TI0 
      6.561300e+01       4.445403e+02       5.648100e-14       5.676302e-14 
 Periods.8to11_TI0 Periods.12to15_TI0   Periods.0to0_TI1   Periods.1to1_TI1 
      2.030033e+02       7.899748e+02       3.196367e-18       3.295818e-18 
  Periods.2to2_TI1   Periods.3to3_TI1   Periods.4to4_TI1   Periods.5to5_TI1 
      5.938153e-18       4.879654e-08       5.552308e-18       8.758887e-18 
  Periods.6to6_TI1   Periods.7to7_TI1  Periods.8to11_TI1 Periods.12to15_TI1 
      9.627973e-20       1.899923e-17       1.180759e-18       4.982015e-15 
[1] "Should all be very small: "
  Periods.0to0_TI0   Periods.1to1_TI0   Periods.2to2_TI0   Periods.3to3_TI0 
      8.645048e-14       4.643372e-14       2.150078e-14       3.336980e+14 
  Periods.4to4_TI0   Periods.5to5_TI0   Periods.6to6_TI0   Periods.7to7_TI0 
      7.563694e+14       1.183848e+15       9.715875e-15       1.095287e-14 
 Periods.8to11_TI0 Periods.12to15_TI0   Periods.0to0_TI1   Periods.1to1_TI1 
      1.830248e+14       5.408850e+14       2.038744e-15       4.102638e-15 
  Periods.2to2_TI1   Periods.3to3_TI1   Periods.4to4_TI1   Periods.5to5_TI1 
      5.644245e-15       1.000001e+00       1.646367e-15       3.270332e-15 
  Periods.6to6_TI1   Periods.7to7_TI1  Periods.8to11_TI1 Periods.12to15_TI1 
      1.486411e-16       2.648109e-15       3.026786e-17       8.738800e-15 
[1] "Should all be very small: "
 [1] 3.628268e-16 2.387874e-16 1.344854e-16 1.344854e-16 1.344854e-16
 [6] 1.344854e-16 1.449570e-16 1.619186e-16 1.619186e-16 1.619186e-16
[11] 1.619186e-16 1.619186e-16 1.619186e-16 1.619186e-16 1.619186e-16
[16] 1.619186e-16
[1] "Should all be very small: "
 [1] 8.519431e-17 1.505626e-17 1.044968e-16 4.951408e-07 4.823035e-07
 [6] 4.749798e-07 4.737188e-07 4.645200e-07 4.601013e-07 4.557247e-07
[11] 4.513896e-07 4.470959e-07 4.328058e-07 4.189726e-07 4.055814e-07
[16] 3.926183e-07
> survMSM_res$St
$TI0
 [1] 0.9957857 0.9827720 0.9653188 0.9653188 0.9653188 0.9653188 0.9641698
 [8] 0.9625935 0.9625935 0.9625935 0.9625935 0.9625935 0.9625935 0.9625935
[15] 0.9625935 0.9625935

$TI1
 [1] 0.9564462 0.9403990 0.9250282 0.9250277 0.9010449 0.8873627 0.8850068
 [8] 0.8678217 0.8595666 0.8513901 0.8432913 0.8352696 0.8085728 0.7827293
[15] 0.7577119 0.7334940

> 
> # ----------------------------------------------------------------------
> # Sequential G-COMP
> # ----------------------------------------------------------------------
> t.surv <- c(0:15)
> Qforms <- rep.int("Q.kplus1 ~ CVD + highA1c + N + lastNat1 + TI + TI.tminus1", (max(t.surv)+1))
> params = list(fit.package = "speedglm", fit.algorithm = "glm")
> 
> ## Not run: 
> ##D gcomp_est <- fitSeqGcomp(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D                           Qforms = Qforms, params_Q = params, stratifyQ_by_rule = FALSE)
> ##D gcomp_est[]
> ## End(Not run)
> # ----------------------------------------------------------------------
> # TMLE
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D tmle_est <- fitTMLE(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D                     Qforms = Qforms, params_Q = params, stratifyQ_by_rule = TRUE)
> ##D tmle_est[]
> ## End(Not run)
> 
> # ----------------------------------------------------------------------
> # Running IPW-Adjusted KM with optional user-specified weights:
> # ----------------------------------------------------------------------
> addedWts_DT <- OdataDT[, c("ID", "t"), with = FALSE]
> addedWts_DT[, new.wts := sample.int(10, nrow(OdataDT), replace = TRUE)/10]
> survNP_res_addedWts <- survNPMSM(wts.DT.1, OData, weights = addedWts_DT)
> 
> # ----------------------------------------------------------------------
> # Multivariate Propensity Score Regressions
> # ----------------------------------------------------------------------
> gform_CENS <- "C + TI + N ~ highA1c + lastNat1"
> OData <- fitPropensity(OData, gform_CENS = gform_CENS, gform_TRT = gform_TRT,
+                         gform_MONITOR = gform_MONITOR)
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "gC" "gA" "gN"
[1] "Outcomes: "
[1] ""
[1] "No. of regressions: 3"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "C,TI,N"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: C, TI, N"
[1] "Predictors: highA1c, lastNat1"
[1] "No. of regressions: 3"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(C|highA1c, lastNat1);\\ Stratify: "
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|C, highA1c, lastNat1);\\ Stratify: C == 0"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(N|C, TI, highA1c, lastNat1);\\ Stratify: C == 0 & TI == 0"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: CVD, highA1c, N.tminus1"
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "N"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: N"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(N|);\\ Stratify: "
[1] "fitting the model: P(C|highA1c, lastNat1);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
    Intercept       highA1c      lastNat1 
-2.656607e+01  9.238692e-12  2.688942e-12 
[1] "fitting the model: P(TI|C, highA1c, lastNat1);\\ Stratify: C == 0"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
  Intercept           C     highA1c    lastNat1 
 0.87385792          NA -0.18986136 -0.06706656 
[1] "fitting the model: P(N|C, TI, highA1c, lastNat1);\\ Stratify: C == 0 & TI == 0"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
   Intercept            C           TI      highA1c     lastNat1 
-0.025688525           NA           NA  0.001591313 -0.012014026 
[1] "fitting the model: P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
 Intercept        CVD    highA1c  N.tminus1 
 0.6250400  1.3852271 -0.1432429  0.1288901 
[1] "fitting the model: P(N|);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
  Intercept 
-0.01358231 
> 
> # ----------------------------------------------------------------------
> # Fitting Propensity scores with Random Forests:
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "randomForest")
> ##D require("h2o")
> ##D h2o::h2o.init(nthreads = -1)
> ##D gform_CENS <- "C ~ highA1c + lastNat1"
> ##D OData <- fitPropensity(OData, gform_CENS = gform_CENS,
> ##D                         gform_TRT = gform_TRT,
> ##D                         gform_MONITOR = gform_MONITOR,
> ##D                         stratify_CENS = stratify_CENS)
> ##D 
> ##D # For Gradient Boosting machines:
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "gbm")
> ##D # Use `H2O-3` distributed implementation of GLM
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "glm")
> ##D # Use Deep Neural Nets:
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "deeplearning")
> ## End(Not run)
> 
> # ----------------------------------------------------------------------
> # Fitting different models with different algorithms
> # Fine tuning modeling with optional tuning parameters.
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D params_TRT = list(fit.package = "h2o", fit.algorithm = "gbm", ntrees = 50,
> ##D     learn_rate = 0.05, sample_rate = 0.8, col_sample_rate = 0.8,
> ##D     balance_classes = TRUE)
> ##D params_CENS = list(fit.package = "speedglm", fit.algorithm = "glm")
> ##D params_MONITOR = list(fit.package = "speedglm", fit.algorithm = "glm")
> ##D OData <- fitPropensity(OData,
> ##D             gform_CENS = gform_CENS, stratify_CENS = stratify_CENS, params_CENS = params_CENS,
> ##D             gform_TRT = gform_TRT, params_TRT = params_TRT,
> ##D             gform_MONITOR = gform_MONITOR, params_MONITOR = params_MONITOR)
> ## End(Not run)
> 
> # ----------------------------------------------------------------------
> # Running TMLE based on the previous fit of the propensity scores.
> # Also applying Random Forest to estimate the sequential outcome model
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D t.surv <- c(0:5)
> ##D Qforms <- rep.int("Q.kplus1 ~ CVD + highA1c + N + lastNat1 + TI + TI.tminus1", (max(t.surv)+1))
> ##D params_Q = list(fit.package = "h2o", fit.algorithm = "randomForest",
> ##D                 ntrees = 100, learn_rate = 0.05, sample_rate = 0.8,
> ##D                 col_sample_rate = 0.8, balance_classes = TRUE)
> ##D tmle_est <- fitTMLE(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D             Qforms = Qforms, params_Q = params_Q,
> ##D             stratifyQ_by_rule = TRUE)
> ## End(Not run)
> 
> ## Not run: 
> ##D t.surv <- c(0:5)
> ##D Qforms <- rep.int("Q.kplus1 ~ CVD + highA1c + N + lastNat1 + TI + TI.tminus1", (max(t.surv)+1))
> ##D params_Q = list(fit.package = "h2o", fit.algorithm = "randomForest",
> ##D                 ntrees = 100, learn_rate = 0.05, sample_rate = 0.8,
> ##D                 col_sample_rate = 0.8, balance_classes = TRUE)
> ##D tmle_est <- fitTMLE(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D             Qforms = Qforms, params_Q = params_Q,
> ##D             stratifyQ_by_rule = FALSE)
> ## End(Not run)
> 
> 
> 
> 
> cleanEx()

detaching ‘package:magrittr’, ‘package:data.table’

> nameEx("getIPWeights")
> ### * getIPWeights
> 
> flush(stderr()); flush(stdout())
> 
> ### Name: getIPWeights
> ### Title: Inverse Probability Weights.
> ### Aliases: getIPWeights
> 
> ### ** Examples
> 
> options(stremr.verbose = TRUE)
> require("data.table")
Loading required package: data.table
> set_all_stremr_options(fit.package = "speedglm", fit.algorithm = "glm")
> 
> # ----------------------------------------------------------------------
> # Simulated Data
> # ----------------------------------------------------------------------
> data(OdataNoCENS)
> OdataDT <- as.data.table(OdataNoCENS, key=c(ID, t))
> 
> # define lagged N, first value is always 1 (always monitored at the first time point):
> OdataDT[, ("N.tminus1") := shift(get("N"), n = 1L, type = "lag", fill = 1L), by = ID]
> OdataDT[, ("TI.tminus1") := shift(get("TI"), n = 1L, type = "lag", fill = 1L), by = ID]
> 
> # ----------------------------------------------------------------------
> # Define intervention (always treated):
> # ----------------------------------------------------------------------
> OdataDT[, ("TI.set1") := 1L]
> OdataDT[, ("TI.set0") := 0L]
> 
> # ----------------------------------------------------------------------
> # Import Data
> # ----------------------------------------------------------------------
> OData <- importData(OdataDT, ID = "ID", t = "t", covars = c("highA1c", "lastNat1", "N.tminus1"),
+                     CENS = "C", TRT = "TI", MONITOR = "N", OUTCOME = "Y.tplus1")
[1] "Using the following stremr options/settings: "

List of 8
 $ fit.package       : chr "speedglm"
 $ fit.algorithm     : chr "glm"
 $ bin.method        : chr "equal.mass"
 $ nbins             : num 10
 $ maxncats          : num 20
 $ maxNperBin        : num 500
 $ lower_bound_zero_Q: logi TRUE
 $ skip_update_zero_Q: logi TRUE 
[1] "...detecting the type of each input column..."
> 
> # ----------------------------------------------------------------------
> # Model the Propensity Scores
> # ----------------------------------------------------------------------
> gform_CENS <- "C ~ highA1c + lastNat1"
> gform_TRT = "TI ~ CVD + highA1c + N.tminus1"
> gform_MONITOR <- "N ~ 1"
> stratify_CENS <- list(C=c("t < 16", "t == 16"))
> 
> # ----------------------------------------------------------------------
> # Fit Propensity Scores
> # ----------------------------------------------------------------------
> OData <- fitPropensity(OData, gform_CENS = gform_CENS,
+                         gform_TRT = gform_TRT,
+                         gform_MONITOR = gform_MONITOR,
+                         stratify_CENS = stratify_CENS)
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "gC" "gA" "gN"
[1] "Outcomes: "
[1] ""
[1] "No. of regressions: 3"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "C"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: C"
[1] "Predictors: highA1c, lastNat1"
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "StratifiedModel outcome: C"
[1] "StratifiedModel expressions: (t < 16,t == 16)"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: C, C"
[1] "Predictors: highA1c, lastNat1"
[1] "No. of regressions: 2"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(C|highA1c, lastNat1);\\ Stratify: t < 16"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(C|highA1c, lastNat1);\\ Stratify: t == 16"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: CVD, highA1c, N.tminus1"
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "N"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: N"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(N|);\\ Stratify: "
[1] "performing fitting for outcome based on stratified model for outcome: C"
[1] "fitting the model: P(C|highA1c, lastNat1);\\ Stratify: t < 16"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
    Intercept       highA1c      lastNat1 
-2.656607e+01  8.128911e-12  5.225396e-12 
[1] "fitting the model: P(C|highA1c, lastNat1);\\ Stratify: t == 16"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
    Intercept       highA1c      lastNat1 
-2.656607e+01 -5.129323e-13 -3.008816e-13 
fit for C var succeeded...
[1] "fitting the model: P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
 Intercept        CVD    highA1c  N.tminus1 
 0.6250400  1.3852271 -0.1432429  0.1288901 
[1] "fitting the model: P(N|);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
  Intercept 
-0.01358231 
[1] "performing prediction for outcome based on stratified model: C"
> 
> # ----------------------------------------------------------------------
> # IPW Ajusted KM or Saturated MSM
> # ----------------------------------------------------------------------
> require("magrittr")
Loading required package: magrittr
> AKME.St.1 <- getIPWeights(OData, intervened_TRT = "TI.set1") %>%
+              survNPMSM(OData) %$%
+              IPW_estimates
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> AKME.St.1
    t  sum_Y_IPAW sum_all_IPAW          ht   St.IPTW       ht.KM     St.KM
1   0   1.6610718     38.13840 0.043553792 0.9564462 0.047337278 0.9526627
2   1   0.8070748     48.10323 0.016777974 0.9403990 0.018633540 0.9349112
3   2   1.0721508     65.59519 0.016344959 0.9250282 0.012658228 0.9230769
4   3   0.0000000     91.16229 0.000000000 0.9250282 0.000000000 0.9230769
5   4   3.4232039    132.03450 0.025926586 0.9010454 0.025641026 0.8994083
6   5   2.7647724    182.07477 0.015184819 0.8873632 0.026315789 0.8757396
7   6   0.6840395    257.65098 0.002654907 0.8850073 0.013513514 0.8639053
8   7   7.2912160    375.48517 0.019418120 0.8678221 0.013698630 0.8520710
9   8  11.8316412    540.78252 0.021878742 0.8488353 0.034722222 0.8224852
10  9   7.8472558    766.65939 0.010235648 0.8401469 0.007194245 0.8165680
11 10   0.0000000   1131.74617 0.000000000 0.8401469 0.000000000 0.8165680
12 11  19.6818394   1698.64910 0.011586760 0.8304123 0.014492754 0.8047337
13 12 112.5585923   2500.60892 0.045012473 0.7930334 0.044117647 0.7692308
14 13  76.8430786   3426.37023 0.022426963 0.7752481 0.015384615 0.7573964
15 14   0.0000000   4968.01401 0.000000000 0.7752481 0.000000000 0.7573964
16 15 398.1827812   7488.93955 0.053169448 0.7340285 0.046875000 0.7218935
17 16   0.0000000  10147.78922 0.000000000 0.7340285 0.000000000 0.7218935
   rule.name
1    TI.set1
2    TI.set1
3    TI.set1
4    TI.set1
5    TI.set1
6    TI.set1
7    TI.set1
8    TI.set1
9    TI.set1
10   TI.set1
11   TI.set1
12   TI.set1
13   TI.set1
14   TI.set1
15   TI.set1
16   TI.set1
17   TI.set1
> 
> # ----------------------------------------------------------------------
> # Bounded IPW
> # ----------------------------------------------------------------------
> IPW.St.1 <- getIPWeights(OData, intervened_TRT = "TI.set1") %>%
+              survDirectIPW(OData)
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> IPW.St.1[]
            est_name  t  sum_Y_IPAW   sum_IPAW       risk     S.t.n
 1: DirectBoundedIPW  0    9.828827   225.6710 0.04355379 0.9564462
 2: DirectBoundedIPW  1   14.841714   308.6067 0.04809266 0.9519073
 3: DirectBoundedIPW  2   21.627479   430.0012 0.05029632 0.9497037
 4: DirectBoundedIPW  3   21.627479   606.0012 0.03568884 0.9643112
 5: DirectBoundedIPW  4   43.571094   868.0025 0.05019697 0.9498030
 6: DirectBoundedIPW  5   61.760385  1241.4314 0.04974933 0.9502507
 7: DirectBoundedIPW  6   66.382274  1802.6454 0.03682492 0.9631751
 8: DirectBoundedIPW  7  116.322109  2638.1985 0.04409149 0.9559085
 9: DirectBoundedIPW  8  198.486284  3871.7562 0.05126518 0.9487348
10: DirectBoundedIPW  9  254.941362  5714.0214 0.04461680 0.9553832
11: DirectBoundedIPW 10  254.941362  8456.0006 0.03014917 0.9698508
12: DirectBoundedIPW 11  397.563386 12563.9928 0.03164308 0.9683569
13: DirectBoundedIPW 12 1225.200094 18784.3937 0.06522436 0.9347756
14: DirectBoundedIPW 13 1816.300699 27581.8941 0.06585120 0.9341488
15: DirectBoundedIPW 14 1816.300699 40628.9102 0.04470464 0.9552954
16: DirectBoundedIPW 15 4927.103677 60323.6409 0.08167782 0.9183222
> 
> # ----------------------------------------------------------------------
> # IPW-MSM for hazard
> # ----------------------------------------------------------------------
> wts.DT.1 <- getIPWeights(OData = OData, intervened_TRT = "TI.set1", rule_name = "TI1")
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> wts.DT.0 <- getIPWeights(OData = OData, intervened_TRT = "TI.set0", rule_name = "TI0")
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> survMSM_res <- survMSM(list(wts.DT.1, wts.DT.0), OData, t_breaks = c(1:8,12,16)-1,)
[1] "performing estimation for the following TRT/MONITOR rules found in column 'rule.name': TI0,TI1"
[1] "periods"
 [1]  0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15
[1] "defined t.dummy: Periods.0to0"
[1] "defined t.dummy: Periods.1to1"
[1] "defined t.dummy: Periods.2to2"
[1] "defined t.dummy: Periods.3to3"
[1] "defined t.dummy: Periods.4to4"
[1] "defined t.dummy: Periods.5to5"
[1] "defined t.dummy: Periods.6to6"
[1] "defined t.dummy: Periods.7to7"
[1] "defined t.dummy: Periods.8to11"
[1] "defined t.dummy: Periods.12to15"
[1] "Periods.0to0_TI0"
[1] "Periods.1to1_TI0"
[1] "Periods.2to2_TI0"
[1] "Periods.3to3_TI0"
[1] "Periods.4to4_TI0"
[1] "Periods.5to5_TI0"
[1] "Periods.6to6_TI0"
[1] "Periods.7to7_TI0"
[1] "Periods.8to11_TI0"
[1] "Periods.12to15_TI0"
[1] "Periods.0to0_TI1"
[1] "Periods.1to1_TI1"
[1] "Periods.2to2_TI1"
[1] "Periods.3to3_TI1"
[1] "Periods.4to4_TI1"
[1] "Periods.5to5_TI1"
[1] "Periods.6to6_TI1"
[1] "Periods.7to7_TI1"
[1] "Periods.8to11_TI1"
[1] "Periods.12to15_TI1"
...fitting hazard MSM with speedglm::speedglm.wfit...
[1] "MSM fits"
  Periods.0to0_TI0   Periods.1to1_TI0   Periods.2to2_TI0   Periods.3to3_TI0 
     -5.465039e+00      -4.324378e+00      -4.012934e+00      -1.166619e+15 
  Periods.4to4_TI0   Periods.5to5_TI0   Periods.6to6_TI0   Periods.7to7_TI0 
     -6.871355e+14      -4.884654e+14      -6.732368e+00      -6.414551e+00 
 Periods.8to11_TI0 Periods.12to15_TI0   Periods.0to0_TI1   Periods.1to1_TI1 
     -2.490327e+15      -3.057464e+15      -3.089228e+00      -4.070768e+00 
  Periods.2to2_TI1   Periods.3to3_TI1   Periods.4to4_TI1   Periods.5to5_TI1 
     -4.097356e+00      -1.444049e+01      -3.626218e+00      -4.172158e+00 
  Periods.6to6_TI1   Periods.7to7_TI1  Periods.8to11_TI1 Periods.12to15_TI1 
     -5.928687e+00      -3.921940e+00      -4.645602e+00      -3.410729e+00 
...evaluating MSM-based survival curves...
...evaluating SEs based on MSM hazard fit and the estimated IC...
[1] "Should all be very small: "
  Periods.0to0_TI0   Periods.1to1_TI0   Periods.2to2_TI0   Periods.3to3_TI0 
      8.745296e-16       4.214695e-15       8.819608e-15       7.293270e+00 
  Periods.4to4_TI0   Periods.5to5_TI0   Periods.6to6_TI0   Periods.7to7_TI0 
      6.561300e+01       4.445403e+02       5.648100e-14       5.676302e-14 
 Periods.8to11_TI0 Periods.12to15_TI0   Periods.0to0_TI1   Periods.1to1_TI1 
      2.030033e+02       7.899748e+02       3.196367e-18       3.295818e-18 
  Periods.2to2_TI1   Periods.3to3_TI1   Periods.4to4_TI1   Periods.5to5_TI1 
      5.938153e-18       4.879654e-08       5.552308e-18       8.758887e-18 
  Periods.6to6_TI1   Periods.7to7_TI1  Periods.8to11_TI1 Periods.12to15_TI1 
      9.627973e-20       1.899923e-17       1.180759e-18       4.982015e-15 
[1] "Should all be very small: "
  Periods.0to0_TI0   Periods.1to1_TI0   Periods.2to2_TI0   Periods.3to3_TI0 
      8.645048e-14       4.643372e-14       2.150078e-14       3.336980e+14 
  Periods.4to4_TI0   Periods.5to5_TI0   Periods.6to6_TI0   Periods.7to7_TI0 
      7.563694e+14       1.183848e+15       9.715875e-15       1.095287e-14 
 Periods.8to11_TI0 Periods.12to15_TI0   Periods.0to0_TI1   Periods.1to1_TI1 
      1.830248e+14       5.408850e+14       2.038744e-15       4.102638e-15 
  Periods.2to2_TI1   Periods.3to3_TI1   Periods.4to4_TI1   Periods.5to5_TI1 
      5.644245e-15       1.000001e+00       1.646367e-15       3.270332e-15 
  Periods.6to6_TI1   Periods.7to7_TI1  Periods.8to11_TI1 Periods.12to15_TI1 
      1.486411e-16       2.648109e-15       3.026786e-17       8.738800e-15 
[1] "Should all be very small: "
 [1] 3.628268e-16 2.387874e-16 1.344854e-16 1.344854e-16 1.344854e-16
 [6] 1.344854e-16 1.449570e-16 1.619186e-16 1.619186e-16 1.619186e-16
[11] 1.619186e-16 1.619186e-16 1.619186e-16 1.619186e-16 1.619186e-16
[16] 1.619186e-16
[1] "Should all be very small: "
 [1] 8.519431e-17 1.505626e-17 1.044968e-16 4.951408e-07 4.823035e-07
 [6] 4.749798e-07 4.737188e-07 4.645200e-07 4.601013e-07 4.557247e-07
[11] 4.513896e-07 4.470959e-07 4.328058e-07 4.189726e-07 4.055814e-07
[16] 3.926183e-07
> survMSM_res$St
$TI0
 [1] 0.9957857 0.9827720 0.9653188 0.9653188 0.9653188 0.9653188 0.9641698
 [8] 0.9625935 0.9625935 0.9625935 0.9625935 0.9625935 0.9625935 0.9625935
[15] 0.9625935 0.9625935

$TI1
 [1] 0.9564462 0.9403990 0.9250282 0.9250277 0.9010449 0.8873627 0.8850068
 [8] 0.8678217 0.8595666 0.8513901 0.8432913 0.8352696 0.8085728 0.7827293
[15] 0.7577119 0.7334940

> 
> # ----------------------------------------------------------------------
> # Sequential G-COMP
> # ----------------------------------------------------------------------
> t.surv <- c(0:15)
> Qforms <- rep.int("Q.kplus1 ~ CVD + highA1c + N + lastNat1 + TI + TI.tminus1", (max(t.surv)+1))
> params = list(fit.package = "speedglm", fit.algorithm = "glm")
> 
> ## Not run: 
> ##D gcomp_est <- fitSeqGcomp(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D                           Qforms = Qforms, params_Q = params, stratifyQ_by_rule = FALSE)
> ##D gcomp_est[]
> ## End(Not run)
> # ----------------------------------------------------------------------
> # TMLE
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D tmle_est <- fitTMLE(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D                     Qforms = Qforms, params_Q = params, stratifyQ_by_rule = TRUE)
> ##D tmle_est[]
> ## End(Not run)
> 
> # ----------------------------------------------------------------------
> # Running IPW-Adjusted KM with optional user-specified weights:
> # ----------------------------------------------------------------------
> addedWts_DT <- OdataDT[, c("ID", "t"), with = FALSE]
> addedWts_DT[, new.wts := sample.int(10, nrow(OdataDT), replace = TRUE)/10]
> survNP_res_addedWts <- survNPMSM(wts.DT.1, OData, weights = addedWts_DT)
> 
> # ----------------------------------------------------------------------
> # Multivariate Propensity Score Regressions
> # ----------------------------------------------------------------------
> gform_CENS <- "C + TI + N ~ highA1c + lastNat1"
> OData <- fitPropensity(OData, gform_CENS = gform_CENS, gform_TRT = gform_TRT,
+                         gform_MONITOR = gform_MONITOR)
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "gC" "gA" "gN"
[1] "Outcomes: "
[1] ""
[1] "No. of regressions: 3"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "C,TI,N"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: C, TI, N"
[1] "Predictors: highA1c, lastNat1"
[1] "No. of regressions: 3"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(C|highA1c, lastNat1);\\ Stratify: "
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|C, highA1c, lastNat1);\\ Stratify: C == 0"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(N|C, TI, highA1c, lastNat1);\\ Stratify: C == 0 & TI == 0"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: CVD, highA1c, N.tminus1"
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "N"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: N"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(N|);\\ Stratify: "
[1] "fitting the model: P(C|highA1c, lastNat1);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
    Intercept       highA1c      lastNat1 
-2.656607e+01  9.238692e-12  2.688942e-12 
[1] "fitting the model: P(TI|C, highA1c, lastNat1);\\ Stratify: C == 0"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
  Intercept           C     highA1c    lastNat1 
 0.87385792          NA -0.18986136 -0.06706656 
[1] "fitting the model: P(N|C, TI, highA1c, lastNat1);\\ Stratify: C == 0 & TI == 0"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
   Intercept            C           TI      highA1c     lastNat1 
-0.025688525           NA           NA  0.001591313 -0.012014026 
[1] "fitting the model: P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
 Intercept        CVD    highA1c  N.tminus1 
 0.6250400  1.3852271 -0.1432429  0.1288901 
[1] "fitting the model: P(N|);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
  Intercept 
-0.01358231 
> 
> # ----------------------------------------------------------------------
> # Fitting Propensity scores with Random Forests:
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "randomForest")
> ##D require("h2o")
> ##D h2o::h2o.init(nthreads = -1)
> ##D gform_CENS <- "C ~ highA1c + lastNat1"
> ##D OData <- fitPropensity(OData, gform_CENS = gform_CENS,
> ##D                         gform_TRT = gform_TRT,
> ##D                         gform_MONITOR = gform_MONITOR,
> ##D                         stratify_CENS = stratify_CENS)
> ##D 
> ##D # For Gradient Boosting machines:
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "gbm")
> ##D # Use `H2O-3` distributed implementation of GLM
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "glm")
> ##D # Use Deep Neural Nets:
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "deeplearning")
> ## End(Not run)
> 
> # ----------------------------------------------------------------------
> # Fitting different models with different algorithms
> # Fine tuning modeling with optional tuning parameters.
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D params_TRT = list(fit.package = "h2o", fit.algorithm = "gbm", ntrees = 50,
> ##D     learn_rate = 0.05, sample_rate = 0.8, col_sample_rate = 0.8,
> ##D     balance_classes = TRUE)
> ##D params_CENS = list(fit.package = "speedglm", fit.algorithm = "glm")
> ##D params_MONITOR = list(fit.package = "speedglm", fit.algorithm = "glm")
> ##D OData <- fitPropensity(OData,
> ##D             gform_CENS = gform_CENS, stratify_CENS = stratify_CENS, params_CENS = params_CENS,
> ##D             gform_TRT = gform_TRT, params_TRT = params_TRT,
> ##D             gform_MONITOR = gform_MONITOR, params_MONITOR = params_MONITOR)
> ## End(Not run)
> 
> # ----------------------------------------------------------------------
> # Running TMLE based on the previous fit of the propensity scores.
> # Also applying Random Forest to estimate the sequential outcome model
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D t.surv <- c(0:5)
> ##D Qforms <- rep.int("Q.kplus1 ~ CVD + highA1c + N + lastNat1 + TI + TI.tminus1", (max(t.surv)+1))
> ##D params_Q = list(fit.package = "h2o", fit.algorithm = "randomForest",
> ##D                 ntrees = 100, learn_rate = 0.05, sample_rate = 0.8,
> ##D                 col_sample_rate = 0.8, balance_classes = TRUE)
> ##D tmle_est <- fitTMLE(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D             Qforms = Qforms, params_Q = params_Q,
> ##D             stratifyQ_by_rule = TRUE)
> ## End(Not run)
> 
> ## Not run: 
> ##D t.surv <- c(0:5)
> ##D Qforms <- rep.int("Q.kplus1 ~ CVD + highA1c + N + lastNat1 + TI + TI.tminus1", (max(t.surv)+1))
> ##D params_Q = list(fit.package = "h2o", fit.algorithm = "randomForest",
> ##D                 ntrees = 100, learn_rate = 0.05, sample_rate = 0.8,
> ##D                 col_sample_rate = 0.8, balance_classes = TRUE)
> ##D tmle_est <- fitTMLE(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D             Qforms = Qforms, params_Q = params_Q,
> ##D             stratifyQ_by_rule = FALSE)
> ## End(Not run)
> 
> 
> 
> 
> cleanEx()

detaching ‘package:magrittr’, ‘package:data.table’

> nameEx("importData")
> ### * importData
> 
> flush(stderr()); flush(stdout())
> 
> ### Name: importData
> ### Title: Import data, define various nodes, define dummies for factor
> ###   columns and define OData R6 object
> ### Aliases: importData
> 
> ### ** Examples
> 
> options(stremr.verbose = TRUE)
> require("data.table")
Loading required package: data.table
> set_all_stremr_options(fit.package = "speedglm", fit.algorithm = "glm")
> 
> # ----------------------------------------------------------------------
> # Simulated Data
> # ----------------------------------------------------------------------
> data(OdataNoCENS)
> OdataDT <- as.data.table(OdataNoCENS, key=c(ID, t))
> 
> # define lagged N, first value is always 1 (always monitored at the first time point):
> OdataDT[, ("N.tminus1") := shift(get("N"), n = 1L, type = "lag", fill = 1L), by = ID]
> OdataDT[, ("TI.tminus1") := shift(get("TI"), n = 1L, type = "lag", fill = 1L), by = ID]
> 
> # ----------------------------------------------------------------------
> # Define intervention (always treated):
> # ----------------------------------------------------------------------
> OdataDT[, ("TI.set1") := 1L]
> OdataDT[, ("TI.set0") := 0L]
> 
> # ----------------------------------------------------------------------
> # Import Data
> # ----------------------------------------------------------------------
> OData <- importData(OdataDT, ID = "ID", t = "t", covars = c("highA1c", "lastNat1", "N.tminus1"),
+                     CENS = "C", TRT = "TI", MONITOR = "N", OUTCOME = "Y.tplus1")
[1] "Using the following stremr options/settings: "

List of 8
 $ fit.package       : chr "speedglm"
 $ fit.algorithm     : chr "glm"
 $ bin.method        : chr "equal.mass"
 $ nbins             : num 10
 $ maxncats          : num 20
 $ maxNperBin        : num 500
 $ lower_bound_zero_Q: logi TRUE
 $ skip_update_zero_Q: logi TRUE 
[1] "...detecting the type of each input column..."
> 
> # ----------------------------------------------------------------------
> # Model the Propensity Scores
> # ----------------------------------------------------------------------
> gform_CENS <- "C ~ highA1c + lastNat1"
> gform_TRT = "TI ~ CVD + highA1c + N.tminus1"
> gform_MONITOR <- "N ~ 1"
> stratify_CENS <- list(C=c("t < 16", "t == 16"))
> 
> # ----------------------------------------------------------------------
> # Fit Propensity Scores
> # ----------------------------------------------------------------------
> OData <- fitPropensity(OData, gform_CENS = gform_CENS,
+                         gform_TRT = gform_TRT,
+                         gform_MONITOR = gform_MONITOR,
+                         stratify_CENS = stratify_CENS)
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "gC" "gA" "gN"
[1] "Outcomes: "
[1] ""
[1] "No. of regressions: 3"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "C"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: C"
[1] "Predictors: highA1c, lastNat1"
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "StratifiedModel outcome: C"
[1] "StratifiedModel expressions: (t < 16,t == 16)"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: C, C"
[1] "Predictors: highA1c, lastNat1"
[1] "No. of regressions: 2"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(C|highA1c, lastNat1);\\ Stratify: t < 16"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(C|highA1c, lastNat1);\\ Stratify: t == 16"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: CVD, highA1c, N.tminus1"
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "N"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: N"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(N|);\\ Stratify: "
[1] "performing fitting for outcome based on stratified model for outcome: C"
[1] "fitting the model: P(C|highA1c, lastNat1);\\ Stratify: t < 16"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
    Intercept       highA1c      lastNat1 
-2.656607e+01  8.128911e-12  5.225396e-12 
[1] "fitting the model: P(C|highA1c, lastNat1);\\ Stratify: t == 16"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
    Intercept       highA1c      lastNat1 
-2.656607e+01 -5.129323e-13 -3.008816e-13 
fit for C var succeeded...
[1] "fitting the model: P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
 Intercept        CVD    highA1c  N.tminus1 
 0.6250400  1.3852271 -0.1432429  0.1288901 
[1] "fitting the model: P(N|);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
  Intercept 
-0.01358231 
[1] "performing prediction for outcome based on stratified model: C"
> 
> # ----------------------------------------------------------------------
> # IPW Ajusted KM or Saturated MSM
> # ----------------------------------------------------------------------
> require("magrittr")
Loading required package: magrittr
> AKME.St.1 <- getIPWeights(OData, intervened_TRT = "TI.set1") %>%
+              survNPMSM(OData) %$%
+              IPW_estimates
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> AKME.St.1
    t  sum_Y_IPAW sum_all_IPAW          ht   St.IPTW       ht.KM     St.KM
1   0   1.6610718     38.13840 0.043553792 0.9564462 0.047337278 0.9526627
2   1   0.8070748     48.10323 0.016777974 0.9403990 0.018633540 0.9349112
3   2   1.0721508     65.59519 0.016344959 0.9250282 0.012658228 0.9230769
4   3   0.0000000     91.16229 0.000000000 0.9250282 0.000000000 0.9230769
5   4   3.4232039    132.03450 0.025926586 0.9010454 0.025641026 0.8994083
6   5   2.7647724    182.07477 0.015184819 0.8873632 0.026315789 0.8757396
7   6   0.6840395    257.65098 0.002654907 0.8850073 0.013513514 0.8639053
8   7   7.2912160    375.48517 0.019418120 0.8678221 0.013698630 0.8520710
9   8  11.8316412    540.78252 0.021878742 0.8488353 0.034722222 0.8224852
10  9   7.8472558    766.65939 0.010235648 0.8401469 0.007194245 0.8165680
11 10   0.0000000   1131.74617 0.000000000 0.8401469 0.000000000 0.8165680
12 11  19.6818394   1698.64910 0.011586760 0.8304123 0.014492754 0.8047337
13 12 112.5585923   2500.60892 0.045012473 0.7930334 0.044117647 0.7692308
14 13  76.8430786   3426.37023 0.022426963 0.7752481 0.015384615 0.7573964
15 14   0.0000000   4968.01401 0.000000000 0.7752481 0.000000000 0.7573964
16 15 398.1827812   7488.93955 0.053169448 0.7340285 0.046875000 0.7218935
17 16   0.0000000  10147.78922 0.000000000 0.7340285 0.000000000 0.7218935
   rule.name
1    TI.set1
2    TI.set1
3    TI.set1
4    TI.set1
5    TI.set1
6    TI.set1
7    TI.set1
8    TI.set1
9    TI.set1
10   TI.set1
11   TI.set1
12   TI.set1
13   TI.set1
14   TI.set1
15   TI.set1
16   TI.set1
17   TI.set1
> 
> # ----------------------------------------------------------------------
> # Bounded IPW
> # ----------------------------------------------------------------------
> IPW.St.1 <- getIPWeights(OData, intervened_TRT = "TI.set1") %>%
+              survDirectIPW(OData)
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> IPW.St.1[]
            est_name  t  sum_Y_IPAW   sum_IPAW       risk     S.t.n
 1: DirectBoundedIPW  0    9.828827   225.6710 0.04355379 0.9564462
 2: DirectBoundedIPW  1   14.841714   308.6067 0.04809266 0.9519073
 3: DirectBoundedIPW  2   21.627479   430.0012 0.05029632 0.9497037
 4: DirectBoundedIPW  3   21.627479   606.0012 0.03568884 0.9643112
 5: DirectBoundedIPW  4   43.571094   868.0025 0.05019697 0.9498030
 6: DirectBoundedIPW  5   61.760385  1241.4314 0.04974933 0.9502507
 7: DirectBoundedIPW  6   66.382274  1802.6454 0.03682492 0.9631751
 8: DirectBoundedIPW  7  116.322109  2638.1985 0.04409149 0.9559085
 9: DirectBoundedIPW  8  198.486284  3871.7562 0.05126518 0.9487348
10: DirectBoundedIPW  9  254.941362  5714.0214 0.04461680 0.9553832
11: DirectBoundedIPW 10  254.941362  8456.0006 0.03014917 0.9698508
12: DirectBoundedIPW 11  397.563386 12563.9928 0.03164308 0.9683569
13: DirectBoundedIPW 12 1225.200094 18784.3937 0.06522436 0.9347756
14: DirectBoundedIPW 13 1816.300699 27581.8941 0.06585120 0.9341488
15: DirectBoundedIPW 14 1816.300699 40628.9102 0.04470464 0.9552954
16: DirectBoundedIPW 15 4927.103677 60323.6409 0.08167782 0.9183222
> 
> # ----------------------------------------------------------------------
> # IPW-MSM for hazard
> # ----------------------------------------------------------------------
> wts.DT.1 <- getIPWeights(OData = OData, intervened_TRT = "TI.set1", rule_name = "TI1")
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> wts.DT.0 <- getIPWeights(OData = OData, intervened_TRT = "TI.set0", rule_name = "TI0")
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> survMSM_res <- survMSM(list(wts.DT.1, wts.DT.0), OData, t_breaks = c(1:8,12,16)-1,)
[1] "performing estimation for the following TRT/MONITOR rules found in column 'rule.name': TI0,TI1"
[1] "periods"
 [1]  0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15
[1] "defined t.dummy: Periods.0to0"
[1] "defined t.dummy: Periods.1to1"
[1] "defined t.dummy: Periods.2to2"
[1] "defined t.dummy: Periods.3to3"
[1] "defined t.dummy: Periods.4to4"
[1] "defined t.dummy: Periods.5to5"
[1] "defined t.dummy: Periods.6to6"
[1] "defined t.dummy: Periods.7to7"
[1] "defined t.dummy: Periods.8to11"
[1] "defined t.dummy: Periods.12to15"
[1] "Periods.0to0_TI0"
[1] "Periods.1to1_TI0"
[1] "Periods.2to2_TI0"
[1] "Periods.3to3_TI0"
[1] "Periods.4to4_TI0"
[1] "Periods.5to5_TI0"
[1] "Periods.6to6_TI0"
[1] "Periods.7to7_TI0"
[1] "Periods.8to11_TI0"
[1] "Periods.12to15_TI0"
[1] "Periods.0to0_TI1"
[1] "Periods.1to1_TI1"
[1] "Periods.2to2_TI1"
[1] "Periods.3to3_TI1"
[1] "Periods.4to4_TI1"
[1] "Periods.5to5_TI1"
[1] "Periods.6to6_TI1"
[1] "Periods.7to7_TI1"
[1] "Periods.8to11_TI1"
[1] "Periods.12to15_TI1"
...fitting hazard MSM with speedglm::speedglm.wfit...
[1] "MSM fits"
  Periods.0to0_TI0   Periods.1to1_TI0   Periods.2to2_TI0   Periods.3to3_TI0 
     -5.465039e+00      -4.324378e+00      -4.012934e+00      -1.166619e+15 
  Periods.4to4_TI0   Periods.5to5_TI0   Periods.6to6_TI0   Periods.7to7_TI0 
     -6.871355e+14      -4.884654e+14      -6.732368e+00      -6.414551e+00 
 Periods.8to11_TI0 Periods.12to15_TI0   Periods.0to0_TI1   Periods.1to1_TI1 
     -2.490327e+15      -3.057464e+15      -3.089228e+00      -4.070768e+00 
  Periods.2to2_TI1   Periods.3to3_TI1   Periods.4to4_TI1   Periods.5to5_TI1 
     -4.097356e+00      -1.444049e+01      -3.626218e+00      -4.172158e+00 
  Periods.6to6_TI1   Periods.7to7_TI1  Periods.8to11_TI1 Periods.12to15_TI1 
     -5.928687e+00      -3.921940e+00      -4.645602e+00      -3.410729e+00 
...evaluating MSM-based survival curves...
...evaluating SEs based on MSM hazard fit and the estimated IC...
[1] "Should all be very small: "
  Periods.0to0_TI0   Periods.1to1_TI0   Periods.2to2_TI0   Periods.3to3_TI0 
      8.745296e-16       4.214695e-15       8.819608e-15       7.293270e+00 
  Periods.4to4_TI0   Periods.5to5_TI0   Periods.6to6_TI0   Periods.7to7_TI0 
      6.561300e+01       4.445403e+02       5.648100e-14       5.676302e-14 
 Periods.8to11_TI0 Periods.12to15_TI0   Periods.0to0_TI1   Periods.1to1_TI1 
      2.030033e+02       7.899748e+02       3.196367e-18       3.295818e-18 
  Periods.2to2_TI1   Periods.3to3_TI1   Periods.4to4_TI1   Periods.5to5_TI1 
      5.938153e-18       4.879654e-08       5.552308e-18       8.758887e-18 
  Periods.6to6_TI1   Periods.7to7_TI1  Periods.8to11_TI1 Periods.12to15_TI1 
      9.627973e-20       1.899923e-17       1.180759e-18       4.982015e-15 
[1] "Should all be very small: "
  Periods.0to0_TI0   Periods.1to1_TI0   Periods.2to2_TI0   Periods.3to3_TI0 
      8.645048e-14       4.643372e-14       2.150078e-14       3.336980e+14 
  Periods.4to4_TI0   Periods.5to5_TI0   Periods.6to6_TI0   Periods.7to7_TI0 
      7.563694e+14       1.183848e+15       9.715875e-15       1.095287e-14 
 Periods.8to11_TI0 Periods.12to15_TI0   Periods.0to0_TI1   Periods.1to1_TI1 
      1.830248e+14       5.408850e+14       2.038744e-15       4.102638e-15 
  Periods.2to2_TI1   Periods.3to3_TI1   Periods.4to4_TI1   Periods.5to5_TI1 
      5.644245e-15       1.000001e+00       1.646367e-15       3.270332e-15 
  Periods.6to6_TI1   Periods.7to7_TI1  Periods.8to11_TI1 Periods.12to15_TI1 
      1.486411e-16       2.648109e-15       3.026786e-17       8.738800e-15 
[1] "Should all be very small: "
 [1] 3.628268e-16 2.387874e-16 1.344854e-16 1.344854e-16 1.344854e-16
 [6] 1.344854e-16 1.449570e-16 1.619186e-16 1.619186e-16 1.619186e-16
[11] 1.619186e-16 1.619186e-16 1.619186e-16 1.619186e-16 1.619186e-16
[16] 1.619186e-16
[1] "Should all be very small: "
 [1] 8.519431e-17 1.505626e-17 1.044968e-16 4.951408e-07 4.823035e-07
 [6] 4.749798e-07 4.737188e-07 4.645200e-07 4.601013e-07 4.557247e-07
[11] 4.513896e-07 4.470959e-07 4.328058e-07 4.189726e-07 4.055814e-07
[16] 3.926183e-07
> survMSM_res$St
$TI0
 [1] 0.9957857 0.9827720 0.9653188 0.9653188 0.9653188 0.9653188 0.9641698
 [8] 0.9625935 0.9625935 0.9625935 0.9625935 0.9625935 0.9625935 0.9625935
[15] 0.9625935 0.9625935

$TI1
 [1] 0.9564462 0.9403990 0.9250282 0.9250277 0.9010449 0.8873627 0.8850068
 [8] 0.8678217 0.8595666 0.8513901 0.8432913 0.8352696 0.8085728 0.7827293
[15] 0.7577119 0.7334940

> 
> # ----------------------------------------------------------------------
> # Sequential G-COMP
> # ----------------------------------------------------------------------
> t.surv <- c(0:15)
> Qforms <- rep.int("Q.kplus1 ~ CVD + highA1c + N + lastNat1 + TI + TI.tminus1", (max(t.surv)+1))
> params = list(fit.package = "speedglm", fit.algorithm = "glm")
> 
> ## Not run: 
> ##D gcomp_est <- fitSeqGcomp(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D                           Qforms = Qforms, params_Q = params, stratifyQ_by_rule = FALSE)
> ##D gcomp_est[]
> ## End(Not run)
> # ----------------------------------------------------------------------
> # TMLE
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D tmle_est <- fitTMLE(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D                     Qforms = Qforms, params_Q = params, stratifyQ_by_rule = TRUE)
> ##D tmle_est[]
> ## End(Not run)
> 
> # ----------------------------------------------------------------------
> # Running IPW-Adjusted KM with optional user-specified weights:
> # ----------------------------------------------------------------------
> addedWts_DT <- OdataDT[, c("ID", "t"), with = FALSE]
> addedWts_DT[, new.wts := sample.int(10, nrow(OdataDT), replace = TRUE)/10]
> survNP_res_addedWts <- survNPMSM(wts.DT.1, OData, weights = addedWts_DT)
> 
> # ----------------------------------------------------------------------
> # Multivariate Propensity Score Regressions
> # ----------------------------------------------------------------------
> gform_CENS <- "C + TI + N ~ highA1c + lastNat1"
> OData <- fitPropensity(OData, gform_CENS = gform_CENS, gform_TRT = gform_TRT,
+                         gform_MONITOR = gform_MONITOR)
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "gC" "gA" "gN"
[1] "Outcomes: "
[1] ""
[1] "No. of regressions: 3"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "C,TI,N"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: C, TI, N"
[1] "Predictors: highA1c, lastNat1"
[1] "No. of regressions: 3"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(C|highA1c, lastNat1);\\ Stratify: "
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|C, highA1c, lastNat1);\\ Stratify: C == 0"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(N|C, TI, highA1c, lastNat1);\\ Stratify: C == 0 & TI == 0"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: CVD, highA1c, N.tminus1"
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "N"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: N"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(N|);\\ Stratify: "
[1] "fitting the model: P(C|highA1c, lastNat1);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
    Intercept       highA1c      lastNat1 
-2.656607e+01  9.238692e-12  2.688942e-12 
[1] "fitting the model: P(TI|C, highA1c, lastNat1);\\ Stratify: C == 0"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
  Intercept           C     highA1c    lastNat1 
 0.87385792          NA -0.18986136 -0.06706656 
[1] "fitting the model: P(N|C, TI, highA1c, lastNat1);\\ Stratify: C == 0 & TI == 0"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
   Intercept            C           TI      highA1c     lastNat1 
-0.025688525           NA           NA  0.001591313 -0.012014026 
[1] "fitting the model: P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
 Intercept        CVD    highA1c  N.tminus1 
 0.6250400  1.3852271 -0.1432429  0.1288901 
[1] "fitting the model: P(N|);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
  Intercept 
-0.01358231 
> 
> # ----------------------------------------------------------------------
> # Fitting Propensity scores with Random Forests:
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "randomForest")
> ##D require("h2o")
> ##D h2o::h2o.init(nthreads = -1)
> ##D gform_CENS <- "C ~ highA1c + lastNat1"
> ##D OData <- fitPropensity(OData, gform_CENS = gform_CENS,
> ##D                         gform_TRT = gform_TRT,
> ##D                         gform_MONITOR = gform_MONITOR,
> ##D                         stratify_CENS = stratify_CENS)
> ##D 
> ##D # For Gradient Boosting machines:
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "gbm")
> ##D # Use `H2O-3` distributed implementation of GLM
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "glm")
> ##D # Use Deep Neural Nets:
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "deeplearning")
> ## End(Not run)
> 
> # ----------------------------------------------------------------------
> # Fitting different models with different algorithms
> # Fine tuning modeling with optional tuning parameters.
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D params_TRT = list(fit.package = "h2o", fit.algorithm = "gbm", ntrees = 50,
> ##D     learn_rate = 0.05, sample_rate = 0.8, col_sample_rate = 0.8,
> ##D     balance_classes = TRUE)
> ##D params_CENS = list(fit.package = "speedglm", fit.algorithm = "glm")
> ##D params_MONITOR = list(fit.package = "speedglm", fit.algorithm = "glm")
> ##D OData <- fitPropensity(OData,
> ##D             gform_CENS = gform_CENS, stratify_CENS = stratify_CENS, params_CENS = params_CENS,
> ##D             gform_TRT = gform_TRT, params_TRT = params_TRT,
> ##D             gform_MONITOR = gform_MONITOR, params_MONITOR = params_MONITOR)
> ## End(Not run)
> 
> # ----------------------------------------------------------------------
> # Running TMLE based on the previous fit of the propensity scores.
> # Also applying Random Forest to estimate the sequential outcome model
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D t.surv <- c(0:5)
> ##D Qforms <- rep.int("Q.kplus1 ~ CVD + highA1c + N + lastNat1 + TI + TI.tminus1", (max(t.surv)+1))
> ##D params_Q = list(fit.package = "h2o", fit.algorithm = "randomForest",
> ##D                 ntrees = 100, learn_rate = 0.05, sample_rate = 0.8,
> ##D                 col_sample_rate = 0.8, balance_classes = TRUE)
> ##D tmle_est <- fitTMLE(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D             Qforms = Qforms, params_Q = params_Q,
> ##D             stratifyQ_by_rule = TRUE)
> ## End(Not run)
> 
> ## Not run: 
> ##D t.surv <- c(0:5)
> ##D Qforms <- rep.int("Q.kplus1 ~ CVD + highA1c + N + lastNat1 + TI + TI.tminus1", (max(t.surv)+1))
> ##D params_Q = list(fit.package = "h2o", fit.algorithm = "randomForest",
> ##D                 ntrees = 100, learn_rate = 0.05, sample_rate = 0.8,
> ##D                 col_sample_rate = 0.8, balance_classes = TRUE)
> ##D tmle_est <- fitTMLE(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D             Qforms = Qforms, params_Q = params_Q,
> ##D             stratifyQ_by_rule = FALSE)
> ## End(Not run)
> 
> 
> 
> 
> cleanEx()

detaching ‘package:magrittr’, ‘package:data.table’

> nameEx("stremr")
> ### * stremr
> 
> flush(stderr()); flush(stdout())
> 
> ### Name: stremr
> ### Title: Estimate Survival with Interventions on Exposure and MONITORing
> ###   Process in Right Censored Longitudinal Data.
> ### Aliases: stremr
> 
> ### ** Examples
> 
> #-------------------------------------------------------------------
> # EXAMPLE WITH CATEGORICAL CENSORING (3 levels)
> #-------------------------------------------------------------------
> require("data.table")
Loading required package: data.table
> require("magrittr")
Loading required package: magrittr
> data(OdataCatCENS)
> OdataDT <- as.data.table(OdataCatCENS, key=c(ID, t))
> # Indicator that the person has never been treated in the past:
> OdataDT[, "barTIm1eq0" := as.integer(c(0, cumsum(TI)[-.N]) %in% 0), by = ID]
> # Define lagged N, first value is always 1 (always monitored at the first time point):
> OdataDT[, ("N.tminus1") := shift(get("N"), n = 1L, type = "lag", fill = 1L), by = ID]
> 
> #-------------------------------------------------------------------
> # Regressions for modeling the exposure (TRT)
> #-------------------------------------------------------------------
> gform_TRT <- "TI ~ CVD + highA1c + N.tminus1"
> # Fit a separate model for TRT (stratify) for each of the following subsets:
> stratify_TRT <- list(
+   TI=c(
+        # MODEL TI AT t=0
+        "t == 0L",
+        # MODEL TRT INITATION WHEN MONITORED
+        "(t > 0L) & (N.tminus1 == 1L) & (barTIm1eq0 == 1L)",
+        # MODEL TRT INITATION WHEN NOT MONITORED
+        "(t > 0L) & (N.tminus1 == 0L) & (barTIm1eq0 == 1L)",
+        # MODEL TRT CONTINUATION (BOTH MONITORED AND NOT MONITORED)
+        "(t > 0L) & (barTIm1eq0 == 1L)"
+       ))
> 
> #-------------------------------------------------------------------
> # Regressions for modeling the categorical censoring (CENS)
> #-------------------------------------------------------------------
> gform_CENS <- c("CatC ~ highA1c")
> # stratify by time-points (separate model for all t<16 and t=16)
> stratify_CENS <- list(CatC=c("t < 16", "t == 16"))
> 
> #-------------------------------------------------------------------
> # Regressions for modeling the monitoring regimen (MONITOR)
> #-------------------------------------------------------------------
> # Intercept only model, pooling across all time points t
> gform_MONITOR <- "N ~ 1"
> 
> #-------------------------------------------------------------------
> # Define the counterfactual monitoring regimen of interest
> #-------------------------------------------------------------------
> # probability of being monitored at each t is 0.1
> OdataDT[, "gstar.N" := 0.1]
> 
> # Define two dynamic rules: dlow & dhigh
> OdataDT <- defineIntervedTRT(OdataDT, theta = c(0,1), ID = "ID", t = "t", I = "highA1c",
+                             CENS = "C", TRT = "TI", MONITOR = "N", tsinceNis1 = "lastNat1",
+                             new.TRT.names = c("dlow", "dhigh"), return.allcolumns = TRUE)
> 
> # Estimate IPW-based hazard and survival (KM) for a rule "dhigh":
> IPW_KM_res <- stremr(OdataDT, intervened_TRT = "dhigh", intervened_MONITOR = "gstar.N",
+               ID = "ID", t = "t", covars = c("highA1c", "lastNat1"),
+               CENS = "CatC", gform_CENS = gform_CENS, stratify_CENS = stratify_CENS,
+               TRT = "TI", gform_TRT = gform_TRT, stratify_TRT = stratify_TRT,
+               MONITOR = "N", gform_MONITOR = gform_MONITOR, OUTCOME = "Y.tplus1")
[1] "Using the following stremr options/settings: "

List of 8
 $ fit.package       : chr "speedglm"
 $ fit.algorithm     : chr "glm"
 $ bin.method        : chr "equal.mass"
 $ nbins             : num 10
 $ maxncats          : num 20
 $ maxNperBin        : num 500
 $ lower_bound_zero_Q: logi TRUE
 $ skip_update_zero_Q: logi TRUE 
[1] "...detecting the type of each input column..."
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "gC" "gA" "gN"
[1] "Outcomes: "
[1] ""
[1] "No. of regressions: 3"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "CatC"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: CatC"
[1] "Predictors: highA1c"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "StratifiedModel outcome: CatC"
[1] "StratifiedModel expressions: (t < 16,t == 16)"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: CatC, CatC"
[1] "Predictors: highA1c"
[1] "No. of regressions: 2"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
...fitting a model for categorical censoring...
[1] "CategorModel outcome: CatC"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: CatC_B.1, CatC_B.2, CatC_B.3"
[1] "Predictors: highA1c"
[1] "No. of regressions: 3"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(CatC_B.1|highA1c);\\ Stratify: t < 16"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(CatC_B.2|highA1c);\\ Stratify: t < 16"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(CatC_B.3|highA1c);\\ Stratify: t < 16"
...fitting a model for categorical censoring...
[1] "CategorModel outcome: CatC"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: CatC_B.1, CatC_B.2, CatC_B.3"
[1] "Predictors: highA1c"
[1] "No. of regressions: 3"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(CatC_B.1|highA1c);\\ Stratify: t == 16"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(CatC_B.2|highA1c);\\ Stratify: t == 16"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(CatC_B.3|highA1c);\\ Stratify: t == 16"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: CVD, highA1c, N.tminus1"
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "StratifiedModel outcome: TI"
[1] "StratifiedModel expressions: (t == 0L,(t > 0L) & (N.tminus1 == 1L) & (barTIm1eq0 == 1L),(t > 0L) & (N.tminus1 == 0L) & (barTIm1eq0 == 1L),(t > 0L) & (barTIm1eq0 == 1L))"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI, TI, TI, TI"
[1] "Predictors: CVD, highA1c, N.tminus1"
[1] "No. of regressions: 4"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|CVD, highA1c, N.tminus1);\\ Stratify: t == 0L"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|CVD, highA1c, N.tminus1);\\ Stratify: (t > 0L) & (N.tminus1 == 1L) & (barTIm1eq0 == 1L)"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|CVD, highA1c, N.tminus1);\\ Stratify: (t > 0L) & (N.tminus1 == 0L) & (barTIm1eq0 == 1L)"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|CVD, highA1c, N.tminus1);\\ Stratify: (t > 0L) & (barTIm1eq0 == 1L)"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "N"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: N"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(N|);\\ Stratify: "
[1] "performing fitting for outcome based on stratified model for outcome: CatC"
making matrix for dummies for cat. censoring, reference category is 0
[1] "performing fitting for categorical outcome: CatC"
[1] "freq counts by bin for categorical outcome: "

   0    1    2 
7469  347  314 
[1] "binned dataset: "
     sA CatC_B.1 CatC_B.2 CatC_B.3
[1,]  0        0        0       NA
[2,]  0        0        0       NA
[3,]  1        1       NA       NA
[4,]  0        0        0       NA
[5,]  0        0        0       NA
[1] "fitting the model: P(CatC_B.1|highA1c);\\ Stratify: t < 16"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
 Intercept    highA1c 
-3.1487960  0.1616531 
[1] "fitting the model: P(CatC_B.2|highA1c);\\ Stratify: t < 16"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
  Intercept     highA1c 
-3.13719779 -0.08098814 
[1] "fitting the model: P(CatC_B.3|highA1c);\\ Stratify: t < 16"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
Intercept   highA1c 
       NA        NA 
fit for CatC var succeeded...
making matrix for dummies for cat. censoring, reference category is 0
[1] "performing fitting for categorical outcome: CatC"
[1] "freq counts by bin for categorical outcome: "

   0    1    2 
7469  347  314 
[1] "binned dataset: "
     sA CatC_B.1 CatC_B.2 CatC_B.3
[1,]  0        0        0       NA
[2,]  0        0        0       NA
[3,]  1        1       NA       NA
[4,]  0        0        0       NA
[5,]  0        0        0       NA
[1] "fitting the model: P(CatC_B.1|highA1c);\\ Stratify: t == 16"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
 Intercept    highA1c 
-2.9593646  0.5614693 
[1] "fitting the model: P(CatC_B.2|highA1c);\\ Stratify: t == 16"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
Intercept   highA1c 
 -4.89784 -15.66823 
[1] "fitting the model: P(CatC_B.3|highA1c);\\ Stratify: t == 16"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
Intercept   highA1c 
       NA        NA 
fit for CatC var succeeded...
fit for CatC var succeeded...
[1] "performing fitting for outcome based on stratified model for outcome: TI"
[1] "fitting the model: P(TI|CVD, highA1c, N.tminus1);\\ Stratify: t == 0L"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
Intercept       CVD   highA1c N.tminus1 
-2.156898  2.117370  2.269857        NA 
[1] "fitting the model: P(TI|CVD, highA1c, N.tminus1);\\ Stratify: (t > 0L) & (N.tminus1 == 1L) & (barTIm1eq0 == 1L)"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
 Intercept        CVD    highA1c  N.tminus1 
-2.1141458  0.9100488  2.1714524         NA 
[1] "fitting the model: P(TI|CVD, highA1c, N.tminus1);\\ Stratify: (t > 0L) & (N.tminus1 == 0L) & (barTIm1eq0 == 1L)"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
    Intercept           CVD       highA1c     N.tminus1 
-2.656607e+01  2.444839e-12  2.082888e-12            NA 
[1] "fitting the model: P(TI|CVD, highA1c, N.tminus1);\\ Stratify: (t > 0L) & (barTIm1eq0 == 1L)"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
  Intercept         CVD     highA1c   N.tminus1 
-21.2548627   0.9100488   2.1714524  19.1407169 
fit for TI var succeeded...
[1] "fitting the model: P(N|);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
  Intercept 
-0.02436859 
[1] "performing prediction for outcome based on stratified model: CatC"
[1] "performing prediction for categorical outcome: CatC"
[1] "performing prediction for categorical outcome: CatC"
[1] "performing prediction for outcome based on stratified model: TI"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "N"
[1] "Outcomes: "
[1] "N"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: N"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> 
> # Survival estimates by time:
> IPW_KM_res$IPW_estimates
    t   sum_Y_IPAW sum_all_IPAW           ht   St.IPTW       ht.KM     St.KM
1   0  9.910890351   926.170738 1.070093e-02 0.9892991 0.011709602 0.9882904
2   1 17.900833629   785.151317 2.279921e-02 0.9667438 0.020057307 0.9684680
3   2 20.383396016   585.466138 3.481567e-02 0.9330860 0.018115942 0.9509232
4   3 16.881335081   408.872517 4.128753e-02 0.8945612 0.034482759 0.9181328
5   4  6.501491023   344.984446 1.884575e-02 0.8777025 0.032934132 0.8878949
6   5 40.579472710   322.247044 1.259266e-01 0.7671764 0.031914894 0.8595578
7   6  3.567748829   280.130093 1.273604e-02 0.7574056 0.021739130 0.8408718
8   7  0.013952040   219.561998 6.354488e-05 0.7573575 0.005235602 0.8364693
9   8 23.610654177   141.907185 1.663810e-01 0.6313476 0.046242775 0.7977886
10  9  0.083891244   107.142640 7.829865e-04 0.6308533 0.020689655 0.7812827
11 10  0.626547293   137.742399 4.548689e-03 0.6279837 0.022900763 0.7633907
12 11  0.060272827    69.471855 8.675863e-04 0.6274389 0.042735043 0.7307672
13 12  0.070962423    60.410513 1.174670e-03 0.6267019 0.019417476 0.7165775
14 13  2.719183158    93.420087 2.910705e-02 0.6084604 0.021739130 0.7009997
15 14  4.171085606    98.812185 4.221226e-02 0.5827759 0.037500000 0.6747122
16 15  0.006068597    22.005535 2.757759e-04 0.5826152 0.027027027 0.6564768
17 16  0.000000000     5.495776 0.000000e+00 0.5826152 0.000000000 0.6564768
      rule.name
1  dhighgstar.N
2  dhighgstar.N
3  dhighgstar.N
4  dhighgstar.N
5  dhighgstar.N
6  dhighgstar.N
7  dhighgstar.N
8  dhighgstar.N
9  dhighgstar.N
10 dhighgstar.N
11 dhighgstar.N
12 dhighgstar.N
13 dhighgstar.N
14 dhighgstar.N
15 dhighgstar.N
16 dhighgstar.N
17 dhighgstar.N
> # Input data:
> IPW_KM_res$dataDT
        ID CVD t lastNat1 highA1c TI CatC C  N Y.tplus1 barTIm1eq0 N.tminus1
   1:    1   0 0        0       0  0    0 0  1        0          1         1
   2:    1   0 1        0       0  1    0 0  0        0          1         1
   3:    1   0 2        1       0  1    1 1 NA       NA          0         0
   4:    2   0 0        0       0  0    0 0  1        0          1         1
   5:    2   0 1        0       1  0    0 0  1        0          1         1
  ---                                                                       
8126: 1000   0 1        1       0  0    0 0  0        0          1         0
8127: 1000   0 2        2       0  0    0 0  1        0          1         0
8128: 1000   0 3        0       0  0    0 0  1        0          1         1
8129: 1000   0 4        0       1  0    0 0  1        0          1         1
8130: 1000   0 5        0       1  0    0 0  0        1          1         1
      gstar.N dlow dhigh       g0.A       g0.C      g0.N      g0.CAN
   1:     0.1    1     0 0.89631162 0.91897388 0.4939082 0.406825707
   2:     0.1    1     0 0.01160565 0.91897388 0.5060918 0.005397615
   3:     0.1    1     0 1.00000000 0.04113875 1.0000000 0.041138746
   4:     0.1    1     0 0.89631162 0.91897388 0.4939082 0.406825707
   5:     0.1    1     1 0.23588241 0.91535060 0.4939082 0.106642229
  ---                                                               
8126:     0.1    1     0 1.00000000 0.91897388 0.5060918 0.465085186
8127:     0.1    1     0 1.00000000 0.91897388 0.4939082 0.453888691
8128:     0.1    1     0 0.79614663 0.91897388 0.4939082 0.361361951
8129:     0.1    1     1 0.23588241 0.91535060 0.4939082 0.106642229
8130:     0.1    1     1 0.23588241 0.91535060 0.5060918 0.109272872
> 
> 
> 
> cleanEx()

detaching ‘package:magrittr’, ‘package:data.table’

> nameEx("stremrOptions")
> ### * stremrOptions
> 
> flush(stderr()); flush(stdout())
> 
> ### Name: stremrOptions
> ### Title: Querying/setting a single 'stremr' option
> ### Aliases: stremrOptions
> 
> ### ** Examples
> 
> ## Not run: 
> ##D stremrOptions()
> ##D stremrOptions('fit.package')
> ##D stremrOptions('fit.package', 'h2o')
> ## End(Not run)
> 
> 
> 
> cleanEx()
> nameEx("survDirectIPW")
> ### * survDirectIPW
> 
> flush(stderr()); flush(stdout())
> 
> ### Name: survDirectIPW
> ### Title: Direct (bounded) IPW estimator of discrete survival function.
> ### Aliases: survDirectIPW
> 
> ### ** Examples
> 
> options(stremr.verbose = TRUE)
> require("data.table")
Loading required package: data.table
> set_all_stremr_options(fit.package = "speedglm", fit.algorithm = "glm")
> 
> # ----------------------------------------------------------------------
> # Simulated Data
> # ----------------------------------------------------------------------
> data(OdataNoCENS)
> OdataDT <- as.data.table(OdataNoCENS, key=c(ID, t))
> 
> # define lagged N, first value is always 1 (always monitored at the first time point):
> OdataDT[, ("N.tminus1") := shift(get("N"), n = 1L, type = "lag", fill = 1L), by = ID]
> OdataDT[, ("TI.tminus1") := shift(get("TI"), n = 1L, type = "lag", fill = 1L), by = ID]
> 
> # ----------------------------------------------------------------------
> # Define intervention (always treated):
> # ----------------------------------------------------------------------
> OdataDT[, ("TI.set1") := 1L]
> OdataDT[, ("TI.set0") := 0L]
> 
> # ----------------------------------------------------------------------
> # Import Data
> # ----------------------------------------------------------------------
> OData <- importData(OdataDT, ID = "ID", t = "t", covars = c("highA1c", "lastNat1", "N.tminus1"),
+                     CENS = "C", TRT = "TI", MONITOR = "N", OUTCOME = "Y.tplus1")
[1] "Using the following stremr options/settings: "

List of 8
 $ fit.package       : chr "speedglm"
 $ fit.algorithm     : chr "glm"
 $ bin.method        : chr "equal.mass"
 $ nbins             : num 10
 $ maxncats          : num 20
 $ maxNperBin        : num 500
 $ lower_bound_zero_Q: logi TRUE
 $ skip_update_zero_Q: logi TRUE 
[1] "...detecting the type of each input column..."
> 
> # ----------------------------------------------------------------------
> # Model the Propensity Scores
> # ----------------------------------------------------------------------
> gform_CENS <- "C ~ highA1c + lastNat1"
> gform_TRT = "TI ~ CVD + highA1c + N.tminus1"
> gform_MONITOR <- "N ~ 1"
> stratify_CENS <- list(C=c("t < 16", "t == 16"))
> 
> # ----------------------------------------------------------------------
> # Fit Propensity Scores
> # ----------------------------------------------------------------------
> OData <- fitPropensity(OData, gform_CENS = gform_CENS,
+                         gform_TRT = gform_TRT,
+                         gform_MONITOR = gform_MONITOR,
+                         stratify_CENS = stratify_CENS)
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "gC" "gA" "gN"
[1] "Outcomes: "
[1] ""
[1] "No. of regressions: 3"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "C"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: C"
[1] "Predictors: highA1c, lastNat1"
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "StratifiedModel outcome: C"
[1] "StratifiedModel expressions: (t < 16,t == 16)"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: C, C"
[1] "Predictors: highA1c, lastNat1"
[1] "No. of regressions: 2"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(C|highA1c, lastNat1);\\ Stratify: t < 16"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(C|highA1c, lastNat1);\\ Stratify: t == 16"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: CVD, highA1c, N.tminus1"
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "N"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: N"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(N|);\\ Stratify: "
[1] "performing fitting for outcome based on stratified model for outcome: C"
[1] "fitting the model: P(C|highA1c, lastNat1);\\ Stratify: t < 16"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
    Intercept       highA1c      lastNat1 
-2.656607e+01  8.128911e-12  5.225396e-12 
[1] "fitting the model: P(C|highA1c, lastNat1);\\ Stratify: t == 16"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
    Intercept       highA1c      lastNat1 
-2.656607e+01 -5.129323e-13 -3.008816e-13 
fit for C var succeeded...
[1] "fitting the model: P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
 Intercept        CVD    highA1c  N.tminus1 
 0.6250400  1.3852271 -0.1432429  0.1288901 
[1] "fitting the model: P(N|);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
  Intercept 
-0.01358231 
[1] "performing prediction for outcome based on stratified model: C"
> 
> # ----------------------------------------------------------------------
> # IPW Ajusted KM or Saturated MSM
> # ----------------------------------------------------------------------
> require("magrittr")
Loading required package: magrittr
> AKME.St.1 <- getIPWeights(OData, intervened_TRT = "TI.set1") %>%
+              survNPMSM(OData) %$%
+              IPW_estimates
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> AKME.St.1
    t  sum_Y_IPAW sum_all_IPAW          ht   St.IPTW       ht.KM     St.KM
1   0   1.6610718     38.13840 0.043553792 0.9564462 0.047337278 0.9526627
2   1   0.8070748     48.10323 0.016777974 0.9403990 0.018633540 0.9349112
3   2   1.0721508     65.59519 0.016344959 0.9250282 0.012658228 0.9230769
4   3   0.0000000     91.16229 0.000000000 0.9250282 0.000000000 0.9230769
5   4   3.4232039    132.03450 0.025926586 0.9010454 0.025641026 0.8994083
6   5   2.7647724    182.07477 0.015184819 0.8873632 0.026315789 0.8757396
7   6   0.6840395    257.65098 0.002654907 0.8850073 0.013513514 0.8639053
8   7   7.2912160    375.48517 0.019418120 0.8678221 0.013698630 0.8520710
9   8  11.8316412    540.78252 0.021878742 0.8488353 0.034722222 0.8224852
10  9   7.8472558    766.65939 0.010235648 0.8401469 0.007194245 0.8165680
11 10   0.0000000   1131.74617 0.000000000 0.8401469 0.000000000 0.8165680
12 11  19.6818394   1698.64910 0.011586760 0.8304123 0.014492754 0.8047337
13 12 112.5585923   2500.60892 0.045012473 0.7930334 0.044117647 0.7692308
14 13  76.8430786   3426.37023 0.022426963 0.7752481 0.015384615 0.7573964
15 14   0.0000000   4968.01401 0.000000000 0.7752481 0.000000000 0.7573964
16 15 398.1827812   7488.93955 0.053169448 0.7340285 0.046875000 0.7218935
17 16   0.0000000  10147.78922 0.000000000 0.7340285 0.000000000 0.7218935
   rule.name
1    TI.set1
2    TI.set1
3    TI.set1
4    TI.set1
5    TI.set1
6    TI.set1
7    TI.set1
8    TI.set1
9    TI.set1
10   TI.set1
11   TI.set1
12   TI.set1
13   TI.set1
14   TI.set1
15   TI.set1
16   TI.set1
17   TI.set1
> 
> # ----------------------------------------------------------------------
> # Bounded IPW
> # ----------------------------------------------------------------------
> IPW.St.1 <- getIPWeights(OData, intervened_TRT = "TI.set1") %>%
+              survDirectIPW(OData)
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> IPW.St.1[]
            est_name  t  sum_Y_IPAW   sum_IPAW       risk     S.t.n
 1: DirectBoundedIPW  0    9.828827   225.6710 0.04355379 0.9564462
 2: DirectBoundedIPW  1   14.841714   308.6067 0.04809266 0.9519073
 3: DirectBoundedIPW  2   21.627479   430.0012 0.05029632 0.9497037
 4: DirectBoundedIPW  3   21.627479   606.0012 0.03568884 0.9643112
 5: DirectBoundedIPW  4   43.571094   868.0025 0.05019697 0.9498030
 6: DirectBoundedIPW  5   61.760385  1241.4314 0.04974933 0.9502507
 7: DirectBoundedIPW  6   66.382274  1802.6454 0.03682492 0.9631751
 8: DirectBoundedIPW  7  116.322109  2638.1985 0.04409149 0.9559085
 9: DirectBoundedIPW  8  198.486284  3871.7562 0.05126518 0.9487348
10: DirectBoundedIPW  9  254.941362  5714.0214 0.04461680 0.9553832
11: DirectBoundedIPW 10  254.941362  8456.0006 0.03014917 0.9698508
12: DirectBoundedIPW 11  397.563386 12563.9928 0.03164308 0.9683569
13: DirectBoundedIPW 12 1225.200094 18784.3937 0.06522436 0.9347756
14: DirectBoundedIPW 13 1816.300699 27581.8941 0.06585120 0.9341488
15: DirectBoundedIPW 14 1816.300699 40628.9102 0.04470464 0.9552954
16: DirectBoundedIPW 15 4927.103677 60323.6409 0.08167782 0.9183222
> 
> # ----------------------------------------------------------------------
> # IPW-MSM for hazard
> # ----------------------------------------------------------------------
> wts.DT.1 <- getIPWeights(OData = OData, intervened_TRT = "TI.set1", rule_name = "TI1")
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> wts.DT.0 <- getIPWeights(OData = OData, intervened_TRT = "TI.set0", rule_name = "TI0")
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> survMSM_res <- survMSM(list(wts.DT.1, wts.DT.0), OData, t_breaks = c(1:8,12,16)-1,)
[1] "performing estimation for the following TRT/MONITOR rules found in column 'rule.name': TI0,TI1"
[1] "periods"
 [1]  0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15
[1] "defined t.dummy: Periods.0to0"
[1] "defined t.dummy: Periods.1to1"
[1] "defined t.dummy: Periods.2to2"
[1] "defined t.dummy: Periods.3to3"
[1] "defined t.dummy: Periods.4to4"
[1] "defined t.dummy: Periods.5to5"
[1] "defined t.dummy: Periods.6to6"
[1] "defined t.dummy: Periods.7to7"
[1] "defined t.dummy: Periods.8to11"
[1] "defined t.dummy: Periods.12to15"
[1] "Periods.0to0_TI0"
[1] "Periods.1to1_TI0"
[1] "Periods.2to2_TI0"
[1] "Periods.3to3_TI0"
[1] "Periods.4to4_TI0"
[1] "Periods.5to5_TI0"
[1] "Periods.6to6_TI0"
[1] "Periods.7to7_TI0"
[1] "Periods.8to11_TI0"
[1] "Periods.12to15_TI0"
[1] "Periods.0to0_TI1"
[1] "Periods.1to1_TI1"
[1] "Periods.2to2_TI1"
[1] "Periods.3to3_TI1"
[1] "Periods.4to4_TI1"
[1] "Periods.5to5_TI1"
[1] "Periods.6to6_TI1"
[1] "Periods.7to7_TI1"
[1] "Periods.8to11_TI1"
[1] "Periods.12to15_TI1"
...fitting hazard MSM with speedglm::speedglm.wfit...
[1] "MSM fits"
  Periods.0to0_TI0   Periods.1to1_TI0   Periods.2to2_TI0   Periods.3to3_TI0 
     -5.465039e+00      -4.324378e+00      -4.012934e+00      -1.166619e+15 
  Periods.4to4_TI0   Periods.5to5_TI0   Periods.6to6_TI0   Periods.7to7_TI0 
     -6.871355e+14      -4.884654e+14      -6.732368e+00      -6.414551e+00 
 Periods.8to11_TI0 Periods.12to15_TI0   Periods.0to0_TI1   Periods.1to1_TI1 
     -2.490327e+15      -3.057464e+15      -3.089228e+00      -4.070768e+00 
  Periods.2to2_TI1   Periods.3to3_TI1   Periods.4to4_TI1   Periods.5to5_TI1 
     -4.097356e+00      -1.444049e+01      -3.626218e+00      -4.172158e+00 
  Periods.6to6_TI1   Periods.7to7_TI1  Periods.8to11_TI1 Periods.12to15_TI1 
     -5.928687e+00      -3.921940e+00      -4.645602e+00      -3.410729e+00 
...evaluating MSM-based survival curves...
...evaluating SEs based on MSM hazard fit and the estimated IC...
[1] "Should all be very small: "
  Periods.0to0_TI0   Periods.1to1_TI0   Periods.2to2_TI0   Periods.3to3_TI0 
      8.745296e-16       4.214695e-15       8.819608e-15       7.293270e+00 
  Periods.4to4_TI0   Periods.5to5_TI0   Periods.6to6_TI0   Periods.7to7_TI0 
      6.561300e+01       4.445403e+02       5.648100e-14       5.676302e-14 
 Periods.8to11_TI0 Periods.12to15_TI0   Periods.0to0_TI1   Periods.1to1_TI1 
      2.030033e+02       7.899748e+02       3.196367e-18       3.295818e-18 
  Periods.2to2_TI1   Periods.3to3_TI1   Periods.4to4_TI1   Periods.5to5_TI1 
      5.938153e-18       4.879654e-08       5.552308e-18       8.758887e-18 
  Periods.6to6_TI1   Periods.7to7_TI1  Periods.8to11_TI1 Periods.12to15_TI1 
      9.627973e-20       1.899923e-17       1.180759e-18       4.982015e-15 
[1] "Should all be very small: "
  Periods.0to0_TI0   Periods.1to1_TI0   Periods.2to2_TI0   Periods.3to3_TI0 
      8.645048e-14       4.643372e-14       2.150078e-14       3.336980e+14 
  Periods.4to4_TI0   Periods.5to5_TI0   Periods.6to6_TI0   Periods.7to7_TI0 
      7.563694e+14       1.183848e+15       9.715875e-15       1.095287e-14 
 Periods.8to11_TI0 Periods.12to15_TI0   Periods.0to0_TI1   Periods.1to1_TI1 
      1.830248e+14       5.408850e+14       2.038744e-15       4.102638e-15 
  Periods.2to2_TI1   Periods.3to3_TI1   Periods.4to4_TI1   Periods.5to5_TI1 
      5.644245e-15       1.000001e+00       1.646367e-15       3.270332e-15 
  Periods.6to6_TI1   Periods.7to7_TI1  Periods.8to11_TI1 Periods.12to15_TI1 
      1.486411e-16       2.648109e-15       3.026786e-17       8.738800e-15 
[1] "Should all be very small: "
 [1] 3.628268e-16 2.387874e-16 1.344854e-16 1.344854e-16 1.344854e-16
 [6] 1.344854e-16 1.449570e-16 1.619186e-16 1.619186e-16 1.619186e-16
[11] 1.619186e-16 1.619186e-16 1.619186e-16 1.619186e-16 1.619186e-16
[16] 1.619186e-16
[1] "Should all be very small: "
 [1] 8.519431e-17 1.505626e-17 1.044968e-16 4.951408e-07 4.823035e-07
 [6] 4.749798e-07 4.737188e-07 4.645200e-07 4.601013e-07 4.557247e-07
[11] 4.513896e-07 4.470959e-07 4.328058e-07 4.189726e-07 4.055814e-07
[16] 3.926183e-07
> survMSM_res$St
$TI0
 [1] 0.9957857 0.9827720 0.9653188 0.9653188 0.9653188 0.9653188 0.9641698
 [8] 0.9625935 0.9625935 0.9625935 0.9625935 0.9625935 0.9625935 0.9625935
[15] 0.9625935 0.9625935

$TI1
 [1] 0.9564462 0.9403990 0.9250282 0.9250277 0.9010449 0.8873627 0.8850068
 [8] 0.8678217 0.8595666 0.8513901 0.8432913 0.8352696 0.8085728 0.7827293
[15] 0.7577119 0.7334940

> 
> # ----------------------------------------------------------------------
> # Sequential G-COMP
> # ----------------------------------------------------------------------
> t.surv <- c(0:15)
> Qforms <- rep.int("Q.kplus1 ~ CVD + highA1c + N + lastNat1 + TI + TI.tminus1", (max(t.surv)+1))
> params = list(fit.package = "speedglm", fit.algorithm = "glm")
> 
> ## Not run: 
> ##D gcomp_est <- fitSeqGcomp(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D                           Qforms = Qforms, params_Q = params, stratifyQ_by_rule = FALSE)
> ##D gcomp_est[]
> ## End(Not run)
> # ----------------------------------------------------------------------
> # TMLE
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D tmle_est <- fitTMLE(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D                     Qforms = Qforms, params_Q = params, stratifyQ_by_rule = TRUE)
> ##D tmle_est[]
> ## End(Not run)
> 
> # ----------------------------------------------------------------------
> # Running IPW-Adjusted KM with optional user-specified weights:
> # ----------------------------------------------------------------------
> addedWts_DT <- OdataDT[, c("ID", "t"), with = FALSE]
> addedWts_DT[, new.wts := sample.int(10, nrow(OdataDT), replace = TRUE)/10]
> survNP_res_addedWts <- survNPMSM(wts.DT.1, OData, weights = addedWts_DT)
> 
> # ----------------------------------------------------------------------
> # Multivariate Propensity Score Regressions
> # ----------------------------------------------------------------------
> gform_CENS <- "C + TI + N ~ highA1c + lastNat1"
> OData <- fitPropensity(OData, gform_CENS = gform_CENS, gform_TRT = gform_TRT,
+                         gform_MONITOR = gform_MONITOR)
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "gC" "gA" "gN"
[1] "Outcomes: "
[1] ""
[1] "No. of regressions: 3"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "C,TI,N"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: C, TI, N"
[1] "Predictors: highA1c, lastNat1"
[1] "No. of regressions: 3"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(C|highA1c, lastNat1);\\ Stratify: "
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|C, highA1c, lastNat1);\\ Stratify: C == 0"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(N|C, TI, highA1c, lastNat1);\\ Stratify: C == 0 & TI == 0"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: CVD, highA1c, N.tminus1"
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "N"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: N"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(N|);\\ Stratify: "
[1] "fitting the model: P(C|highA1c, lastNat1);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
    Intercept       highA1c      lastNat1 
-2.656607e+01  9.238692e-12  2.688942e-12 
[1] "fitting the model: P(TI|C, highA1c, lastNat1);\\ Stratify: C == 0"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
  Intercept           C     highA1c    lastNat1 
 0.87385792          NA -0.18986136 -0.06706656 
[1] "fitting the model: P(N|C, TI, highA1c, lastNat1);\\ Stratify: C == 0 & TI == 0"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
   Intercept            C           TI      highA1c     lastNat1 
-0.025688525           NA           NA  0.001591313 -0.012014026 
[1] "fitting the model: P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
 Intercept        CVD    highA1c  N.tminus1 
 0.6250400  1.3852271 -0.1432429  0.1288901 
[1] "fitting the model: P(N|);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
  Intercept 
-0.01358231 
> 
> # ----------------------------------------------------------------------
> # Fitting Propensity scores with Random Forests:
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "randomForest")
> ##D require("h2o")
> ##D h2o::h2o.init(nthreads = -1)
> ##D gform_CENS <- "C ~ highA1c + lastNat1"
> ##D OData <- fitPropensity(OData, gform_CENS = gform_CENS,
> ##D                         gform_TRT = gform_TRT,
> ##D                         gform_MONITOR = gform_MONITOR,
> ##D                         stratify_CENS = stratify_CENS)
> ##D 
> ##D # For Gradient Boosting machines:
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "gbm")
> ##D # Use `H2O-3` distributed implementation of GLM
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "glm")
> ##D # Use Deep Neural Nets:
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "deeplearning")
> ## End(Not run)
> 
> # ----------------------------------------------------------------------
> # Fitting different models with different algorithms
> # Fine tuning modeling with optional tuning parameters.
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D params_TRT = list(fit.package = "h2o", fit.algorithm = "gbm", ntrees = 50,
> ##D     learn_rate = 0.05, sample_rate = 0.8, col_sample_rate = 0.8,
> ##D     balance_classes = TRUE)
> ##D params_CENS = list(fit.package = "speedglm", fit.algorithm = "glm")
> ##D params_MONITOR = list(fit.package = "speedglm", fit.algorithm = "glm")
> ##D OData <- fitPropensity(OData,
> ##D             gform_CENS = gform_CENS, stratify_CENS = stratify_CENS, params_CENS = params_CENS,
> ##D             gform_TRT = gform_TRT, params_TRT = params_TRT,
> ##D             gform_MONITOR = gform_MONITOR, params_MONITOR = params_MONITOR)
> ## End(Not run)
> 
> # ----------------------------------------------------------------------
> # Running TMLE based on the previous fit of the propensity scores.
> # Also applying Random Forest to estimate the sequential outcome model
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D t.surv <- c(0:5)
> ##D Qforms <- rep.int("Q.kplus1 ~ CVD + highA1c + N + lastNat1 + TI + TI.tminus1", (max(t.surv)+1))
> ##D params_Q = list(fit.package = "h2o", fit.algorithm = "randomForest",
> ##D                 ntrees = 100, learn_rate = 0.05, sample_rate = 0.8,
> ##D                 col_sample_rate = 0.8, balance_classes = TRUE)
> ##D tmle_est <- fitTMLE(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D             Qforms = Qforms, params_Q = params_Q,
> ##D             stratifyQ_by_rule = TRUE)
> ## End(Not run)
> 
> ## Not run: 
> ##D t.surv <- c(0:5)
> ##D Qforms <- rep.int("Q.kplus1 ~ CVD + highA1c + N + lastNat1 + TI + TI.tminus1", (max(t.surv)+1))
> ##D params_Q = list(fit.package = "h2o", fit.algorithm = "randomForest",
> ##D                 ntrees = 100, learn_rate = 0.05, sample_rate = 0.8,
> ##D                 col_sample_rate = 0.8, balance_classes = TRUE)
> ##D tmle_est <- fitTMLE(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D             Qforms = Qforms, params_Q = params_Q,
> ##D             stratifyQ_by_rule = FALSE)
> ## End(Not run)
> 
> 
> 
> 
> cleanEx()

detaching ‘package:magrittr’, ‘package:data.table’

> nameEx("survMSM")
> ### * survMSM
> 
> flush(stderr()); flush(stdout())
> 
> ### Name: survMSM
> ### Title: Estimate Survival with a particular MSM for the survival-hazard
> ###   function using previously fitted weights.
> ### Aliases: survMSM
> 
> ### ** Examples
> 
> #-------------------------------------------------------------------
> # Simulated data with informative right-censoring
> #-------------------------------------------------------------------
> require("data.table")
Loading required package: data.table
> require("magrittr")
Loading required package: magrittr
> data(OdataCatCENS)
> OdataDT <- as.data.table(OdataCatCENS, key=c(ID, t))
> # Indicator that the person has never been treated in the past:
> OdataDT[, "barTIm1eq0" := as.integer(c(0, cumsum(TI)[-.N]) %in% 0), by = ID]
> OdataDT[, ("N.tminus1") := shift(get("N"), n = 1L, type = "lag", fill = 1L), by = ID]
> 
> #-------------------------------------------------------------------
> # Regressions for modeling the exposure (TRT)
> #-------------------------------------------------------------------
> gform_TRT <- "TI ~ CVD + highA1c + N.tminus1"
> # Fit a separate model for TRT (stratify) for each of the following subsets:
> stratify_TRT <- list(
+   TI=c(
+        # MODEL TI AT t=0
+        "t == 0L",
+        # MODEL TRT INITATION WHEN MONITORED
+        "(t > 0L) & (N.tminus1 == 1L) & (barTIm1eq0 == 1L)",
+        # MODEL TRT INITATION WHEN NOT MONITORED
+        "(t > 0L) & (N.tminus1 == 0L) & (barTIm1eq0 == 1L)",
+        # MODEL TRT CONTINUATION (BOTH MONITORED AND NOT MONITORED)
+        "(t > 0L) & (barTIm1eq0 == 1L)"
+       ))
> 
> #-------------------------------------------------------------------
> # Regressions for modeling the categorical censoring (CENS)
> #-------------------------------------------------------------------
> gform_CENS <- c("CatC ~ highA1c")
> # stratify by time-points (separate model for all t<16 and t=16)
> stratify_CENS <- list(CatC=c("t < 16", "t == 16"))
> 
> #-------------------------------------------------------------------
> # Regressions for modeling the monitoring regimen (MONITOR)
> #-------------------------------------------------------------------
> # Intercept only model, pooling across all time points t
> gform_MONITOR <- "N ~ 1"
> 
> #-------------------------------------------------------------------
> # Define the counterfactual monitoring regimen of interest
> #-------------------------------------------------------------------
> # probability of being monitored at each t is 0.1
> OdataDT[, "gstar.N" := 0.1]
> 
> # Define two dynamic rules: dlow & dhigh
> OdataDT <- defineIntervedTRT(OdataDT, theta = c(0,1), ID = "ID", t = "t", I = "highA1c",
+                             CENS = "C", TRT = "TI", MONITOR = "N", tsinceNis1 = "lastNat1",
+                             new.TRT.names = c("dlow", "dhigh"), return.allcolumns = TRUE)
> 
> #-------------------------------------------------------------------
> # Import data into stremr object
> #-------------------------------------------------------------------
> OData <- importData(OdataDT, ID = "ID", t = "t", covars = c("highA1c", "lastNat1"),
+                     CENS = "CatC", TRT = "TI", MONITOR = "N", OUTCOME = "Y.tplus1")
[1] "Using the following stremr options/settings: "

List of 8
 $ fit.package       : chr "speedglm"
 $ fit.algorithm     : chr "glm"
 $ bin.method        : chr "equal.mass"
 $ nbins             : num 10
 $ maxncats          : num 20
 $ maxNperBin        : num 500
 $ lower_bound_zero_Q: logi TRUE
 $ skip_update_zero_Q: logi TRUE 
[1] "...detecting the type of each input column..."
> 
> #-------------------------------------------------------------------
> # Estimate Propensity scores
> #-------------------------------------------------------------------
> OData <- fitPropensity(OData, gform_CENS = gform_CENS, gform_TRT = gform_TRT,
+                       stratify_TRT = stratify_TRT, gform_MONITOR = gform_MONITOR)
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "gC" "gA" "gN"
[1] "Outcomes: "
[1] ""
[1] "No. of regressions: 3"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "CatC"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: CatC"
[1] "Predictors: highA1c"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
...fitting a model for categorical censoring...
[1] "CategorModel outcome: CatC"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: CatC_B.1, CatC_B.2, CatC_B.3"
[1] "Predictors: highA1c"
[1] "No. of regressions: 3"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(CatC_B.1|highA1c);\\ Stratify: "
[1] "New instance of BinaryOutcomeModel :"
[1] "P(CatC_B.2|highA1c);\\ Stratify: "
[1] "New instance of BinaryOutcomeModel :"
[1] "P(CatC_B.3|highA1c);\\ Stratify: "
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: CVD, highA1c, N.tminus1"
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "StratifiedModel outcome: TI"
[1] "StratifiedModel expressions: (t == 0L,(t > 0L) & (N.tminus1 == 1L) & (barTIm1eq0 == 1L),(t > 0L) & (N.tminus1 == 0L) & (barTIm1eq0 == 1L),(t > 0L) & (barTIm1eq0 == 1L))"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI, TI, TI, TI"
[1] "Predictors: CVD, highA1c, N.tminus1"
[1] "No. of regressions: 4"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|CVD, highA1c, N.tminus1);\\ Stratify: t == 0L"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|CVD, highA1c, N.tminus1);\\ Stratify: (t > 0L) & (N.tminus1 == 1L) & (barTIm1eq0 == 1L)"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|CVD, highA1c, N.tminus1);\\ Stratify: (t > 0L) & (N.tminus1 == 0L) & (barTIm1eq0 == 1L)"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|CVD, highA1c, N.tminus1);\\ Stratify: (t > 0L) & (barTIm1eq0 == 1L)"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "N"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: N"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(N|);\\ Stratify: "
making matrix for dummies for cat. censoring, reference category is 0
[1] "performing fitting for categorical outcome: CatC"
[1] "freq counts by bin for categorical outcome: "

   0    1    2 
7469  347  314 
[1] "binned dataset: "
     sA CatC_B.1 CatC_B.2 CatC_B.3
[1,]  0        0        0       NA
[2,]  0        0        0       NA
[3,]  1        1       NA       NA
[4,]  0        0        0       NA
[5,]  0        0        0       NA
[1] "fitting the model: P(CatC_B.1|highA1c);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
 Intercept    highA1c 
-3.1443119  0.1629684 
[1] "fitting the model: P(CatC_B.2|highA1c);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
  Intercept     highA1c 
-3.15583618 -0.06991252 
[1] "fitting the model: P(CatC_B.3|highA1c);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
Intercept   highA1c 
       NA        NA 
fit for CatC var succeeded...
[1] "performing fitting for outcome based on stratified model for outcome: TI"
[1] "fitting the model: P(TI|CVD, highA1c, N.tminus1);\\ Stratify: t == 0L"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
Intercept       CVD   highA1c N.tminus1 
-2.156898  2.117370  2.269857        NA 
[1] "fitting the model: P(TI|CVD, highA1c, N.tminus1);\\ Stratify: (t > 0L) & (N.tminus1 == 1L) & (barTIm1eq0 == 1L)"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
 Intercept        CVD    highA1c  N.tminus1 
-2.1141458  0.9100488  2.1714524         NA 
[1] "fitting the model: P(TI|CVD, highA1c, N.tminus1);\\ Stratify: (t > 0L) & (N.tminus1 == 0L) & (barTIm1eq0 == 1L)"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
    Intercept           CVD       highA1c     N.tminus1 
-2.656607e+01  2.444839e-12  2.082888e-12            NA 
[1] "fitting the model: P(TI|CVD, highA1c, N.tminus1);\\ Stratify: (t > 0L) & (barTIm1eq0 == 1L)"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
  Intercept         CVD     highA1c   N.tminus1 
-21.2548627   0.9100488   2.1714524  19.1407169 
fit for TI var succeeded...
[1] "fitting the model: P(N|);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
  Intercept 
-0.02436859 
[1] "performing prediction for categorical outcome: CatC"
[1] "performing prediction for outcome based on stratified model: TI"
> 
> #-------------------------------------------------------------------
> # Defining weights for two dynamic regimens "dlow" and "dhigh"
> #-------------------------------------------------------------------
> wts.St.dlow <- getIPWeights(OData, intervened_TRT = "dlow")
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> wts.St.dhigh <- getIPWeights(OData, intervened_TRT = "dhigh")
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> 
> # ------------------------------------------------------------------
> # Estimate survival with IPW-adjusted MSM for the hazard (logistic model)
> # 1. Saturated model for time points 0 to 7
> # 2. Smoothing with one hazard coefficient over time-points 8 to 11
> # 3. Smoothing with one hazard coefficient over time-points 12 to 15
> # ------------------------------------------------------------------
> IPW_MSM_res <- survMSM(OData, wts_data = list(dlow = wts.St.dlow, dhigh = wts.St.dhigh),
+                       t_breaks = c(1:8,12,16)-1,
+                       est_name = "IPAW", getSEs = TRUE)
[1] "performing estimation for the following TRT/MONITOR rules found in column 'rule.name': dhigh,dlow"
[1] "periods"
 [1]  0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15
[1] "defined t.dummy: Periods.0to0"
[1] "defined t.dummy: Periods.1to1"
[1] "defined t.dummy: Periods.2to2"
[1] "defined t.dummy: Periods.3to3"
[1] "defined t.dummy: Periods.4to4"
[1] "defined t.dummy: Periods.5to5"
[1] "defined t.dummy: Periods.6to6"
[1] "defined t.dummy: Periods.7to7"
[1] "defined t.dummy: Periods.8to11"
[1] "defined t.dummy: Periods.12to15"
[1] "Periods.0to0_dhigh"
[1] "Periods.1to1_dhigh"
[1] "Periods.2to2_dhigh"
[1] "Periods.3to3_dhigh"
[1] "Periods.4to4_dhigh"
[1] "Periods.5to5_dhigh"
[1] "Periods.6to6_dhigh"
[1] "Periods.7to7_dhigh"
[1] "Periods.8to11_dhigh"
[1] "Periods.12to15_dhigh"
[1] "Periods.0to0_dlow"
[1] "Periods.1to1_dlow"
[1] "Periods.2to2_dlow"
[1] "Periods.3to3_dlow"
[1] "Periods.4to4_dlow"
[1] "Periods.5to5_dlow"
[1] "Periods.6to6_dlow"
[1] "Periods.7to7_dlow"
[1] "Periods.8to11_dlow"
[1] "Periods.12to15_dlow"
...fitting hazard MSM with speedglm::speedglm.wfit...
[1] "MSM fits"
  Periods.0to0_dhigh   Periods.1to1_dhigh   Periods.2to2_dhigh 
           -4.417589            -3.537867            -3.664979 
  Periods.3to3_dhigh   Periods.4to4_dhigh   Periods.5to5_dhigh 
           -2.797020            -3.519637            -3.724497 
  Periods.6to6_dhigh   Periods.7to7_dhigh  Periods.8to11_dhigh 
           -4.037867            -5.946589            -3.458545 
Periods.12to15_dhigh    Periods.0to0_dlow    Periods.1to1_dlow 
           -3.847097            -4.005033           -18.702066 
   Periods.2to2_dlow    Periods.3to3_dlow    Periods.4to4_dlow 
           -3.156493            -4.107851            -5.730526 
   Periods.5to5_dlow    Periods.6to6_dlow    Periods.7to7_dlow 
          -18.660726            -3.761142            -5.408544 
  Periods.8to11_dlow  Periods.12to15_dlow 
           -4.537173            -4.065780 
...evaluating MSM-based survival curves...
...evaluating SEs based on MSM hazard fit and the estimated IC...
[1] "Should all be very small: "
  Periods.0to0_dhigh   Periods.1to1_dhigh   Periods.2to2_dhigh 
        3.692004e-16         3.902657e-17         3.199205e-16 
  Periods.3to3_dhigh   Periods.4to4_dhigh   Periods.5to5_dhigh 
        1.642194e-16         7.904341e-17         4.060504e-17 
  Periods.6to6_dhigh   Periods.7to7_dhigh  Periods.8to11_dhigh 
        9.295049e-18         4.971718e-18         9.373709e-17 
Periods.12to15_dhigh    Periods.0to0_dlow    Periods.1to1_dlow 
        1.738398e-17         3.037523e-18         1.172361e-09 
   Periods.2to2_dlow    Periods.3to3_dlow    Periods.4to4_dlow 
        8.802187e-18         1.781393e-18         7.420360e-19 
   Periods.5to5_dlow    Periods.6to6_dlow    Periods.7to7_dlow 
        7.141644e-10         2.887834e-18         3.107821e-19 
  Periods.8to11_dlow  Periods.12to15_dlow 
        3.656979e-19         5.560237e-18 
[1] "Should all be very small: "
  Periods.0to0_dhigh   Periods.1to1_dhigh   Periods.2to2_dhigh 
        3.382787e-14         1.702522e-15         1.791329e-14 
  Periods.3to3_dhigh   Periods.4to4_dhigh   Periods.5to5_dhigh 
        4.798310e-15         5.671419e-15         3.916612e-15 
  Periods.6to6_dhigh   Periods.7to7_dhigh  Periods.8to11_dhigh 
        1.487475e-15         6.073501e-15         3.341697e-15 
Periods.12to15_dhigh    Periods.0to0_dlow    Periods.1to1_dlow 
        1.545485e-15         8.792215e-16         1.013171e+00 
   Periods.2to2_dlow    Periods.3to3_dlow    Periods.4to4_dlow 
        1.694403e-15         8.697920e-16         2.402313e-15 
   Periods.5to5_dlow    Periods.6to6_dlow    Periods.7to7_dlow 
        1.013171e+00         1.735627e-15         1.137578e-15 
  Periods.8to11_dlow  Periods.12to15_dlow 
        2.138049e-16         3.872133e-15 
[1] "Should all be very small: "
 [1] 3.996203e-16 3.427917e-16 8.527763e-17 1.625429e-16 1.555619e-17
 [6] 6.305893e-17 7.648191e-17 6.696243e-17 2.022233e-17 8.837280e-17
[11] 1.692373e-16 2.338137e-16 2.071149e-16 1.800730e-16 1.530774e-16
[16] 1.298038e-16
[1] "Should all be very small: "
 [1] 1.457280e-17 7.509928e-09 7.203251e-09 7.086723e-09 7.063799e-09
 [6] 1.442573e-08 1.409785e-08 1.403500e-08 1.388637e-08 1.373931e-08
[11] 1.359381e-08 1.344984e-08 1.322307e-08 1.300013e-08 1.278094e-08
[16] 1.256545e-08
> names(IPW_MSM_res)
 [1] "est_name"      "periods"       "St"            "ht"           
 [5] "MSM.fit"       "MSM.intervals" "IC.Var.S.d"    "nID"          
 [9] "nobs"          "wts_data"      "use_weights"   "trunc_weights"
> # Survival estimates over time
> IPW_MSM_res$St
$dhigh
 [1] 0.9880805 0.9601635 0.9361925 0.8823751 0.8569992 0.8368110 0.8223095
 [8] 0.8201650 0.7951376 0.7708739 0.7473507 0.7245452 0.7094054 0.6945819
[15] 0.6800681 0.6658577

$dlow
 [1] 0.9821025 0.9821025 0.9419971 0.9267584 0.9237604 0.9237604 0.9027647
 [8] 0.8987400 0.8892221 0.8798050 0.8704876 0.8612689 0.8467476 0.8324710
[15] 0.8184352 0.8046360

> # SE estimates for each time point:
> IPW_MSM_res$IC.Var.S.d$dhigh$se.S
 [1] 0.003819139 0.009464465 0.012625196 0.019848836 0.021772080 0.023142642
 [7] 0.024343248 0.024392364 0.024635518 0.026333647 0.028998794 0.032206573
[13] 0.032066754 0.032775730 0.034180888 0.036114441
> IPW_MSM_res$IC.Var.S.d$dlow$se.S
 [1] 0.009975771 0.009975771 0.022318437 0.025420060 0.025583543 0.025583543
 [7] 0.030539901 0.030785193 0.031442557 0.033791216 0.037419276 0.041914714
[13] 0.042645344 0.045682100 0.050403853 0.056215088
> # MSM coefficient fits
> IPW_MSM_res$MSM.fit
$coef
  Periods.0to0_dhigh   Periods.1to1_dhigh   Periods.2to2_dhigh 
           -4.417589            -3.537867            -3.664979 
  Periods.3to3_dhigh   Periods.4to4_dhigh   Periods.5to5_dhigh 
           -2.797020            -3.519637            -3.724497 
  Periods.6to6_dhigh   Periods.7to7_dhigh  Periods.8to11_dhigh 
           -4.037867            -5.946589            -3.458545 
Periods.12to15_dhigh    Periods.0to0_dlow    Periods.1to1_dlow 
           -3.847097            -4.005033           -18.702066 
   Periods.2to2_dlow    Periods.3to3_dlow    Periods.4to4_dlow 
           -3.156493            -4.107851            -5.730526 
   Periods.5to5_dlow    Periods.6to6_dlow    Periods.7to7_dlow 
          -18.660726            -3.761142            -5.408544 
  Periods.8to11_dlow  Periods.12to15_dlow 
           -4.537173            -4.065780 

$linkfun
[1] "logit_linkinv"

$fitfunname
[1] "speedglm"

> 
> # ------------------------------------------------------------------
> # Generate automatic html report with results of the analysis
> # This assumes that pandoc is already installed
> # For more information, go to: http://pandoc.org/installing.html
> # ------------------------------------------------------------------
> ## Not run: 
> ##D make_report_rmd(OData, MSM = IPW_MSM_res,
> ##D   AddFUPtables = TRUE,
> ##D   RDtables = get_MSM_RDs(IPW_MSM_res, t.periods.RDs = c(12, 15), getSEs = FALSE),
> ##D   WTtables = get_wtsummary(IPW_MSM_res$wts_data,
> ##D     cutoffs = c(0, 0.5, 1, 10, 20, 30, 40, 50, 100, 150), by.rule = TRUE),
> ##D   file.name = "sim.data.example.fup",
> ##D   title = "Custom Report Title",
> ##D   author = "Jane Doe",
> ##D   y_legend = 0.95)
> ## End(Not run)
> 
> 
> 
> cleanEx()

detaching ‘package:magrittr’, ‘package:data.table’

> nameEx("survNPMSM")
> ### * survNPMSM
> 
> flush(stderr()); flush(stdout())
> 
> ### Name: survNPMSM
> ### Title: Non-parametric (saturated) MSM for survival based on previously
> ###   evaluated IP weights.
> ### Aliases: survNPMSM
> 
> ### ** Examples
> 
> options(stremr.verbose = TRUE)
> require("data.table")
Loading required package: data.table
> set_all_stremr_options(fit.package = "speedglm", fit.algorithm = "glm")
> 
> # ----------------------------------------------------------------------
> # Simulated Data
> # ----------------------------------------------------------------------
> data(OdataNoCENS)
> OdataDT <- as.data.table(OdataNoCENS, key=c(ID, t))
> 
> # define lagged N, first value is always 1 (always monitored at the first time point):
> OdataDT[, ("N.tminus1") := shift(get("N"), n = 1L, type = "lag", fill = 1L), by = ID]
> OdataDT[, ("TI.tminus1") := shift(get("TI"), n = 1L, type = "lag", fill = 1L), by = ID]
> 
> # ----------------------------------------------------------------------
> # Define intervention (always treated):
> # ----------------------------------------------------------------------
> OdataDT[, ("TI.set1") := 1L]
> OdataDT[, ("TI.set0") := 0L]
> 
> # ----------------------------------------------------------------------
> # Import Data
> # ----------------------------------------------------------------------
> OData <- importData(OdataDT, ID = "ID", t = "t", covars = c("highA1c", "lastNat1", "N.tminus1"),
+                     CENS = "C", TRT = "TI", MONITOR = "N", OUTCOME = "Y.tplus1")
[1] "Using the following stremr options/settings: "

List of 8
 $ fit.package       : chr "speedglm"
 $ fit.algorithm     : chr "glm"
 $ bin.method        : chr "equal.mass"
 $ nbins             : num 10
 $ maxncats          : num 20
 $ maxNperBin        : num 500
 $ lower_bound_zero_Q: logi TRUE
 $ skip_update_zero_Q: logi TRUE 
[1] "...detecting the type of each input column..."
> 
> # ----------------------------------------------------------------------
> # Model the Propensity Scores
> # ----------------------------------------------------------------------
> gform_CENS <- "C ~ highA1c + lastNat1"
> gform_TRT = "TI ~ CVD + highA1c + N.tminus1"
> gform_MONITOR <- "N ~ 1"
> stratify_CENS <- list(C=c("t < 16", "t == 16"))
> 
> # ----------------------------------------------------------------------
> # Fit Propensity Scores
> # ----------------------------------------------------------------------
> OData <- fitPropensity(OData, gform_CENS = gform_CENS,
+                         gform_TRT = gform_TRT,
+                         gform_MONITOR = gform_MONITOR,
+                         stratify_CENS = stratify_CENS)
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "gC" "gA" "gN"
[1] "Outcomes: "
[1] ""
[1] "No. of regressions: 3"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "C"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: C"
[1] "Predictors: highA1c, lastNat1"
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "StratifiedModel outcome: C"
[1] "StratifiedModel expressions: (t < 16,t == 16)"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: C, C"
[1] "Predictors: highA1c, lastNat1"
[1] "No. of regressions: 2"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(C|highA1c, lastNat1);\\ Stratify: t < 16"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(C|highA1c, lastNat1);\\ Stratify: t == 16"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: CVD, highA1c, N.tminus1"
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "N"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: N"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(N|);\\ Stratify: "
[1] "performing fitting for outcome based on stratified model for outcome: C"
[1] "fitting the model: P(C|highA1c, lastNat1);\\ Stratify: t < 16"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
    Intercept       highA1c      lastNat1 
-2.656607e+01  8.128911e-12  5.225396e-12 
[1] "fitting the model: P(C|highA1c, lastNat1);\\ Stratify: t == 16"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
    Intercept       highA1c      lastNat1 
-2.656607e+01 -5.129323e-13 -3.008816e-13 
fit for C var succeeded...
[1] "fitting the model: P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
 Intercept        CVD    highA1c  N.tminus1 
 0.6250400  1.3852271 -0.1432429  0.1288901 
[1] "fitting the model: P(N|);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
  Intercept 
-0.01358231 
[1] "performing prediction for outcome based on stratified model: C"
> 
> # ----------------------------------------------------------------------
> # IPW Ajusted KM or Saturated MSM
> # ----------------------------------------------------------------------
> require("magrittr")
Loading required package: magrittr
> AKME.St.1 <- getIPWeights(OData, intervened_TRT = "TI.set1") %>%
+              survNPMSM(OData) %$%
+              IPW_estimates
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> AKME.St.1
    t  sum_Y_IPAW sum_all_IPAW          ht   St.IPTW       ht.KM     St.KM
1   0   1.6610718     38.13840 0.043553792 0.9564462 0.047337278 0.9526627
2   1   0.8070748     48.10323 0.016777974 0.9403990 0.018633540 0.9349112
3   2   1.0721508     65.59519 0.016344959 0.9250282 0.012658228 0.9230769
4   3   0.0000000     91.16229 0.000000000 0.9250282 0.000000000 0.9230769
5   4   3.4232039    132.03450 0.025926586 0.9010454 0.025641026 0.8994083
6   5   2.7647724    182.07477 0.015184819 0.8873632 0.026315789 0.8757396
7   6   0.6840395    257.65098 0.002654907 0.8850073 0.013513514 0.8639053
8   7   7.2912160    375.48517 0.019418120 0.8678221 0.013698630 0.8520710
9   8  11.8316412    540.78252 0.021878742 0.8488353 0.034722222 0.8224852
10  9   7.8472558    766.65939 0.010235648 0.8401469 0.007194245 0.8165680
11 10   0.0000000   1131.74617 0.000000000 0.8401469 0.000000000 0.8165680
12 11  19.6818394   1698.64910 0.011586760 0.8304123 0.014492754 0.8047337
13 12 112.5585923   2500.60892 0.045012473 0.7930334 0.044117647 0.7692308
14 13  76.8430786   3426.37023 0.022426963 0.7752481 0.015384615 0.7573964
15 14   0.0000000   4968.01401 0.000000000 0.7752481 0.000000000 0.7573964
16 15 398.1827812   7488.93955 0.053169448 0.7340285 0.046875000 0.7218935
17 16   0.0000000  10147.78922 0.000000000 0.7340285 0.000000000 0.7218935
   rule.name
1    TI.set1
2    TI.set1
3    TI.set1
4    TI.set1
5    TI.set1
6    TI.set1
7    TI.set1
8    TI.set1
9    TI.set1
10   TI.set1
11   TI.set1
12   TI.set1
13   TI.set1
14   TI.set1
15   TI.set1
16   TI.set1
17   TI.set1
> 
> # ----------------------------------------------------------------------
> # Bounded IPW
> # ----------------------------------------------------------------------
> IPW.St.1 <- getIPWeights(OData, intervened_TRT = "TI.set1") %>%
+              survDirectIPW(OData)
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> IPW.St.1[]
            est_name  t  sum_Y_IPAW   sum_IPAW       risk     S.t.n
 1: DirectBoundedIPW  0    9.828827   225.6710 0.04355379 0.9564462
 2: DirectBoundedIPW  1   14.841714   308.6067 0.04809266 0.9519073
 3: DirectBoundedIPW  2   21.627479   430.0012 0.05029632 0.9497037
 4: DirectBoundedIPW  3   21.627479   606.0012 0.03568884 0.9643112
 5: DirectBoundedIPW  4   43.571094   868.0025 0.05019697 0.9498030
 6: DirectBoundedIPW  5   61.760385  1241.4314 0.04974933 0.9502507
 7: DirectBoundedIPW  6   66.382274  1802.6454 0.03682492 0.9631751
 8: DirectBoundedIPW  7  116.322109  2638.1985 0.04409149 0.9559085
 9: DirectBoundedIPW  8  198.486284  3871.7562 0.05126518 0.9487348
10: DirectBoundedIPW  9  254.941362  5714.0214 0.04461680 0.9553832
11: DirectBoundedIPW 10  254.941362  8456.0006 0.03014917 0.9698508
12: DirectBoundedIPW 11  397.563386 12563.9928 0.03164308 0.9683569
13: DirectBoundedIPW 12 1225.200094 18784.3937 0.06522436 0.9347756
14: DirectBoundedIPW 13 1816.300699 27581.8941 0.06585120 0.9341488
15: DirectBoundedIPW 14 1816.300699 40628.9102 0.04470464 0.9552954
16: DirectBoundedIPW 15 4927.103677 60323.6409 0.08167782 0.9183222
> 
> # ----------------------------------------------------------------------
> # IPW-MSM for hazard
> # ----------------------------------------------------------------------
> wts.DT.1 <- getIPWeights(OData = OData, intervened_TRT = "TI.set1", rule_name = "TI1")
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> wts.DT.0 <- getIPWeights(OData = OData, intervened_TRT = "TI.set0", rule_name = "TI0")
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "TI"
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
> survMSM_res <- survMSM(list(wts.DT.1, wts.DT.0), OData, t_breaks = c(1:8,12,16)-1,)
[1] "performing estimation for the following TRT/MONITOR rules found in column 'rule.name': TI0,TI1"
[1] "periods"
 [1]  0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15
[1] "defined t.dummy: Periods.0to0"
[1] "defined t.dummy: Periods.1to1"
[1] "defined t.dummy: Periods.2to2"
[1] "defined t.dummy: Periods.3to3"
[1] "defined t.dummy: Periods.4to4"
[1] "defined t.dummy: Periods.5to5"
[1] "defined t.dummy: Periods.6to6"
[1] "defined t.dummy: Periods.7to7"
[1] "defined t.dummy: Periods.8to11"
[1] "defined t.dummy: Periods.12to15"
[1] "Periods.0to0_TI0"
[1] "Periods.1to1_TI0"
[1] "Periods.2to2_TI0"
[1] "Periods.3to3_TI0"
[1] "Periods.4to4_TI0"
[1] "Periods.5to5_TI0"
[1] "Periods.6to6_TI0"
[1] "Periods.7to7_TI0"
[1] "Periods.8to11_TI0"
[1] "Periods.12to15_TI0"
[1] "Periods.0to0_TI1"
[1] "Periods.1to1_TI1"
[1] "Periods.2to2_TI1"
[1] "Periods.3to3_TI1"
[1] "Periods.4to4_TI1"
[1] "Periods.5to5_TI1"
[1] "Periods.6to6_TI1"
[1] "Periods.7to7_TI1"
[1] "Periods.8to11_TI1"
[1] "Periods.12to15_TI1"
...fitting hazard MSM with speedglm::speedglm.wfit...
[1] "MSM fits"
  Periods.0to0_TI0   Periods.1to1_TI0   Periods.2to2_TI0   Periods.3to3_TI0 
     -5.465039e+00      -4.324378e+00      -4.012934e+00      -1.166619e+15 
  Periods.4to4_TI0   Periods.5to5_TI0   Periods.6to6_TI0   Periods.7to7_TI0 
     -6.871355e+14      -4.884654e+14      -6.732368e+00      -6.414551e+00 
 Periods.8to11_TI0 Periods.12to15_TI0   Periods.0to0_TI1   Periods.1to1_TI1 
     -2.490327e+15      -3.057464e+15      -3.089228e+00      -4.070768e+00 
  Periods.2to2_TI1   Periods.3to3_TI1   Periods.4to4_TI1   Periods.5to5_TI1 
     -4.097356e+00      -1.444049e+01      -3.626218e+00      -4.172158e+00 
  Periods.6to6_TI1   Periods.7to7_TI1  Periods.8to11_TI1 Periods.12to15_TI1 
     -5.928687e+00      -3.921940e+00      -4.645602e+00      -3.410729e+00 
...evaluating MSM-based survival curves...
...evaluating SEs based on MSM hazard fit and the estimated IC...
[1] "Should all be very small: "
  Periods.0to0_TI0   Periods.1to1_TI0   Periods.2to2_TI0   Periods.3to3_TI0 
      8.745296e-16       4.214695e-15       8.819608e-15       7.293270e+00 
  Periods.4to4_TI0   Periods.5to5_TI0   Periods.6to6_TI0   Periods.7to7_TI0 
      6.561300e+01       4.445403e+02       5.648100e-14       5.676302e-14 
 Periods.8to11_TI0 Periods.12to15_TI0   Periods.0to0_TI1   Periods.1to1_TI1 
      2.030033e+02       7.899748e+02       3.196367e-18       3.295818e-18 
  Periods.2to2_TI1   Periods.3to3_TI1   Periods.4to4_TI1   Periods.5to5_TI1 
      5.938153e-18       4.879654e-08       5.552308e-18       8.758887e-18 
  Periods.6to6_TI1   Periods.7to7_TI1  Periods.8to11_TI1 Periods.12to15_TI1 
      9.627973e-20       1.899923e-17       1.180759e-18       4.982015e-15 
[1] "Should all be very small: "
  Periods.0to0_TI0   Periods.1to1_TI0   Periods.2to2_TI0   Periods.3to3_TI0 
      8.645048e-14       4.643372e-14       2.150078e-14       3.336980e+14 
  Periods.4to4_TI0   Periods.5to5_TI0   Periods.6to6_TI0   Periods.7to7_TI0 
      7.563694e+14       1.183848e+15       9.715875e-15       1.095287e-14 
 Periods.8to11_TI0 Periods.12to15_TI0   Periods.0to0_TI1   Periods.1to1_TI1 
      1.830248e+14       5.408850e+14       2.038744e-15       4.102638e-15 
  Periods.2to2_TI1   Periods.3to3_TI1   Periods.4to4_TI1   Periods.5to5_TI1 
      5.644245e-15       1.000001e+00       1.646367e-15       3.270332e-15 
  Periods.6to6_TI1   Periods.7to7_TI1  Periods.8to11_TI1 Periods.12to15_TI1 
      1.486411e-16       2.648109e-15       3.026786e-17       8.738800e-15 
[1] "Should all be very small: "
 [1] 3.628268e-16 2.387874e-16 1.344854e-16 1.344854e-16 1.344854e-16
 [6] 1.344854e-16 1.449570e-16 1.619186e-16 1.619186e-16 1.619186e-16
[11] 1.619186e-16 1.619186e-16 1.619186e-16 1.619186e-16 1.619186e-16
[16] 1.619186e-16
[1] "Should all be very small: "
 [1] 8.519431e-17 1.505626e-17 1.044968e-16 4.951408e-07 4.823035e-07
 [6] 4.749798e-07 4.737188e-07 4.645200e-07 4.601013e-07 4.557247e-07
[11] 4.513896e-07 4.470959e-07 4.328058e-07 4.189726e-07 4.055814e-07
[16] 3.926183e-07
> survMSM_res$St
$TI0
 [1] 0.9957857 0.9827720 0.9653188 0.9653188 0.9653188 0.9653188 0.9641698
 [8] 0.9625935 0.9625935 0.9625935 0.9625935 0.9625935 0.9625935 0.9625935
[15] 0.9625935 0.9625935

$TI1
 [1] 0.9564462 0.9403990 0.9250282 0.9250277 0.9010449 0.8873627 0.8850068
 [8] 0.8678217 0.8595666 0.8513901 0.8432913 0.8352696 0.8085728 0.7827293
[15] 0.7577119 0.7334940

> 
> # ----------------------------------------------------------------------
> # Sequential G-COMP
> # ----------------------------------------------------------------------
> t.surv <- c(0:15)
> Qforms <- rep.int("Q.kplus1 ~ CVD + highA1c + N + lastNat1 + TI + TI.tminus1", (max(t.surv)+1))
> params = list(fit.package = "speedglm", fit.algorithm = "glm")
> 
> ## Not run: 
> ##D gcomp_est <- fitSeqGcomp(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D                           Qforms = Qforms, params_Q = params, stratifyQ_by_rule = FALSE)
> ##D gcomp_est[]
> ## End(Not run)
> # ----------------------------------------------------------------------
> # TMLE
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D tmle_est <- fitTMLE(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D                     Qforms = Qforms, params_Q = params, stratifyQ_by_rule = TRUE)
> ##D tmle_est[]
> ## End(Not run)
> 
> # ----------------------------------------------------------------------
> # Running IPW-Adjusted KM with optional user-specified weights:
> # ----------------------------------------------------------------------
> addedWts_DT <- OdataDT[, c("ID", "t"), with = FALSE]
> addedWts_DT[, new.wts := sample.int(10, nrow(OdataDT), replace = TRUE)/10]
> survNP_res_addedWts <- survNPMSM(wts.DT.1, OData, weights = addedWts_DT)
> 
> # ----------------------------------------------------------------------
> # Multivariate Propensity Score Regressions
> # ----------------------------------------------------------------------
> gform_CENS <- "C + TI + N ~ highA1c + lastNat1"
> OData <- fitPropensity(OData, gform_CENS = gform_CENS, gform_TRT = gform_TRT,
+                         gform_MONITOR = gform_MONITOR)
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "gC" "gA" "gN"
[1] "Outcomes: "
[1] ""
[1] "No. of regressions: 3"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "C,TI,N"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: C, TI, N"
[1] "Predictors: highA1c, lastNat1"
[1] "No. of regressions: 3"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(C|highA1c, lastNat1);\\ Stratify: "
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|C, highA1c, lastNat1);\\ Stratify: C == 0"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(N|C, TI, highA1c, lastNat1);\\ Stratify: C == 0 & TI == 0"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "TI"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: TI"
[1] "Predictors: CVD, highA1c, N.tminus1"
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "...ListOfRegressionForms..."
[1] "Outcomes: "
[1] "N"
[1] "No. of regressions: 1"
[1] "All outcomes binary? FALSE"
[1] "#----------------------------------------------------------------------------------"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of GenericModel:"
[1] "#----------------------------------------------------------------------------------"
[1] "Outcomes: N"
[1] "Predictors: "
[1] "No. of regressions: 1"
[1] "All outcomes binary? TRUE"
[1] "#----------------------------------------------------------------------------------"
[1] "New instance of BinaryOutcomeModel :"
[1] "P(N|);\\ Stratify: "
[1] "fitting the model: P(C|highA1c, lastNat1);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
    Intercept       highA1c      lastNat1 
-2.656607e+01  9.238692e-12  2.688942e-12 
[1] "fitting the model: P(TI|C, highA1c, lastNat1);\\ Stratify: C == 0"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
  Intercept           C     highA1c    lastNat1 
 0.87385792          NA -0.18986136 -0.06706656 
[1] "fitting the model: P(N|C, TI, highA1c, lastNat1);\\ Stratify: C == 0 & TI == 0"
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
   Intercept            C           TI      highA1c     lastNat1 
-0.025688525           NA           NA  0.001591313 -0.012014026 
[1] "fitting the model: P(TI|CVD, highA1c, N.tminus1);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
 Intercept        CVD    highA1c  N.tminus1 
 0.6250400  1.3852271 -0.1432429  0.1288901 
[1] "fitting the model: P(N|);\\ Stratify: "
[1] "calling speedglm.wfit..."
[1] "speedglm fits:"
  Intercept 
-0.01358231 
> 
> # ----------------------------------------------------------------------
> # Fitting Propensity scores with Random Forests:
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "randomForest")
> ##D require("h2o")
> ##D h2o::h2o.init(nthreads = -1)
> ##D gform_CENS <- "C ~ highA1c + lastNat1"
> ##D OData <- fitPropensity(OData, gform_CENS = gform_CENS,
> ##D                         gform_TRT = gform_TRT,
> ##D                         gform_MONITOR = gform_MONITOR,
> ##D                         stratify_CENS = stratify_CENS)
> ##D 
> ##D # For Gradient Boosting machines:
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "gbm")
> ##D # Use `H2O-3` distributed implementation of GLM
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "glm")
> ##D # Use Deep Neural Nets:
> ##D set_all_stremr_options(fit.package = "h2o", fit.algorithm = "deeplearning")
> ## End(Not run)
> 
> # ----------------------------------------------------------------------
> # Fitting different models with different algorithms
> # Fine tuning modeling with optional tuning parameters.
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D params_TRT = list(fit.package = "h2o", fit.algorithm = "gbm", ntrees = 50,
> ##D     learn_rate = 0.05, sample_rate = 0.8, col_sample_rate = 0.8,
> ##D     balance_classes = TRUE)
> ##D params_CENS = list(fit.package = "speedglm", fit.algorithm = "glm")
> ##D params_MONITOR = list(fit.package = "speedglm", fit.algorithm = "glm")
> ##D OData <- fitPropensity(OData,
> ##D             gform_CENS = gform_CENS, stratify_CENS = stratify_CENS, params_CENS = params_CENS,
> ##D             gform_TRT = gform_TRT, params_TRT = params_TRT,
> ##D             gform_MONITOR = gform_MONITOR, params_MONITOR = params_MONITOR)
> ## End(Not run)
> 
> # ----------------------------------------------------------------------
> # Running TMLE based on the previous fit of the propensity scores.
> # Also applying Random Forest to estimate the sequential outcome model
> # ----------------------------------------------------------------------
> ## Not run: 
> ##D t.surv <- c(0:5)
> ##D Qforms <- rep.int("Q.kplus1 ~ CVD + highA1c + N + lastNat1 + TI + TI.tminus1", (max(t.surv)+1))
> ##D params_Q = list(fit.package = "h2o", fit.algorithm = "randomForest",
> ##D                 ntrees = 100, learn_rate = 0.05, sample_rate = 0.8,
> ##D                 col_sample_rate = 0.8, balance_classes = TRUE)
> ##D tmle_est <- fitTMLE(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D             Qforms = Qforms, params_Q = params_Q,
> ##D             stratifyQ_by_rule = TRUE)
> ## End(Not run)
> 
> ## Not run: 
> ##D t.surv <- c(0:5)
> ##D Qforms <- rep.int("Q.kplus1 ~ CVD + highA1c + N + lastNat1 + TI + TI.tminus1", (max(t.surv)+1))
> ##D params_Q = list(fit.package = "h2o", fit.algorithm = "randomForest",
> ##D                 ntrees = 100, learn_rate = 0.05, sample_rate = 0.8,
> ##D                 col_sample_rate = 0.8, balance_classes = TRUE)
> ##D tmle_est <- fitTMLE(OData, t_periods = t.surv, intervened_TRT = "TI.set1",
> ##D             Qforms = Qforms, params_Q = params_Q,
> ##D             stratifyQ_by_rule = FALSE)
> ## End(Not run)
> 
> 
> 
> 
> ### * <FOOTER>
> ###
> options(digits = 7L)
> base::cat("Time elapsed: ", proc.time() - base::get("ptime", pos = 'CheckExEnv'),"\n")
Time elapsed:  166.656 2.852 168.303 0 0.004 
> grDevices::dev.off()
null device 
          1 
> ###
> ### Local variables: ***
> ### mode: outline-minor ***
> ### outline-regexp: "\\(> \\)?### [*]+" ***
> ### End: ***
> quit('no')
